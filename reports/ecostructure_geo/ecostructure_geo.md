Ecostructure Global Geographic Motifs, v2
================
Joel Nitta
05 October, 2019

``` r
# Load packages
library(here)
library(scales)
library(ecostructure)
library(assertr)
library(raster)
library(drake)
library(patchwork)
library(tidyverse)

# Load cache
ja_fern_cache <- new_cache(here::here("ja_fern_cache"))

# Load functions
source(here::here("code/functions.R"))

# Resolve conflicts
source(here::here("code/resolve_conflicts.R"))
```

## Geographic motifs

Geographic motifs are the clusters generated by analyzing dispersion
fields, i.e., the global richness for all species present in a given
site.

Settings used for `ecos_fit()` were `tol` = 0.1, `K` from 2 to 10, and
`num_trials` = 1.

Read in the results, check their dimensions, and have a quick peak at
the data:

``` r
# Load ecostructure results
results_vector <- glue::glue(here("results/ecosfit_motif=geo_dataset=pteridos-no-obs_K={2:10}_tol=0.1_trials=1.RDS"))

results_list <- purrr::map(results_vector, readRDS)

dim(results_list[[1]][["theta"]])
```

    ## [1] 7811    2

``` r
dim(results_list[[1]][["omega"]])
```

    ## [1] 4338    2

``` r
head(results_list[[1]][["theta"]])
```

    ##             topic
    ## phrase                  1            2
    ##   -75.5_83.5 3.429595e-06 6.115784e-12
    ##   -75.5_82.5 4.812495e-06 6.226092e-12
    ##   -69.5_82.5 6.084795e-07 5.803691e-12
    ##   -63.5_82.5 1.327906e-04 2.966242e-05
    ##   -62.5_82.5 1.327906e-04 2.966242e-05
    ##   -30.5_82.5 1.317601e-04 3.035151e-05

``` r
head(results_list[[1]][["omega"]])
```

    ##                   topic
    ## document                   1         2
    ##   130.5625_30.2916 0.1381362 0.8618638
    ##   130.4375_30.375  0.1588868 0.8411132
    ##   130.5625_30.375  0.2701351 0.7298649
    ##   130.9375_31.875  0.3023002 0.6976998
    ##   130.8125_31.9583 0.3106027 0.6893973
    ##   131.0625_32.2916 0.4426298 0.5573702

``` r
# Load all_cells to get max and min lat/longs
loadd(all_cells, cache = ja_fern_cache)

# Read in high-resolution map of Japan, convert to sf
japan <- rnaturalearth::ne_countries(country = 'japan', scale = 'large') %>% sf::st_as_sf()
```

Theta is the contribution of each dispersion field to each of the
clusters. Omega is the degree of membership to each of the clusters for
each grid cell. The reason the omega and theta matrices have the same
dimensions is that I dropped all cells with zero species from the
dispersion fields prior to analysis.

## Omega plots

``` r
# For easy tweaking of plot size to get pie charts
# to not overlap.
tweak <- 1.0

# Loop through results and output pie plots
for (i in 1:length(results_list)) {
  ecos_plot_pie2(
    omega = results_list[[i]][["omega"]],
    image_width = 6000*tweak,
    image_height = 4800*tweak,
    radius = 0.05,
    bgmap_path = japan,
    long_lim = c(pull(all_cells, longitude) %>% min %>% floor, 
                 pull(all_cells, longitude) %>% max %>% ceiling),
    lat_lim =  c(pull(all_cells, latitude) %>% min %>% floor, 
                 pull(all_cells, latitude) %>% max %>% ceiling),
    path = glue::glue(here("reports/ecostructure_geo/geo_omega_k={i+1}.png"))
  )
}
```

K = 2

![](geo_omega_k=2.png)

K = 3

![](geo_omega_k=3.png)

K = 4

![](geo_omega_k=4.png)

K = 5

![](geo_omega_k=5.png)

K = 6

![](geo_omega_k=6.png)

K = 7

![](geo_omega_k=7.png)

K = 8

![](geo_omega_k=8.png)

K = 9

![](geo_omega_k=9.png)

K = 10

![](geo_omega_k=10.png)

## Theta plots

``` r
# Function to make single theta plot
make_geo_theta_plot <- function (geo_theta_long, motif) {
  ggplot(ggplot2::map_data("world"), aes(x = long, y = lat)) +
  geom_polygon(aes(group = group), fill = "light grey") +
  geom_raster(data = geo_theta_long, aes(fill = theta)) +
  scale_fill_gradient(low = "darkseagreen3", high = "red") +
  coord_sf(ylim = c(-50, 90), datum = NA) +
  labs(subtitle = motif) +
  jntools::blank_x_theme() +
  jntools::blank_y_theme() +
  theme_void() +
  theme(
    legend.position = "none",
    plot.background = element_rect(fill = "transparent"),
    panel.background = element_rect(fill = "transparent")
  )
}

make_geo_theta_plot_ja <- function (geo_theta_long, motif, occ_data) {
  ggplot(ggplot2::map_data("world"), aes(x = long, y = lat)) +
  geom_polygon(aes(group = group), fill = "light grey") +
  geom_raster(data = geo_theta_long, aes(fill = theta)) +
  scale_fill_gradient(low = "darkseagreen3", high = "red") +
  coord_quickmap(
      xlim = c(pull(occ_data, longitude) %>% min %>% floor, 
               pull(occ_data, longitude) %>% max %>% ceiling),
      ylim = c(pull(occ_data, latitude) %>% min %>% floor, 
               pull(occ_data, latitude) %>% max %>% ceiling)
    ) +
  labs(subtitle = motif) +
  jntools::blank_x_theme() +
  jntools::blank_y_theme() +
  theme_void() +
  theme(
    legend.position = "none",
    plot.background = element_rect(fill = "transparent"),
    panel.background = element_rect(fill = "transparent")
  )
}

# Convert data to long format, nested. Set K = 6
k_select = 6

# Global
geo_theta_nested <- results_list[[k_select - 1]][["theta"]] %>%
  as.data.frame %>%
  rownames_to_column("long_lat") %>%
  as_tibble %>%
  separate(long_lat, c("long", "lat"), sep = "_") %>%
  gather(motif, theta, -long, -lat) %>%
  mutate_at(vars(long, lat), as.numeric) %>%
# Check that longitude is between -180 and 180,
# that latitude is between -90 and 90, and that
# each long-lat-motif combination is unique
  verify(long > -180 & long < 180 & lat > -90 & lat < 90) %>%
  assert(is_uniq(c(.$long, .$lat, .$motif))) %>%
  group_by(motif) %>%
  nest

# Map over each theta plot separately so they each get their own
# scale.
# - Global plots
geo_theta_plot_list <- map2(geo_theta_nested$data, geo_theta_nested$motif, make_geo_theta_plot)

# - Japan-focused plots
geo_theta_plot_list_js <- 
  list(
    geo_theta_long = geo_theta_nested$data,
    motif = geo_theta_nested$motif,
    occ_data = list(all_cells)
  ) %>%
  pmap(make_geo_theta_plot_ja)

# Combine into final plot and save
geo_theta_plot <- patchwork::wrap_plots(geo_theta_plot_list, ncol = 2)

ggsave(plot = geo_theta_plot, filename = here(glue::glue("reports/ecostructure_geo/geo_theta_k={k_select}.png")), width = 12.5, height = 8, units = "in")
```

![](geo_theta_k=6.png)

## Combined plots

``` r
# For easy tweaking of plot size to get pie charts
# to not overlap.
tweak <- 1.5

make_geo_theta_plot_color <- function (geo_theta_long, border_color) {
  ggplot(ggplot2::map_data("world"), aes(x = long, y = lat)) +
  geom_polygon(aes(group = group), fill = "light grey") +
  geom_raster(data = geo_theta_long, aes(fill = theta)) +
  scale_fill_gradient(low = "darkseagreen3", high = "red") +
  coord_sf(ylim = c(-50, 90), datum = NA) +
  jntools::blank_x_theme() +
  jntools::blank_y_theme() +
  theme_void() +
  theme(
    legend.position = "none",
    plot.background = element_rect(fill = "transparent"),
    panel.background = element_rect(fill = "transparent"),
    panel.border = element_rect(colour = border_color, fill=NA, size=2)
  )
}

k_select <- 3

cols <- RColorBrewer::brewer.pal(k_select, name = "Dark2")

ecos_plot_pie2(
    omega = results_list[[k_select - 1]][["omega"]],
    image_width = 6000*tweak,
    image_height = 4800*tweak,
    radius = 0.04,
    color = cols,
    bgmap_path = japan,
    long_lim = c(pull(all_cells, longitude) %>% min %>% floor, 
                 pull(all_cells, longitude) %>% max %>% ceiling),
    lat_lim =  c(pull(all_cells, latitude) %>% min %>% floor, 
                 pull(all_cells, latitude) %>% max %>% ceiling),
    path = glue::glue(here("reports/ecostructure_geo/geo_omega_combined_k={k_select}.png"))
  )

geo_theta_nested <- results_list[[k_select - 1]][["theta"]] %>%
  as.data.frame %>%
  rownames_to_column("long_lat") %>%
  as_tibble %>%
  separate(long_lat, c("long", "lat"), sep = "_") %>%
  gather(motif, theta, -long, -lat) %>%
  mutate_at(vars(long, lat), as.numeric) %>%
# Check that longitude is between -180 and 180,
# that latitude is between -90 and 90, and that
# each long-lat-motif combination is unique
  verify(long > -180 & long < 180 & lat > -90 & lat < 90) %>%
  assert(is_uniq(c(.$long, .$lat, .$motif))) %>%
  group_by(motif) %>%
  nest

geo_theta_plot_list_colors <- 
  list(
    geo_theta_long = geo_theta_nested$data,
    border_color = cols
  ) %>%
  pmap(make_geo_theta_plot_color)

# Combine into final plot and save
geo_theta_plot_colors <- patchwork::wrap_plots(geo_theta_plot_list_colors, ncol = 1)

ggsave(plot = geo_theta_plot_colors, filename = here(glue::glue("reports/ecostructure_geo/geo_theta_colors_k={k_select}.png")), width = 7, height = 8, units = "in")
```

    ## Warning in f(...): Raster pixels are placed at uneven horizontal intervals
    ## and will be shifted. Consider using geom_tile() instead.

    ## Warning in f(...): Raster pixels are placed at uneven vertical intervals
    ## and will be shifted. Consider using geom_tile() instead.

    ## Warning in f(...): Raster pixels are placed at uneven horizontal intervals
    ## and will be shifted. Consider using geom_tile() instead.

    ## Warning in f(...): Raster pixels are placed at uneven vertical intervals
    ## and will be shifted. Consider using geom_tile() instead.

    ## Warning in f(...): Raster pixels are placed at uneven horizontal intervals
    ## and will be shifted. Consider using geom_tile() instead.

    ## Warning in f(...): Raster pixels are placed at uneven vertical intervals
    ## and will be shifted. Consider using geom_tile() instead.
