---
title: "Biodiversity of Japanese Pteridophytes"
author: "Joel Nitta"
date: "6/28/2019"
output: 
  bookdown::html_document2:
    fig_caption: yes
    number_sections: no
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, results = "hide")
```

```{r load-data}
loadd(world_map)
loadd(occ_data_pteridos)
loadd(occ_data_ferns_north)
loadd(occ_data_ferns)
loadd(alpha_div_pteridos)
loadd(alpha_div_ferns_north)
loadd(alpha_div_ferns_north_south)
loadd(percent_sex_dip_ferns)
loadd(ses_pd_vs_repro_ferns)
```

### Richness

Richness of pteridophytes in Japan roughly follows the latitudinal species gradient, with more species in the south (Fig. \@ref(fig:richness-pteridos)).

```{r pd-by-rich-summary}
# Run exponential model of raw PD vs. richness across all pteridophytes and
# extract R2 and pvalue for mentioning in text.

# Two ways to fit the model:
# GLM
pd_by_rich_glm_mod <- glm(pd_obs + 0.0001 ~ richness, data=alpha_div_pteridos, family=Gamma(link="log"))
summary(pd_by_rich_glm_mod)

# Linear model after log transform. This one gives us an R-squared.
pd_by_rich_lm_mod <- lm(-log(pd_obs + 0.0001) ~ richness, data = alpha_div_pteridos)

# Extract R-squared.
pd_by_rich_r2 <- pd_by_rich_lm_mod %>% glance %>% pull(r.squared) %>% round(3)

# P is very very small, effectively 0
pd_by_rich_lm_mod %>% glance
```

```{r ses_pd-by-rich-summary}
# Run linear model of ses PD vs. richness across all pteridophytes and
# extract R2 and pvalue for mentioning in text.
ses_pd_rich_mod <- lm(ses_pd ~ richness, data = alpha_div_pteridos)

# Extract R-squared.
ses_pd_by_rich_r2 <- ses_pd_rich_mod %>% glance %>% pull(r.squared) %>% round(3)

# P is very very small
ses_pd_rich_mod %>% glance
```

### Phylogenetic diversity (PD) calculations

Phylogenetic diversity (PD) is the total phylogenetic branch length of all species in a community  (a "community" is defined here as co-occurring taxa within a 1 km^2^ grid cell). Observed PD is highly correlated with species richness (Fig. \@ref(fig:compare-obs-pd-richness), exponential model; *R*^2^ = `r pd_by_rich_r2`, *P* << 0.05), as has been demonstrated in many other studies, and by itself is not very informative.

To determine whether communities are significantly phylogenetically overdispersed (i.e., diverse) or clustered (i.e., depauperate), we compared observed PD to a null distribution of 999 randomly generated PD values for each community. Null values were generated by randomizing the names on the tips of the tree, and calculating PD with the randomized tree. The standard effect size (SES) of PD was then calculated by comparing observed PD to the null distribution using the following equation:

$PD_{SES} = \frac{(PD_{obs} - mean_{null})}{SD_{null}}$

Thus, large positive values of SES of PD indicate phylogenetic overdispersion, and large negative values indicate phylogenetic clustering. Values near 0 are not significantly different from the null distribution. Significance was assesed using a two-tailed test: observed PD values at the 0.025% lower or upper extremes of the null distribution were considered significant.

### SES of PD: all pteridophytes

SES of PD shows a much weaker correlation with species richness than observed PD (Fig. \@ref(fig:compare-ses-pd-richness), linear model; *R*^2^ = `r ses_pd_by_rich_r2`, *P* << 0.05). Likewise, spatial distribution of SES of PD differs strongly from species richness (Fig. \@ref(fig:pd-pteridos)). Mountainous areas on the main island of Japan tend to be clustered (blue), and smaller islands in the south (especially the Okinawan islands) and areas on the coast tend to be overdispersed (red).

However, SES of PD values for pteridophytes tend to skew towards clustering overall (median `r median(alpha_div_pteridos$ses_pd, na.rm = TRUE) %>% round(2)`, Fig. \@ref(fig:pd-pteridos-hist)). This could be due to the fact that a large number of primarily tropical fern lineages only occur in the far-southern islands of Japan: `r setdiff(occ_data_ferns$genus, occ_data_ferns_north$genus) %>% length` genera and `r setdiff(occ_data_ferns$family, occ_data_ferns_north$family) %>% length` families (`r setdiff(occ_data_ferns$family, occ_data_ferns_north$family) %>% paste(collapse = ", ")`) do not occur north of 30.1 degrees latitude. 

When these lineages are included in the randomization procedure to calculate SES of PD, they likely contribute long branches that bias the northern communities towards clustering. Lycophytes, which occur on long branches, may have a similar effect. Therefore, we also calculated SES of PD separately for ferns  north and south of 30.1 degrees latitude (corresponding to the Tokara strait).

```{r pd-by-el-summary}
# Run linear model of SES of PD vs. elevation in northern ferns dataset
pd_by_el_mod<- lm(ses_pd ~ elevation, alpha_div_ferns_north_south)

# Extract R2 and pvalue for mentioning in text.
pd_by_el_r2 <- pd_by_el_mod %>% glance %>% pull(r.squared) %>% round(3)

# P is very very small
pd_by_el_mod %>% glance
```

### SES of PD: ferns only, calculated separately in N and S

Standard effect size of PD is less skewed in the ferns dataset when N and S regions are calculated separately (median `r median(alpha_div_ferns_north_south$ses_pd, na.rm = TRUE) %>% round(2)`, Fig. \@ref(fig:pd-ferns-north-hist)). A similar overall pattern is observed in the spatial distribution of SES of PD for all pteridophytes, but the number of clustered cells is fewer (Fig. \@ref(fig:pd-ferns-ns)). 

Significantly clustered areas include Aomori prefecture near Misawa, Yamaguchi prefecture, and many other mountainous areas; significantly overdispersed areas include the southern tip of Kyushu, Wakayama prefecture near Tanabe, and the Ogasawara islands (Fig. \@ref(fig:pd-ferns-ns-highlight)). Standard effect size of PD decreases significantly with elevation (Fig. \@ref(fig:pd-ferns-ns-el), linear model; *R*^2^ = `r pd_by_el_r2`, *P* << 0.05).

### Breeding system

```{r ses-pd-vs-perc-sex-dip-summary}
# Run linear model of SES of PD vs. percentage of sexual diploid ferns
ses_pd_vs_repro_ferns_mod <- lm(ses_pd ~ percent_sex_dip, ses_pd_vs_repro_ferns)

# Extract R2 and pvalue for mentioning in text.
ses_pd_vs_repro_ferns_r2 <- ses_pd_vs_repro_ferns_mod %>% glance %>% pull(r.squared) %>% round(3)

# P is very very small
ses_pd_vs_repro_ferns_mod %>% glance
```

Sexual diploid taxa tend to be distributed in northern latitudes (Fig. \@ref(fig:sex-dip-ferns-map)).

Somewhat surprisingly, SES of PD shows a negative relationship with the percentage of sexual diploid taxa (Fig. \@ref(fig:ses-pd-vs-perc-sex-dip); *R*^2^ = `r ses_pd_vs_repro_ferns_r2`, *P* << 0.05). We expected that since many apogamous (non-sexual) taxa have identical or very similar DNA sequences to their sexual relatives that communities with more apogamous taxa would be more clustered and communities with more sexual diploids would be overdispersed. It seems that communities with many non-sexual taxa actually tend to include distantly related taxa rather than sister pairs of sexual and non-sexual species.

## Figures

```{r richness-pteridos, fig.cap = "Richness of native Japanese pteridophyte taxa."}
make_diversity_map(
    div_data = alpha_div_pteridos, 
    world_map = world_map, 
    occ_data = occ_data_pteridos, 
    div_metric = "richness", 
    metric_title = "Richness"
  ) + scale_fill_scico(palette = "bilbao", na.value="white")
```

```{r compare-obs-pd-richness, fig.cap = "Correlation between observed phylogenetic diversity (PD) and species richness, for all native Japanese pteridophyte taxa excluding hybrids. Blue trendline shows significant exponential model fit with confidence interval in pink."}
# Shift pd_obs up by an arbitrarily small amount so the exponential curve can be fit.

ggplot(alpha_div_pteridos, aes(richness, pd_obs + 0.0001)) +
  geom_point(alpha = 0.2) +
  geom_smooth(
    formula = -log(pd_obs + 0.0001) ~ richness,
    size = 0.5,
    fill = "pink") +
  annotate("text", 
           x = 0, y = Inf, 
           label = glue::glue("italic(R) ^ 2 == {pd_by_rich_r2}"),
           parse = TRUE,
           hjust = 0,
           vjust = 1.2) +
  labs(
    y = "Observed PD",
    x = "Richness"
  ) +
  jntools::standard_theme()

```

```{r compare-ses-pd-richness, fig.cap = "Correlation between standard effect size (SES) of phylogenetic diversity (PD) vs. species richness, for all native Japanese pteridophyte taxa excluding hybrids. Blue trendline shows significant linear model fit with confidence interval in pink."}
ggplot(alpha_div_pteridos, aes(richness, ses_pd)) +
  geom_point(alpha = 0.2) +
  geom_smooth(
    size = 0.5,
    fill = "pink",
    method = "lm") +
  annotate("text", 
           x = 0, y = Inf, 
           label = glue::glue("italic(R) ^ 2 == {ses_pd_by_rich_r2}"),
           parse = TRUE,
           hjust = 0,
           vjust = 1.2) +
  jntools::standard_theme() +
  labs(
    y = "SES of PD",
    x = "Richness"
  )
```

```{r pd-pteridos, fig.cap = "Standard effect size (SES) of phylogenetic diversity (PD) of native Japanese pteridophyte taxa, excluding hybrids."}
make_diversity_map(
    div_data = alpha_div_pteridos, 
    world_map = world_map, 
    occ_data = occ_data_pteridos, 
    div_metric = "ses_pd", 
    metric_title = "PD"
  ) + scale_fill_scico(
    palette = "vik", 
    na.value="white",
    limits = c(
      -get_limit(alpha_div_pteridos, ses_pd, "abs", 3), 
      get_limit(alpha_div_pteridos, ses_pd, "abs", 3)
    ))
```

```{r pd-pteridos-hist, fig.cap = "Histogram of standard effect size (SES) of phylogenetic diversity (PD) values of native Japanese pteridophyte taxa, excluding hybrids. Red line shows median."}
ggplot(alpha_div_pteridos, aes(ses_pd)) +
  geom_histogram() +
  geom_vline(xintercept = median(alpha_div_pteridos$ses_pd, na.rm = TRUE), color = "red") +
  labs(x = "SES of PD") +
  scale_x_continuous(
    limits = c(
      -get_limit(alpha_div_pteridos, ses_pd, "abs", 3), 
      get_limit(alpha_div_pteridos, ses_pd, "abs", 3)
    )
  )
```

```{r pd-ferns-north-hist, fig.cap = "Histogram of standard effect size (SES) of phylogenetic diversity (PD) values of native Japanese fern taxa calculated separately north and south of 30.1 degrees latitude, excluding hybrids. Red line shows median."}
ggplot(alpha_div_ferns_north_south, aes(ses_pd)) +
  geom_histogram() +
  geom_vline(xintercept = median(alpha_div_ferns_north$ses_pd, na.rm = TRUE), color = "red") +
  labs(x = "SES of PD") +
  scale_x_continuous(
    limits = c(
      -get_limit(alpha_div_ferns_north_south, ses_pd, "abs", 3), 
      get_limit(alpha_div_ferns_north_south, ses_pd, "abs", 3)
    )
  )
```

```{r pd-ferns-ns, fig.cap = "Standard effect size (SES) of phylogenetic diversity (PD) of native Japanese fern taxa north of 30.1 degrees latitude, excluding hybrids."}
make_diversity_map(
    div_data = alpha_div_ferns_north_south, 
    world_map = world_map, 
    occ_data = occ_data_ferns, 
    div_metric = "ses_pd", 
    metric_title = "SES of PD"
  ) + scale_fill_scico(
    palette = "vik", 
    na.value="white",
    limits = c(
      -get_limit(alpha_div_ferns_north_south, ses_pd, "abs", 3), 
      get_limit(alpha_div_ferns_north_south, ses_pd, "abs", 3)
    ))
```

```{r pd-ferns-ns-highlight, fig.cap = "Standard effect size (SES) of phylogenetic diversity (PD) of native Japanese fern taxa calculated separately north and south of 30.1 degrees latitude, excluding hybrids. Only showing cells that are significantly overdispersed (red) or clustered (blue)."}
make_pd_highlight_map(
    div_data = alpha_div_ferns_north_south, 
    world_map = world_map, 
    occ_data = occ_data_ferns
  ) + scale_fill_scico(
    palette = "vik", 
    na.value="white",
    limits = c(
      -get_limit(alpha_div_ferns_north, ses_pd, "abs", 3), 
      get_limit(alpha_div_ferns_north, ses_pd, "abs", 3)
    ))
```

```{r pd-ferns-ns-el, fig.cap = "Relationship between standard effect size (SES) of phylogenetic diversity (PD) of native Japanese fern taxa calculated separately north and south of 30.1 degrees latitude, excluding hybrids, and elevation (m). Blue trendline shows significant linear model fit with confidence interval in pink."}

lm(ses_pd ~ elevation, alpha_div_ferns_north_south) %>% augment %>%
  ggplot(aes(x = elevation)) +
  geom_point(aes(y = ses_pd), alpha = 0.2) +
  geom_ribbon(aes(ymin=.fitted-1.96*.se.fit, ymax=.fitted+1.96*.se.fit), alpha = 0.4, fill = "pink") +
  geom_line(aes(y = .fitted), color = "blue") +
  annotate("text", 
           x = Inf, y = Inf, 
           label = glue::glue("italic(R) ^ 2 == {pd_by_el_r2}"),
           parse = TRUE,
           hjust = 1.2,
           vjust = 1.2) +
  jntools::standard_theme() +
  labs(
    y = "SES of PD",
    x = "Elevation (m)"
  )

```

```{r sex-dip-ferns-map, fig.cap = "Percentage of sexual diploid fern taxa, excluding hybrids."}
make_diversity_map(
  div_data = percent_sex_dip_ferns, 
  world_map = world_map, 
  occ_data = occ_data_ferns, 
  div_metric = "percent_sex_dip",
  metric_title = "% sex. diploid"
) + scale_fill_scico(palette = "bilbao", na.value="white")
```

```{r ses-pd-vs-perc-sex-dip, fig.cap = "Correlation between percentage of sexual diploid fern taxa (excluding hybrids) and standard effect size (SES) of phylogenetic diversity (PD)."}
ggplot(ses_pd_vs_repro_ferns, aes(percent_sex_dip, ses_pd)) +
  geom_point(alpha = 0.4) +
  geom_smooth(
    method = "lm",
    size = 0.5,
    fill = "pink"
  ) +
  annotate("text", 
           x = Inf, y = Inf, 
           label = glue::glue("italic(R) ^ 2 == {ses_pd_vs_repro_ferns_r2}"),
           parse = TRUE,
           hjust = 1.2,
           vjust = 1.2) +
  labs(
    x = "% sexual diploid taxa",
    y = "SES PD"
  ) +
  jntools::standard_theme()
```

