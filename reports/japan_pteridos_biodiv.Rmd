---
title: "Biodiversity of Japanese Pteridophytes"
author: "Joel Nitta, Atushi Ebihara"
bibliography: "references.bib"
output: 
  bookdown::html_document2:
    fig_caption: yes
    number_sections: no
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, results = "hide")
```

```{r load-data}
loadd(list = c("world_map",
  "occ_data_pteridos",
  "occ_data_ferns_north",
  "occ_data_ferns",
  "alpha_div_pteridos",
  "alpha_div_ferns",
  "alpha_div_ferns_ns",
  "alpha_div_vs_repro_ferns"), 
  cache = ja_fern_cache)
```

## Methods

### Phylogenetic diversity

We measured phylogenetic diversity using mean phylogenetic distance (MPD), the mean distance between all co-occurring taxa in a community, and mean nearest taxon distance (MNTD), the mean distance between co-occurring sister taxa in a community [@Webb2000; @Webb2002]. A "community" is defined here as co-occurring taxa within a 1 km^2^ grid cell. Since observed values of MPD and MNTD are known to correlate with species richness, we determined whether communities are phylogenetically overdispersed (i.e., diverse) or clustered (i.e., depauperate), by calculating the standard effect size (SES) of MPD and MNTD. We compared observed values to those of a null distribution of 999 random communities with the `ses.pd` function in the `picante` R package [@Kembel2010]. Random communities were each generated using 10,000 iterations of the "independent swap" algorithm of @Gotelli2000, which conserves richness per site and species occurrence frequencies while randomizing species identities. Positive values of SES of MPD and MNTD (hereafter referred to simply as "MPD" or "MTND" respectively unless indicated otherwise) indicate phylogenetic overdispersion, and negative values indicate phylogenetic clustering. Values at the 2.5% lower or upper extremes of the null distribution were considered statistically significant.

### Datasets

A large number of primarily tropical fern lineages only occur in the far-southern islands of Japan: `r setdiff(occ_data_ferns$genus, occ_data_ferns_north$genus) %>% length` genera and `r setdiff(occ_data_ferns$family, occ_data_ferns_north$family) %>% length` families (`r setdiff(occ_data_ferns$family, occ_data_ferns_north$family) %>% paste(collapse = ", ")`) do not occur north of 30.1 degrees latitude. 

When these lineages are included in the randomization procedure to calculate SES of MPD and MNTD, they likely contribute long branches that bias the northern communities towards clustering. Lycophytes, which occur on long branches, may have a similar effect. Therefore, we calculated phylogenetic diversity for three datasets: pteridophytes (ferns and lycophytes), ferns, and ferns separately north and south of 30.1 degrees latitude (corresponding to the Tokara strait, hereafter referred to as "ferns_ns").

## Results

### Richness

Richness of pteridophytes in Japan roughly follows the latitudinal species gradient, with more species in the south (Fig. \@ref(fig:richness-pteridos)).

### Phylogenetic diversity

Standard effect sizes of mean phylogenetic diversity (MPD) and mean nearest taxon distance (MNTD) were either not correlated or only very weakly correlated with species richness (SI Fig. \@ref(fig:compare-pd-richness)), indicating that our null models successfully decoupled measures of phylogenetic diversity and richness. The distribution of MPD and MNTD values were very similar across datasets (SI Fig. \@ref(fig:alpha-div-ridge)).

Values of MPD are clustered in mountainous areas and overdispersed along the coasts of the main islands of Japan, with similar patterns between pteridophytes and ferns (Fig. \@ref(fig:mpd)a, b). The pattern is similar in the "ferns_NS" dataset, except that the strength of both clustering and overdispersion is weaker in the main islands of Japan, and the pattern of overdispresion on the islands of Amami-oshima in sourthern Japan reverses to clustering (Fig. \@ref(fig:mpd)c).

The signal of clustering is much stronger when measured with MNTD, especially in mountainous areas of central Honshu (Fig. \@ref(fig:mntd)). Patterns are similar between all three datasets except that MNTD values are smaller in the "ferns_NS" dataset (Fig. \@ref(fig:mntd)c).

Values of MPD and MNTD decrease significantly with elevation across all datasets (Fig. \@ref(fig:compare-pd-el), linear model).

### Breeding system

Sexual diploid taxa tend to be distributed in northern latitudes (Fig. \@ref(fig:sex-dip-ferns-map)).

Somewhat surprisingly, MPD and MNTD show a weak negative relationship with the percentage of sexual diploid taxa (Fig. \@ref(fig:compare-pd-sexdip); linear model). We expected that since many apogamous (non-sexual) taxa have identical or very similar DNA sequences to their sexual relatives that communities with more apogamous taxa would be more clustered and communities with more sexual diploids would be overdispersed. It seems that communities with many non-sexual taxa actually tend to include distantly related taxa rather than sister pairs of sexual and non-sexual species.

## Figures

```{r richness-pteridos, fig.cap = "Richness of native Japanese pteridophyte taxa."}
make_diversity_map(
    div_data = alpha_div_pteridos, 
    world_map = world_map, 
    occ_data = occ_data_pteridos, 
    div_metric = "richness", 
    metric_title = "Richness"
  ) + scale_fill_scico(palette = "bilbao", na.value="white")
```

```{r compare-pd-richness, fig.cap = "Correlation between phylogenetic diversity and richness. Phylogenetic diversity measured as standard effect size (SES) of mean phylogenetic diversity (MPD) or mean nearest taxon distance (MNTD) in native pteridophytes, ferns, or ferns calculated separately north and south of 30.1 latitude of Japan. Blue trendline shows significant linear model fit (*P* < 0.05) with 96% confidence interval in pink."}
a <- make_scatter_with_lm(alpha_div_pteridos, "richness", "mpd_obs_z", "Richness", "MPD") +
  labs(title = "Pteridophytes", x = "")
b <- make_scatter_with_lm(alpha_div_ferns, "richness", "mpd_obs_z", "Richness", "MPD") +
  labs(title = "Ferns", y = "", x = "")
c <- make_scatter_with_lm(alpha_div_ferns_ns, "richness", "mpd_obs_z", "Richness", "MPD") +
  labs(title = "Ferns (NS separate)", y = "", x = "")
d <- make_scatter_with_lm(alpha_div_pteridos, "richness", "mntd_obs_z", "Richness", "MNTD")
e <- make_scatter_with_lm(alpha_div_ferns, "richness", "mntd_obs_z", "Richness", "MNTD") +
  labs(y = "")
f <- make_scatter_with_lm(alpha_div_ferns_ns, "richness", "mntd_obs_z", "Richness", "MNTD") +
  labs(y = "")
a + b + c + d + e + f + plot_layout(ncol = 3, nrow = 2)
```

```{r alpha-div-ridge, fig.cap = "Ridge plots showing distribution of the standard effect size of a) mean phylogenetic distance (MPD) and b) mean nearest taxon distance (MNTD) for three datasets: pteridophytes (ferns and lycophytes), ferns, and ferns when the data were split into northern and southern portions and calculated separately. Black vertical lines shows median."}
# Combine mpd and mntd calculations from the three datasets for comparison
comp_data <- 
  bind_rows(
  transmute(alpha_div_pteridos, dataset = "pteridos", mpd_obs_z, mntd_obs_z),
  transmute(alpha_div_ferns, dataset = "ferns", mpd_obs_z, mntd_obs_z),
  transmute(alpha_div_ferns_ns, dataset = "ferns_ns", mpd_obs_z, mntd_obs_z)
  )

# MPD
a <- ggplot(comp_data, aes(x = mpd_obs_z, y = dataset, fill = dataset)) + geom_density_ridges(
  scale = 1,
  quantile_lines = TRUE, quantiles = 2)  +
  labs(
    x = "MPD",
    y = "Dataset"
  ) +
  jntools::standard_theme() +
  theme(legend.position = "none")

# MNTD
b <- ggplot(comp_data, aes(x = mntd_obs_z, y = dataset, fill = dataset)) + geom_density_ridges(
  scale = 1,
  quantile_lines = TRUE, quantiles = 2) +
  theme(legend.position = "none") +
   labs(
    x = "MNTD",
    y = "Dataset"
  ) +
  jntools::standard_theme() +
  theme(legend.position = "none")

# final plot
a + b + plot_layout(ncol = 1) + plot_annotation(tag_levels = "a")

```

```{r mpd, fig.cap = "Standard effect size (SES) of mean phylogenetic distance (MPD) of native Japanese pteridophytes (ferns and lycophytes), excluding hybrids: a) pteridophytes, b) ferns, c) ferns analyzed separately north and south of 30.1 degrees latitude."}
a <- make_diversity_map(
    div_data = alpha_div_pteridos, 
    world_map = world_map, 
    occ_data = occ_data_pteridos, 
    div_metric = "mpd_obs_z", 
    metric_title = "MPD"
  ) + scale_fill_scico(
    palette = "vik", 
    na.value="white",
    limits = c(
      -get_limit(alpha_div_pteridos, mpd_obs_z, "abs", 3), 
      get_limit(alpha_div_pteridos, mpd_obs_z, "abs", 3)
    )) +
  theme(legend.position = "bottom")

b <- make_diversity_map(
    div_data = alpha_div_ferns, 
    world_map = world_map, 
    occ_data = occ_data_ferns, 
    div_metric = "mpd_obs_z", 
    metric_title = "MPD"
  ) + scale_fill_scico(
    palette = "vik", 
    na.value="white",
    limits = c(
      -get_limit(alpha_div_ferns, mpd_obs_z, "abs", 3), 
      get_limit(alpha_div_ferns, mpd_obs_z, "abs", 3)
    )) +
  theme(legend.position = "bottom")

c <- make_diversity_map(
    div_data = alpha_div_ferns_ns, 
    world_map = world_map, 
    occ_data = occ_data_ferns, 
    div_metric = "mpd_obs_z", 
    metric_title = "MPD"
  ) + scale_fill_scico(
    palette = "vik", 
    na.value="white",
    limits = c(
      -get_limit(alpha_div_ferns_ns, mpd_obs_z, "abs", 3), 
      get_limit(alpha_div_ferns_ns, mpd_obs_z, "abs", 3)
    )) +
  theme(legend.position = "bottom")

a + b + c + plot_layout(nrow = 1) + plot_annotation(tag_levels = "a")
```

```{r mntd, fig.cap = "Standard effect size (SES) of mean nearest taxon distance (MNTD) of native Japanese pteridophytes (ferns and lycophytes), excluding hybrids: a) pteridophytes, b) ferns, c) ferns analyzed separately north and south of 30.1 degrees latitude."}
a <- make_diversity_map(
    div_data = alpha_div_pteridos, 
    world_map = world_map, 
    occ_data = occ_data_pteridos, 
    div_metric = "mntd_obs_z", 
    metric_title = "mntd"
  ) + scale_fill_scico(
    palette = "vik", 
    na.value="white",
    limits = c(
      -get_limit(alpha_div_pteridos, mntd_obs_z, "abs", 3), 
      get_limit(alpha_div_pteridos, mntd_obs_z, "abs", 3)
    )) +
  theme(legend.position = "none")

b <- make_diversity_map(
    div_data = alpha_div_ferns, 
    world_map = world_map, 
    occ_data = occ_data_ferns, 
    div_metric = "mntd_obs_z", 
    metric_title = "mntd"
  ) + scale_fill_scico(
    palette = "vik", 
    na.value="white",
    limits = c(
      -get_limit(alpha_div_ferns, mntd_obs_z, "abs", 3), 
      get_limit(alpha_div_ferns, mntd_obs_z, "abs", 3)
    )) +
  theme(legend.position = "none")

c <- make_diversity_map(
    div_data = alpha_div_ferns_ns, 
    world_map = world_map, 
    occ_data = occ_data_ferns, 
    div_metric = "mntd_obs_z", 
    metric_title = "mntd"
  ) + scale_fill_scico(
    palette = "vik", 
    na.value="white",
    limits = c(
      -get_limit(alpha_div_ferns_ns, mntd_obs_z, "abs", 3), 
      get_limit(alpha_div_ferns_ns, mntd_obs_z, "abs", 3)
    )) +
  theme(legend.position = "none")

a + b + c + plot_layout(nrow = 1)
```

```{r compare-pd-el, fig.cap = "Relationship between standard effect size (SES) of mean phylogenetic distance (MPD) and mean nearest taxon distance (MNTD) of native Japanese pteridophytes and elevation (m). Blue trendline shows significant linear model fit with confidence interval in pink."}
a <- make_scatter_with_lm(alpha_div_pteridos, "elevation", "mpd_obs_z", "Elevation (m)", "MPD") +
  labs(title = "Pteridophytes", x = "")
b <- make_scatter_with_lm(alpha_div_ferns, "elevation", "mpd_obs_z", "Elevation (m)", "MPD") +
  labs(title = "Ferns", y = "", x = "")
c <- make_scatter_with_lm(alpha_div_ferns_ns, "elevation", "mpd_obs_z", "Elevation (m)", "MPD") +
  labs(title = "Ferns (NS separate)", y = "", x = "")
d <- make_scatter_with_lm(alpha_div_pteridos, "elevation", "mntd_obs_z", "Elevation (m)", "MNTD")
e <- make_scatter_with_lm(alpha_div_ferns, "elevation", "mntd_obs_z", "Elevation (m)", "MNTD") +
  labs(y = "")
f <- make_scatter_with_lm(alpha_div_ferns_ns, "elevation", "mntd_obs_z", "Elevation (m)", "MNTD") +
  labs(y = "")
a + b + c + d + e + f + plot_layout(ncol = 3, nrow = 2)
```

```{r sex-dip-ferns-map, fig.cap = "Percentage of sexual diploid fern taxa, excluding hybrids."}
make_diversity_map(
  div_data = alpha_div_ferns, 
  world_map = world_map, 
  occ_data = occ_data_ferns, 
  div_metric = "percent_sex_dip",
  metric_title = "% sex. diploid"
) + scale_fill_scico(palette = "bilbao", na.value="white")
```

```{r compare-pd-sexdip, fig.cap = "Relationship between standard effect size (SES) of mean phylogenetic distance (MPD) and mean nearest taxon distance (MNTD) of native Japanese pteridophytes and percent sexual diploid taxa in each community. Blue trendline shows significant linear model fit with confidence interval in pink."}
a <- make_scatter_with_lm(alpha_div_pteridos, "percent_sex_dip", "mpd_obs_z", "% sexual diploid", "MPD") +
  labs(title = "Pteridophytes", x = "")
b <- make_scatter_with_lm(alpha_div_ferns, "percent_sex_dip", "mpd_obs_z", "% sexual diploid", "MPD") +
  labs(title = "Ferns", y = "", x = "")
c <- make_scatter_with_lm(alpha_div_ferns_ns, "percent_sex_dip", "mpd_obs_z", "% sexual diploid", "MPD") +
  labs(title = "Ferns (NS separate)", y = "", x = "")
d <- make_scatter_with_lm(alpha_div_pteridos, "percent_sex_dip", "mntd_obs_z", "% sexual diploid", "MNTD")
e <- make_scatter_with_lm(alpha_div_ferns, "percent_sex_dip", "mntd_obs_z", "% sexual diploid", "MNTD") +
  labs(y = "")
f <- make_scatter_with_lm(alpha_div_ferns_ns, "percent_sex_dip", "mntd_obs_z", "% sexual diploid", "MNTD") +
  labs(y = "")
a + b + c + d + e + f + plot_layout(ncol = 3, nrow = 2)
```
