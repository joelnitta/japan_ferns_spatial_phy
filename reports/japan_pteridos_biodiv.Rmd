---
title: "Biodiversity of Japanese Pteridophytes"
author: "Joel Nitta"
date: "6/27/2019"
output: 
  bookdown::html_document2:
    fig_caption: yes
    number_sections: no
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```

```{r load-data}
loadd(richness_pteridos_map)
loadd(alpha_div_pteridos)
loadd(alpha_div_ferns_north)
loadd(ses_pd_pteridos_map)
loadd(ses_pd_ferns_north_map)
loadd(ses_pd_highlight_fern_north_map)
loadd(occ_data_ferns_north)
loadd(occ_data_ferns)
```


### Richness

Richness of pteridophytes in Japan roughly follows the latitudinal species gradient, with more species in the south (Fig. \@ref(fig:richness-pteridos)).

### Phylogenetic diversity (PD) calculations

Phylogenetic diversity (PD) is the total phylogenetic branch length of all species in a community  (a "community" is defined here as co-occurring taxa within a 1 km^2^ grid cell). Observed PD is highly correlated with species richness (Fig. \@ref(fig:compare-obs-pd-richness)), as has been demonstrated in many other studies, and by itself is not very informative.

To determine whether communities are significantly phylogenetically overdispersed (i.e., diverse) or clustered (i.e., depauperate), we compared observed PD to a null distribution of 999 randomly generated PD values for each community. Null values were generated by randomizing the names on the tips of the tree using `picante::tipShuffle()`, and calculating PD with the randomized tree. The standard effect size (SES) of PD was then calculated by comparing observed PD to the null distribution using the following equation:

SES PD = (observed PD - mean of null PD values) / standard deviation of null PD values

Thus, large positive values of SES of PD indicate phylogenetic overdispersion, and large negative values indicate phylogenetic clustering. Values near 0 are not significantly different from the null distribution.

### SES of PD: all pteridophytes

SES of PD shows a much weaker correlation with species richness than observed PD (Fig. \@ref(fig:compare-ses-pd-richness)). Likewise, spatial distribution of SES of PD differs strongly from species richness (Fig. \@ref(fig:pd-pteridos)). Mountainous areas on the main island of Japan tend to be clustered (blue), and smaller islands in the south (especially the Okinawan islands) and areas on the coast tend to be overdispersed (red).

However, SES of PD values for pteridophytes tend to skew towards clustering overall (median `r median(alpha_div_pteridos$ses_pd, na.rm = TRUE) %>% round(2)`, Fig. \@ref(fig:pd-pteridos-hist)). This could be due to the fact that a large number of primarily tropical fern lineages only occur in the far-southern islands of Japan: `r setdiff(occ_data_ferns$genus, occ_data_ferns_north$genus) %>% length` genera and `r setdiff(occ_data_ferns$family, occ_data_ferns_north$family) %>% length` families (`r setdiff(occ_data_ferns$family, occ_data_ferns_north$family) %>% paste(collapse = ", ")`) do not occur north of 30.1 degrees latitude. 

When these lineages are included in the randomization procedure to calculate SES of PD, they likely contribute long branches that bias the northern communities towards clustering. Lycophytes, which occur on long branches, may have a similar effect. Therefore, we also calculated SES of PD for a dataset including only ferns north of 30.1 degrees latitude (from Yakushima island northwards). This includes a more or less contiguous land area that ferns could likely disperse across, unlike the farth-south islands which are separated by multiple straits from the main islands of Japan.

```{r pd-by-el-summary}
# Run linear model of SES of PD vs. elevation in northern ferns dataset
pd_by_el_summary <- lm(ses_pd ~ elevation, alpha_div_ferns_north) %>% summary

# Extract R2 and pvalue for mentioning in text.
pd_by_el_r2 <- pd_by_el_summary[['adj.r.squared']] %>% round(2)

pd_by_el_pval <- pd_by_el_summary %>% tidy %>% filter(term == "elevation") %>% pull(p.value)

```

### SES of PD: ferns on main islands of Japan only

Standard effect size of PD is less skewed in the dataset including only ferns north of 30.1° (median `r median(alpha_div_ferns_north$ses_pd, na.rm = TRUE) %>% round(2)`, Fig. \@ref(fig:pd-ferns-north-hist)). A similar overall pattern is observed in the spatial distribution of SES of PD for ferns north of 30.1° compared to all pteridophytes, but the number of clustered cells is fewer (Fig. \@ref(fig:pd-ferns-north)). This is especially clear when plotting only communities that are significantly overdispersed or clustered (Fig. \@ref(fig:pd-ferns-north-highlight)). Standard effect size of PD decreases significantly with elevation (Fig. \@ref(fig:pd-ferns-north-el), linear model; *R*^2^ = `r pd_by_el_r2`, *P* << 0.05).

## Figures

```{r richness-pteridos, fig.cap = "Richness of native Japanese pteridophyte taxa."}
richness_pteridos_map
```

```{r compare-obs-pd-richness, fig.cap = "Correlation between observed phylogenetic diversity (PD) and species richness, for all native Japanese pteridophyte taxa excluding hybrids."}
ggplot(alpha_div_pteridos, aes(richness, pd_obs)) +
  geom_point(alpha = 0.2) +
  jntools::standard_theme() +
  labs(
    y = "Observed PD",
    x = "Richness"
  )
```

```{r compare-ses-pd-richness, fig.cap = "Standard effect size (SES) of phylogenetic diversity (PD) vs. species richness, for all native Japanese pteridophyte taxa excluding hybrids."}
ggplot(alpha_div_pteridos, aes(richness, ses_pd)) +
  geom_point(alpha = 0.2) +
  jntools::standard_theme() +
  labs(
    y = "SES of PD",
    x = "Richness"
  )
```

```{r pd-pteridos, fig.cap = "Standard effect size (SES) of phylogenetic diversity (PD) of native Japanese pteridophyte taxa, excluding hybrids."}
ses_pd_pteridos_map
```

```{r pd-pteridos-hist, fig.cap = "Histogram of standard effect size (SES) of phylogenetic diversity (PD) values of native Japanese pteridophyte taxa, excluding hybrids. Red line shows median."}
ggplot(alpha_div_pteridos, aes(ses_pd)) +
  geom_histogram() +
  geom_vline(xintercept = median(alpha_div_pteridos$ses_pd, na.rm = TRUE), color = "red") +
  labs(x = "SES of PD")
```

```{r pd-ferns-north-hist, fig.cap = "Histogram of standard effect size (SES) of phylogenetic diversity (PD) values of native Japanese fern taxa north of 30.1 degrees latitude, excluding hybrids. Red line shows median."}
ggplot(alpha_div_ferns_north, aes(ses_pd)) +
  geom_histogram() +
  geom_vline(xintercept = median(alpha_div_ferns_north$ses_pd, na.rm = TRUE), color = "red") +
  labs(x = "SES of PD")
```

```{r pd-ferns-north, fig.cap = "Standard effect size (SES) of phylogenetic diversity (PD) of native Japanese fern taxa north of 30.1 degrees latitude, excluding hybrids."}
ses_pd_ferns_north_map
```

```{r pd-ferns-north-highlight, fig.cap = "Standard effect size (SES) of phylogenetic diversity (PD) of native Japanese fern taxa excluding hybrids north of 30.1 degrees latitude, only showing cells that are significantly overdispersed (red) or clustered (blue)."}
ses_pd_highlight_fern_north_map
```

```{r pd-ferns-north-el, fig.cap = "Relationship between standard effect size (SES) of phylogenetic diversity (PD) of native Japanese fern taxa excluding hybrids north of 30.1 degrees latitude and elevation (m). Blue trendline shows significant linear model fit with confidence interval in pink."}

lm(ses_pd ~ elevation, alpha_div_ferns_north) %>% augment %>%
ggplot(aes(x = elevation)) +
  geom_point(aes(y = ses_pd), alpha = 0.2) +
  geom_ribbon(aes(ymin=.fitted-1.96*.se.fit, ymax=.fitted+1.96*.se.fit), alpha = 0.4, fill = "pink") +
  geom_line(aes(y = .fitted), color = "blue") +
  annotate("text", 
           x = Inf, y = Inf, 
           label = glue::glue("italic(R) ^ 2 == {pd_by_el_r2}"),
           parse = TRUE,
           hjust = 1.2,
           vjust = 1.2) +
  jntools::standard_theme() +
  labs(
    y = "SES of PD",
    x = "Elevation (m)"
  )

```

