---
title: "Results"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, results = "hide", cache = TRUE)

# Load packages and functions
source(here::here("R/packages.R"))
source(here::here("R/functions.R"))
library(patchwork)
library(rcartocolor)

# Load objects from cache
ja_fern_cache <- new_cache(here::here("ja_fern_cache"))

loadd(list = c(
  "ses_div_ferns",
  "shape_ferns",
  "comm_scaled_coverage_0.2",
  "ses_div_ferns_endemic",
  "k_taxonomy",
  "k_phylogeny",
  "regions_taxonomy",
  "regions_phylogeny",
  "species_motifs_ferns"
),
cache = ja_fern_cache)
```

```{r plot-prep}
tax_regions_data <- regions_taxonomy %>%
  mutate(taxonomic_cluster = as.factor(cluster) %>% fct_infreq %>% as.numeric %>% as.factor)

phy_regions_data <- regions_phylogeny %>%
  mutate(phylo_cluster = as.factor(cluster) %>% fct_infreq %>% as.numeric %>% as.factor)

ses_div_ferns_spatial <-
  shape_ferns %>%
  left_join(categorize_endemism(ses_div_ferns), by = c(grids = "site")) %>%
  left_join(comm_scaled_coverage_0.2, by = c(grids = "site")) %>%
  mutate(redundancy = 1 - (richness/abundance)) %>%
  left_join(tax_regions_data, by = "grids") %>%
  left_join(phy_regions_data, by = "grids")

ses_div_ferns_endemic_spatial <-
shape_ferns %>%
  left_join(categorize_endemism(ses_div_ferns_endemic), by = c(grids = "site"))

map_theme <- theme(
    # panel.background = element_rect(fill = "white"),
    panel.grid.major = element_line(color = "white", size = 0.2),
    axis.ticks = element_blank()
  )

```

```{r k-taxonomy-plot, include = FALSE}
k_taxonomy$df %>%
  as_tibble() %>%
  mutate(optimal = ifelse(k == k_taxonomy$optimal$k, TRUE, FALSE)) %>%
  ggplot(aes(x = k, y = ev)) +
  geom_path() +
  geom_point(aes(color = optimal)) +
  scale_color_manual(values = c("TRUE" = "red", "FALSE" = "black")) +
  labs(
    y = "Explained variances",
    x = "Number of clusters") +
  annotate("text", x = Inf, y = Inf, label = glue::glue("K = {k_taxonomy$optimal$k}"), hjust = 1, vjust = 1) +
  theme(legend.position = "none")
```

```{r k-phylogeny-plot, include = FALSE}
k_phylogeny$df %>%
  as_tibble() %>%
  mutate(optimal = ifelse(k == k_phylogeny$optimal$k, TRUE, FALSE)) %>%
  ggplot(aes(x = k, y = ev)) +
  geom_path() +
  geom_point(aes(color = optimal)) +
  scale_color_manual(values = c("TRUE" = "red", "FALSE" = "black")) +
  labs(
    y = "Explained variances",
    x = "Number of clusters") +
  annotate("text", x = Inf, y = Inf, label = glue::glue("K = {k_phylogeny$optimal$k}"), hjust = 1, vjust = 1) +
  theme(legend.position = "none")
```

Redundancy (number of specimens per species) is generally high throughout the country, but lower in Hokkaido and some coastal areas and small islands (Fig 1B). Species richness is highest in southern Kyushu and on Yakushima Island, and lowest on Hokkaido and low-lying coastal areas (Fig 1A). Raw MPD is mostly uniform throughout (Fig 1C), but SES of MPD shows clustering in mountainous areas of Honshu and overdispersion in souther Kyushu and islands further south (Fig 1D).

Phylogenetic endemism (PE) is extremeley low throughout except for in some of the southern islands (Fig 2A). SES of PE is high starting in southern Kyushu and southwards, including the Ogasawara islands (Fig 2B). Results of CANAPE (Categorical Analysis of Palaeo and Neo Endemism) indicate hotspots of mixed endemism in the southern islands, but no neo- or paleo-endemism (Fig 2E). It is possible that endemism may be affected by species that are actually wide-ranging, but only have a small range in Japan (the "border effect"). This is especially the case for southern, sub-tropical islands, which harbor many tropical species with small ranges in Japan but wider ranges outside of the country. To account for this, we also analyzed a dataset including only species endemic to Japan (Fig 2C, D, and F). The patterns are generally similar to the full dataset, indicating that the southern islands are genuine hotspots of endemicity.

Analysis of biogeographic regions using taxonomy (species names) resulted in the vast majority of grid cells classified into four regions: Cluster 1 (Hokkaido and northern Honshu), Cluster 2 (southern Honshu), Cluster 3 (Okinawa), and Cluster 4 (Ogasawara Islands) (Fig 3A). Using phylogenetic distances produced similar results, except that most grid cells in Okinawa and the Ogawara Islands grouped into the same cluster.

Analysis of ecological structure using species names with the same number of clusters as the taxonomic bioregions (K = 8) revealed high amounts of turnover throughout Honshu that mostly tracks latitude and elevation.

```{r diversity-plots, fig.width = 10, fig.height=7.5}
# Richness
a <- ggplot(ses_div_ferns_spatial, aes(fill = richness)) +
  geom_sf(color = "transparent") +
  scale_fill_viridis_c() +
  labs(fill = "Richness \n (n spp.)") +
  scale_y_continuous(labels = scales::label_number(suffix = "\u00b0N", accuracy = 1)) +
  scale_x_continuous(labels = scales::label_number(suffix = "\u00b0E", accuracy = 1)) +
  map_theme +
  theme(
    axis.text.x = element_blank()
  )

# Sampling rendundancy
b <- ggplot(ses_div_ferns_spatial, aes(fill = redundancy)) +
  geom_sf(color = "transparent") +
  scale_fill_viridis_c() +
  scale_y_continuous(labels = scales::label_number(suffix = "\u00b0N", accuracy = 1)) +
  scale_x_continuous(labels = scales::label_number(suffix = "\u00b0E", accuracy = 1)) +
  labs(fill = "Redundancy") +
  map_theme +
  theme(
    axis.text.x = element_blank(),
    axis.text.y = element_blank()
  )

# MPD
c <- ggplot(ses_div_ferns_spatial, aes(fill = mpd_obs)) +
  geom_sf(color = "transparent") +
  labs(fill = "MPD") +
  scale_y_continuous(labels = scales::label_number(suffix = "\u00b0N", accuracy = 1)) +
  scale_x_continuous(labels = scales::label_number(suffix = "\u00b0E", accuracy = 1)) +
  scale_fill_viridis_c() +
  map_theme

# SES MPD
d <- ggplot(ses_div_ferns_spatial, aes(fill = mpd_obs_z)) +
  geom_sf(color = "transparent") +
  labs(fill = "SES MPD") +
  scale_fill_scico(
    palette = "romaO",
    na.value="grey80",
    direction = -1,
    limits = c(
      -get_limit(ses_div_ferns_spatial, pd_obs_z, "abs"),
      get_limit(ses_div_ferns_spatial, pd_obs_z, "abs")
    )) +
  scale_y_continuous(labels = scales::label_number(suffix = "\u00b0N", accuracy = 1)) +
  scale_x_continuous(labels = scales::label_number(suffix = "\u00b0E", accuracy = 1)) +
  map_theme +
  theme(
    axis.text.y = element_blank()
  )

a + b + c + d  +
  plot_annotation(tag_levels = 'A')

```

**Figure 1**. Taxonomic and phylogenetic diversity of the ferns of Japan. A, richness. B, sampling redundancy. C, mean phylogenetic distance (MPD). D, Standard effect size of MPD.

```{r endem-plots, fig.width = 10, fig.height=11.5}
# PE
a <- ggplot(ses_div_ferns_spatial, aes(fill = pe_obs)) +
  geom_sf(color = "transparent") +
  scale_fill_viridis_c() + 
  labs(fill = "PE") +
  map_theme

# SES PE
b <- ggplot(ses_div_ferns_spatial, aes(fill = pe_obs_z)) +
  geom_sf(color = "transparent") +
  labs(fill = "SES PE") +
  scale_fill_scico(
    palette = "romaO",
    na.value="grey80",
    direction = -1,
    limits = c(
      -get_limit(ses_div_ferns_spatial, pe_obs_z, "abs"),
      get_limit(ses_div_ferns_spatial, pe_obs_z, "abs")
    )) +
  map_theme

# PE (endemic)
c <- ggplot(ses_div_ferns_endemic_spatial, aes(fill = pe_obs)) +
  geom_sf(color = "transparent") +
  scale_fill_viridis_c() + 
  labs(fill = "PE") +
  map_theme

# SES PE (endemic)
d <- ggplot(ses_div_ferns_endemic_spatial, aes(fill = pe_obs_z)) +
  geom_sf(color = "transparent") +
  labs(fill = "SES PE") +
  scale_fill_scico(
    palette = "romaO",
    na.value="grey80",
    direction = -1,
    limits = c(
      -get_limit(ses_div_ferns_endemic_spatial, pe_obs_z, "abs"),
      get_limit(ses_div_ferns_endemic_spatial, pe_obs_z, "abs")
    )) +
  map_theme

# CANAPE
e <- ggplot(ses_div_ferns_spatial, aes(fill = endem_type)) +
  geom_sf(color = "transparent") +
  labs(fill = "Endemism\ntype") +
  map_theme

# CANAPE (endemic)
f <- ggplot(ses_div_ferns_endemic_spatial, aes(fill = endem_type)) +
  geom_sf(color = "transparent") +
  labs(fill = "Endemism\ntype") +
  map_theme

a + b + c + d + e + f +
  plot_layout(ncol = 2) +
  plot_annotation(tag_levels = 'A')
```

**Figure 2**. Phylogenetic endemism of the ferns of Japan. A, phylogenetic endemism (PE). B, Standard effect size (SES) of PE. C, PE of endemic taxa only. D, SES of PE of endemic taxa only. E, Categorical analysis of neo- and paleo- endemism (CANAPE) results. F, CANAPE results for endemic taxa only.

```{r bioregion-plots, fig.width = 10, fig.height=4.5}
# Taxonomic bioregions
a <- ggplot(ses_div_ferns_spatial, aes(fill = taxonomic_cluster)) +
  geom_sf(color = "transparent") +
  scale_fill_carto_d(name = "Cluster", type = "qualitative", palette = "Bold") +
  map_theme

# Phylogenetic bioregions
b <- ggplot(ses_div_ferns_spatial, aes(fill = phylo_cluster)) +
  geom_sf(color = "transparent") +
  labs(fill = "Cluster") +
  scale_fill_carto_d(name = "Cluster", type = "qualitative", palette = "Bold") +
  map_theme

a + b +
  plot_layout(ncol = 2) +
  plot_annotation(tag_levels = 'A')
```

**Figure 3**. Bioregions of the ferns of Japan. A, taxonomic bioregions B, phylogenetic bioregions.

```{r ecostructure}
tweak <- 0.75

sites <- ses_div_ferns_spatial %>%
  pull(grids)

centroids <-
ses_div_ferns_spatial %>%
  select(geometry) %>%
  mutate(centroid = sf::st_centroid(geometry)) %>%
  sf::st_coordinates(x = .$centroid) %>%
  as_tibble() %>%
  mutate(site = sites)

omega <-
species_motifs_ferns$omega %>%
  as.data.frame %>%
  rownames_to_column("site") %>%
  left_join(centroids, by = "site") %>%
  column_to_rownames("site")

omega_centroids <- select(omega, X, Y) %>% # longitude, latitude
  as.matrix()

omega <- select(omega, -X, -Y)

ecos_plot_pie2(
    omega = omega,
    image_width = 6000*tweak,
    image_height = 4800*tweak,
    radius = 0.08,
    no_map = TRUE,
    coords = omega_centroids,
    long_lim = c(121, 148),
    lat_lim = c(23, 47),
    color = carto_pal(8, "Bold"),
    blank_bg = "grey90",
    path = here::here(
      "reports/figures/species_motifs_ferns.png"
    )
)

```

![](species_motifs_ferns.png)

**Figure 4**. Ecological structure of the ferns of Japan based on species' occurrences. K = 8.
