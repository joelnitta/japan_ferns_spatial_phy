---
output:
  xaringan::moon_reader:
    css: ["default-fonts", "default", "custom.css"]
    lib_dir: libs
    mathjax: default
    seal: false
    nature:
      slideNumberFormat: "" # To turn off slide numbers
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
      titleSlideClass: ["left", "middle", "inverse"]
editor_options:
  chunk_output_type: console
---
class: inverse, middle, title-slide, big-margin
background-color: #000000
background-position: 50% 50%
background-image: url(images/title_background.png)
background-size: contain

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, include = TRUE, eval = TRUE, cache = TRUE, dev = "svg", dev.args=list(bg="transparent"))
```

```{r load-packages-funcs, cache = FALSE}
library(conflicted)
library(magick)
library(ggtext)
library(drake)
library(knitr)
library(patchwork)
library(scales)
library(scico)
library(magrittr)
library(broom)
library(assertr)
library(sf)
library(rcartocolor)
library(tidyverse)

# Resolve conflicts
conflicted::conflict_prefer("map", "purrr")
conflicted::conflict_prefer("select", "dplyr")
conflicted::conflict_prefer("filter", "dplyr")
conflicted::conflict_prefer("gather", "tidyr")
conflicted::conflict_prefer("extract", "magrittr")

# Specify custom themes
simple_map_theme <- function () {
  theme(
    panel.grid.major = element_line(color = "white", size = 0.1),
    panel.background = element_rect(fill = "grey70"),
    legend.position = "none",
    axis.text = element_blank(),
    axis.ticks = element_blank()
  )
}

simple_map_theme_light <- function () {
  theme(
    panel.grid.major = element_line(color = "white", size = 0.1),
    panel.background = element_rect(fill = "grey90"),
    legend.position = "none",
    axis.text = element_blank(),
    axis.ticks = element_blank()
  )
}

trend_line_theme <- function () {
  theme(
    panel.background = element_blank(),
    panel.grid.major = element_line(size = 0.1, color = "dark grey"),
    panel.grid.minor = element_blank(),
    axis.title.y = element_blank(),
    axis.ticks.y = element_blank(),
    axis.ticks.x = element_blank(),
    axis.text.y = element_blank()
  )
}


map_theme_pp <- function() {
  theme(
    panel.grid.major = element_line(color = "white", size = 0.1),
    panel.background = element_rect(fill = "grey70"),
    axis.ticks = element_blank()
  )
}

map_theme_pp_light <- function() {
  theme(
    panel.grid.major = element_line(color = "white", size = 0.1),
    panel.background = element_rect(fill = "grey90"),
    axis.ticks = element_blank()
  )
}


# Set color palettes
# Randomization test significance
signif_cols <-
  c(
    "> 0.99" = "#e31a1c",
    "> 0.975" = "#fb9a99",
    "< 0.01" = "#1f78b4",
    "< 0.025" = "#a6cee3",
    "not significant" = "#ffffcc"
  )

# CANAPE
canape_cols <-
  c(
    "neo" = "#e31a1c",
    "paleo" = "#1f78b4",
    "mixed" = "#6a51a3",
    "super" = "#4a1486",
    "not significant" = "#ffffcc"
  )

# Bioregions
bioregion_cols <- rcartocolor::carto_pal(9, "Bold")[1:8] %>%
  set_names(1:8)

source(here::here("R/functions.R"))
```

```{r, load-refs, includ = FALSE, cache = FALSE}
# Set bibliography options
library(RefManageR)
BibOptions(
  ignore.case = TRUE,
  check.entries = FALSE,
  max.names = 3,
  bib.style = "authoryear", # set style of bibliography as e.g., "Nitta 2020..."
  style = "text" # set style of citations as plain text (no links)
)
```

```{r load-data, cache = FALSE}
# Set cache
ja_fern_cache <- new_cache(here::here("ja_fern_cache"))

# Load targets
loadd(list = c(
  "biodiv_ferns_spatial",
  "occ_point_data_ferns",
  "protected_areas",
  "traits_for_dist",
  "comm_ferns",
  "green_list",
  "ppgi",
  "japan_shp",
  "signif_cells_protected_area"),
  cache = ja_fern_cache)

# Read in pteridophyte GBIF collections per country data from
# Iwasaki lab presentation
collections_by_country <- read_csv(here::here("data_raw/gbif_pterido_coll_by_country.csv")) %>%
  mutate(country = factor(country)) %>%
  mutate(country = fct_reorder(country, n))

# Read in bibliography
bib <- ReadBib(here::here("presentations/bsa_2020-07-27/refs.bib"), check = FALSE)

# Read in Green List in Japanese
green_list_ja <- readxl::read_excel(here::here("presentations/bsj_2020-09-19/data/FernGreenListV1.01.xls")) %>%
  transmute(taxon_id = as.character(ID20160331), name_ja = 新リスト和名)

# Save currently used data as back-up in case data produced by plan changes
data <- list(
  biodiv_ferns_spatial = biodiv_ferns_spatial,
  occ_point_data_ferns = occ_point_data_ferns,
  protected_areas = protected_areas,
  traits_for_dist = traits_for_dist,
  comm_ferns = comm_ferns,
  green_list = green_list,
  ppgi = ppgi,
  japan_shp = japan_shp,
  collections_by_country = collections_by_country,
  bib = bib,
  green_list_ja = green_list_ja,
  signif_cells_protected_area = signif_cells_protected_area
)

saveRDS(data, here::here("presentations/bsj_2020-09-19/data/data.RDS"))
```

```{r prep-data}
# Change cluster to factor
biodiv_ferns_spatial <- biodiv_ferns_spatial %>%
  mutate(taxonomic_cluster = as.factor(taxonomic_cluster) %>% fct_infreq %>% as.numeric %>% as.factor) %>%
  mutate(phylo_cluster = as.factor(phylo_cluster) %>% fct_infreq %>% as.numeric %>% as.factor) %>%
  # Add redundancy
  mutate(redundancy = 1 - (richness/abundance))

# Download high-res map of Japan,
# crop to spatial div results area
japan <- sf::st_crop(japan_shp, sf::st_bbox(biodiv_ferns_spatial))

# Set CRS
st_crs(japan) <- 4326
st_crs(biodiv_ferns_spatial) <- 4326
st_crs(protected_areas) <- 4326
```

```{r title-slide-image, eval = FALSE}
# Code to make title slide image, don't need to run when rendering slides
title_theme <- theme_void() +
  theme(
    plot.title = element_blank(),
    plot.subtitle = element_blank(),
    legend.position = "none",
     panel.background = element_rect(fill = "black"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
  )

a <- ggplot(biodiv_ferns_spatial, aes(fill = richness)) +
  geom_sf(color = "transparent") +
  scale_fill_scico(palette = "lajolla") +
  title_theme

b <- ggplot(data = biodiv_ferns_spatial, aes(fill = rpd_signif)) +
  geom_sf(color = "transparent", alpha = 1.0) +
  labs(fill = "") +
  scale_fill_manual(values = signif_cols) +
  map_theme() +
  theme(
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    legend.title = element_blank()
  ) +
  title_theme

c <- ggplot(biodiv_ferns_spatial, aes(fill = phylo_cluster)) +
  geom_sf(color = "transparent") +
  labs(fill = "Cluster") +
  scale_fill_carto_d(name = "Cluster", type = "qualitative", palette = "Bold") +
  title_theme

title_image <- a + b + c + plot_layout(ncol = 1)

# Write out here, then crop manually
ggsave(
  plot = title_image,
  filename = here::here("presentations/bsj_2020-09-19/images/title.png"),
  dpi = 300)
```

.pull-left-wide[
# 日本のシダ植物多様性の<br>多次元解析
<br>
## 新田ジョエル<sup>1</sup>・Brent Mishler<sup>2</sup><br>岩崎渉<sup>1</sup>・海老原淳<sup>3</sup>

<sup>1</sup>東京大学理学系研究科<br>

<sup>2</sup>University of California, Berkeley

<sup>3</sup>国立科学博物館

日本植物学会第84回大会<br><span style = 'font-size: 80%;'>2020.03.01</span>

<span style = 'font-size: 80%;'>https://joelnitta.com</span>

]

.pull-right-narrow[
<img src="images/title_cropped.png" alt="drawing" width="300"/>
]

---
class: big-margin

## 生物多様性は種数だけではない

種数は生物多様性の複数ある次元の一つだけ

他には

- 系統的多様性

- 機能的多様性

- それぞれの関係性

も考慮しなくてはなりません

<img src="images/not_just_species.png" alt="drawing" width="800"/>


---
class: big-margin

## 生物多様性は種数だけではない

種数は生物多様性の複数ある次元の一つだけ

他には

- 系統的多様性

- 機能的多様性

- それぞれの関係性

も考慮しなくてはなりません。

しかし、これは大量のデータを必要とする作業です。


---
class: big-margin

```{r count-taxa}
# count number of higher taxa (genera and families)
n_fern_taxa <-
green_list %>%
  mutate(genus = str_split(taxon, "_") %>% map_chr(1)) %>%
  assert(not_na, genus) %>%
  # Add higher-level taxonomy
  left_join(ppgi, by = "genus") %>%
  assert(not_na, class) %>%
  # Filter to only ferns
  filter(class == "Polypodiopsida") %>%
  summarize(
    n_genus = n_distinct(genus),
    n_family = n_distinct(family)
  )
```

.pull-left[

## 日本のシダ植物：生物多様性のモデルシステムとして

- 約675種 ・`r n_fern_taxa$n_genus`属・`r n_fern_taxa$n_family`科

- 全世界でももっとも研究が進んでいるシダ植物フロラの一つ

- DNA、種の分布、種の機能的特徴も網羅的にサンプリング済
]

.pull-right[
.center[
<img src="images/ja_example_ferns.png" alt="drawing" height="580"/>
]
]

.footnote[.small[Photos: A. Ebihara]]

---
class: big-margin

.pull-left[

## 日本のシダ植物：生物多様性のモデルシステムとして

- 約675種 ・`r n_fern_taxa$n_genus`属・`r n_fern_taxa$n_family`科

- 全世界でももっとも研究が進んでいるシダ植物フロラの一つ

- DNA、種の分布、種の機能的特徴も網羅的にサンプリング済
]

.pull-right[
```{r gbif-colls-per-country}
# Plot showing top 10 pteridophyte collections in GBIF by country
ggplot(collections_by_country, aes(x = country, y = n)) +
  geom_col() +
  coord_flip() +
  labs(
    title = "GBIF pteridophyte \ncollections (top 10)",
    y = "No. collections") +
  scale_y_continuous(labels = scales::comma) +
  ggplot2::theme_bw(base_size = 24) +
  theme(
    axis.title.y = element_blank(),
    panel.grid.minor = ggplot2::element_blank(),
    panel.grid.major.y = ggplot2::element_blank(),
      axis.text.x = ggplot2::element_text(colour="black"),
      axis.text.y = ggplot2::element_text(colour="black")
  )
```
]

---
## 日本の生物地理学入門（短縮バージョン）

.pull-left-narrow[
- 北（亜寒帯）から南（亜熱帯）において気候変動が広い

- 標高も変動が広い

- 第三紀のレフュジア（氷河に覆われたことがない）

- 本州は大陸島

- 沖縄、小笠原は海洋島
]

.pull-right-wide[
<img src="images/japan_intro.png" alt="drawing" height="580"/>
]

---
class: big-margin

## 本研究の目的

**日本産シダ類** において、以下のことを把握する：

1. 生物多様性がどのように分布しているのか？

2. 生物多様性がどのような構造を持っているのか？

3. 生物多様性がどれくらい守れているのか？

---
class: big-margin
## データ

```{r summarize-traits}
trait_summary <- make_trait_summary(traits_for_dist)

n_binary <- trait_summary %>% filter(trait_type == "binary") %>% nrow()
n_cont <- trait_summary %>% filter(trait_type == "continuous") %>% nrow()
n_qual <- trait_summary %>% filter(trait_type == "qualitative") %>% nrow()
```

**分布データ**

- 日本の植物標本庫に収納されている標本

- `r nrow(occ_point_data_ferns) %>% scales::number(big.mark = ",")` 点 (`r occ_point_data_ferns %>% pull(taxon) %>% n_distinct()` 種)

- 上のリストを0.2°（約20 km x 20 km）有無マトリックスに変換する

---
class: big-margin
## データ

**系統樹**

- 日本の標本から葉緑体遺伝子*rbcL* `r AutoCite(bib, "Ebihara2019b")`

- GenBankにある広いサンプリングと合わせる

- IQ-TREEによる系統解析 (Nguyen et al., 2015) `r NoCite(bib, "Nguyen2015")`

- 27点の化石`r AutoCite(bib, "Testo2016a")` を取り入れたtreePL `r AutoCite(bib, "Smith2012")`による分岐年代推定

- 日本の種だけに部分集合

---
class: big-margin

## データ

**機能的特徴**

- 元々種同定に使われた機能的特徴が`r nrow(trait_summary)`個 `r AutoCite(bib, "Ebihara2019b")`

- 例：包膜の有無、葉柄の長さ、葉の厚さ


---
class: middle, inverse, big-margin

# 生物多様性がどのように分布しているのか？

---
## 種数は山型

```{r centroids}
# Convert diversity metrics dataframe to centroids for plotting trends
ses_div_centroids <-
  biodiv_ferns_spatial %>%
  mutate(
    longitude = sf::st_centroid(geometry) %>% st_coordinates %>% magrittr::extract(,1),
    latitude = sf::st_centroid(geometry) %>% st_coordinates %>% magrittr::extract(,2)) %>%
  as_tibble %>%
  dplyr::select(-geometry)

# Get min and max latitude for setting common limits between
# maps and trendlines
ja_lat_min <- ses_div_centroids %>% pull(latitude) %>% min()
ja_lat_max <- ses_div_centroids %>% pull(latitude) %>% max()
```

```{r richness, out.width = "120%"}
# Fern richness
# - map
a <-
  ggplot() +
  geom_sf(data = japan, fill = "grey90", color = "black", lwd = 0.25) +
  geom_sf(data = biodiv_ferns_spatial, aes(fill = richness), color = "transparent", alpha = 0.8) +
  geom_sf() +
  scale_fill_scico(palette = "lajolla") +
  labs(fill = "No. taxa") +
  scale_y_continuous(labels = scales::label_number(suffix = "\u00b0N", accuracy = 1), limits = c(ja_lat_min, ja_lat_max)) +
  scale_x_continuous(labels = scales::label_number(suffix = "\u00b0E", accuracy = 1)) +
  map_theme() +
  theme(
    legend.title = element_text(size = 20/.pt),
    legend.text = element_text(size = 16/.pt),
    legend.justification=c(0,1), legend.position=c(0,1)
  )

# - latitudinal trends
b <- ggplot(ses_div_centroids, aes(x = latitude, y = richness)) +
  geom_point(color = "grey50", shape = 1 ) +
  geom_smooth(se = FALSE) +
  xlim(ja_lat_min, ja_lat_max) +
  coord_flip() +
  labs(y = "No. taxa") +
  trend_line_theme()

a + b + plot_layout(widths = c(3,1), heights = c(1,1))

ggsave(here::here("presentations/bsj_2020-09-19/richness.png"), height = 6, width = 10, units = "in")
```

.footnote[Trendline: General additive model (GAM) with cubic splines]

---
class: big-margin
## 系統樹を使った生物多様性の測り方

.center[
<img src="images/pd.png" alt="drawing" height="250"/>
]

<u>**P**</u>hylogenetic <u>**D**</u>iversity: 系統樹の枝長の総計 `r AutoCite(bib, "Faith1992")`

<u>**F**</u>unctional <u>**D**</u>iversity: 測り方はPDと同様が、系統樹の代わりに形態的特徴によるdendrogramを使う `r AutoCite(bib, "Petchey2002")`

---
## PDとFDは種数と相関している

```{r raw-div-1, out.width = "120%", fig.asp = 0.7}
# Richness
a <- ggplot(biodiv_ferns_spatial, aes(fill = richness)) +
  geom_sf(color = "transparent") +
  scale_fill_scico(palette = "lajolla") +
  labs(title = "Taxonomic richness") +
  simple_map_theme()

b <- ggplot(biodiv_ferns_spatial, aes(fill = pd_obs)) +
  geom_sf(color = "transparent") +
  scale_fill_scico(palette = "lajolla") +
  labs(
    title = "Phylogenetic diversity") +
  simple_map_theme()

c <- ggplot(biodiv_ferns_spatial, aes(fill = fd_obs)) +
  geom_sf(color = "transparent") +
  scale_fill_scico(palette = "lajolla") +
  labs(
    title = "Functional diversity") +
  simple_map_theme()

a + b + c +
  plot_spacer() + plot_spacer() + plot_spacer() +
  plot_layout(nrow = 2, heights = c(0.5, 0.5))
```

---
## PDとFDは種数と相関している（予想通りに）

```{r raw-div-2, out.width = "120%", fig.asp = 0.7}
# Richness
a <- ggplot(biodiv_ferns_spatial, aes(fill = richness)) +
  geom_sf(color = "transparent") +
  scale_fill_scico(palette = "lajolla") +
  labs(title = "Taxonomic richness") +
  simple_map_theme()

b <- ggplot(biodiv_ferns_spatial, aes(fill = pd_obs)) +
  geom_sf(color = "transparent") +
  scale_fill_scico(palette = "lajolla") +
  labs(
    title = "Phylogenetic diversity") +
  simple_map_theme()

c <- ggplot(biodiv_ferns_spatial, aes(fill = fd_obs)) +
  geom_sf(color = "transparent") +
  scale_fill_scico(palette = "lajolla") +
  labs(
    title = "Functional diversity") +
  simple_map_theme()

d <- ggplot(biodiv_ferns_spatial, aes(x = richness, y = pd_obs)) +
  geom_point(shape = 1) +
  # Fit a logarithmic general additive model
  # https://stackoverflow.com/questions/40711980/r-ggplot2-fit-curve-to-scatter-plot
  geom_smooth(se = FALSE, method = "gam", formula = y ~ s(log(x)), size = 0.5) +
  labs(
    x = "No. taxa",
    y = "PD"
  ) +
  jntools::standard_theme()

e <- ggplot(biodiv_ferns_spatial, aes(x = richness, y = fd_obs)) +
  geom_point(shape = 1) +
  geom_smooth(se = FALSE, method = "gam", formula = y ~ s(log(x)), size = 0.5) +
  labs(
    x = "No. taxa",
    y = "FD"
  ) +
  jntools::standard_theme()

a + b + c +
  plot_spacer() + d + e +
  plot_layout(nrow = 2, heights = c(0.5, 0.5))
```

.footnote[Trendline: GAM with log-transform]

---
class: big-margin

## 観測値とランダムな値との比較

"Independent Swap" `r AutoCite(bib, "Gotelli2000")`によって999個のランダムな群衆を作成し、観察された値と比較する

p-valueによって意義を評価する

---

## PDは本州に低く、琉球に高い

```{r pd-rand, out.width = "120%", fig.asp = 0.7}
ggplot() +
  geom_sf(data = japan, fill = "grey90", color = "black", lwd = 0.25) +
  geom_sf(data = biodiv_ferns_spatial, aes(fill = pd_signif), color = "transparent", alpha = 0.8) +
  scale_fill_manual(values = signif_cols) +
  labs(fill = "Phylogenetic diversity<br>*p*-value") +
  map_theme() +
  theme(
    legend.title = element_markdown(),
    legend.position = "right"
  )
```

---
background-position: 40% 50%
background-image: url(images/RPD.png)
background-size: contain

## <u>**R**</u>elative <u>**P**</u>hylogenetic <u>**D**</u>iversityで枝長を比較する

.pull-right[
有意義に長い枝

- レフュージア

- 対象地域以外に主な分布をもつ分類群の存在

有意義に短い枝

- 最近の種分化

.small[Mishler et al. (2014) `r NoCite(bib, "Mishler2014")`]
]

---
## 系統樹の枝は九州に短く、南北に長い

```{r rpd-rand, out.width = "120%", fig.asp = 0.7}
ggplot() +
  geom_sf(data = japan, fill = "grey90", color = "black", lwd = 0.25) +
  geom_sf(data = biodiv_ferns_spatial, aes(fill = rpd_signif), color = "transparent", alpha = 0.8) +
  scale_fill_manual(values = signif_cols) +
  labs(fill = "Relative<br>phylogenetic diversity<br>*p*-value") +
  map_theme() +
  theme(
    legend.title = element_markdown(),
    legend.position = "right"
  )
```

---
## 機能的形質は系統的多様性と似ている

```{r rfd-rand, out.width = "120%", fig.asp = 0.7}
ggplot() +
  geom_sf(data = japan, fill = "grey90", color = "black", lwd = 0.25) +
  geom_sf(data = biodiv_ferns_spatial, aes(fill = rfd_signif), color = "transparent", alpha = 0.8) +
  scale_fill_manual(values = signif_cols) +
  labs(fill = "Relative<br>functional diversity<br>*p*-value") +
  map_theme() +
  theme(
    legend.title = element_markdown(),
    legend.position = "right"
  )
```

---
## 琉球と小笠原は固有種のホットスポット

```{r pe, out.width = "120%", fig.asp = 0.7}
biodiv_ferns_spatial_simple_endem <-
  biodiv_ferns_spatial %>%
  mutate(endem_type = case_when(
    endem_type == "super" ~ "mixed",
    TRUE ~ as.character(endem_type)
  )) %>%
  mutate(endem_type = factor(endem_type, levels = c("neo", "paleo", "mixed", "not significant")))

# CANAPE
canape_cols_simple <-
  c(
    "neo" = "#e31a1c",
    "paleo" = "#1f78b4",
    "mixed" = "#6a51a3",
    "not significant" = "#ffffcc"
  )

ggplot() +
  geom_sf(data = japan, fill = "grey90", color = "black", lwd = 0.25) +
  geom_sf(data = biodiv_ferns_spatial_simple_endem, aes(fill = endem_type), color = "transparent", alpha = 0.8) +
  scale_fill_manual(values = canape_cols) +
  labs(fill = "Endemism type") +
  map_theme() +
  theme(
    legend.title = element_markdown(),
    legend.position = "right"
  )

ggsave(here::here("presentations/bsj_2020-09-19/canape_simple.png"), height = 6, width = 6, units = "in")

```

---
class: middle, inverse, big-margin

# 生物多様性がどのような構造を持っているのか？

---
## バイオリージョンをクラスター法で分類する

.center[
<img src="images/daru_2017.png" alt="drawing" height="400"/>
]

.footnote[`r Citet(bib, c("Daru2017", "Daru2020"))`]

---
## 主なバイオリージョンが四つある

```{r tax-bioregion, out.width = "120%", fig.asp = 0.7}
ggplot() +
  geom_sf(data = japan, fill = "grey90", color = "black", lwd = 0.25) +
  geom_sf(data = biodiv_ferns_spatial, aes(fill = taxonomic_cluster), color = "transparent", alpha = 0.8) +
  labs(fill = "Taxonomic<br>bioregion") +
  scale_fill_manual(values = bioregion_cols) +
  map_theme() +
  theme(
    legend.title = element_markdown(),
    legend.position = "right"
  )
```

---
系統的距離を使うと琉球と小笠原が一つのバイオリージョンになる

```{r phy-bioregion, out.width = "120%", fig.asp = 0.7}
ggplot() +
  geom_sf(data = japan, fill = "grey90", color = "black", lwd = 0.25) +
  geom_sf(data = biodiv_ferns_spatial, aes(fill = phylo_cluster), color = "transparent", alpha = 0.8) +
  labs(fill = "Phylogenetic<br>bioregion") +
  scale_fill_manual(values = bioregion_cols) +
  map_theme() +
  theme(
    legend.title = element_markdown(),
    legend.position = "right"
  )
```

---
background-position: 50% 50%
background-image: url(images/species-background-1.png)
background-size: contain

## 主なバイオリージョンが四つある

```{r find-top-species}
# Extract clusters
clusters <-
  biodiv_ferns_spatial %>%
  as_tibble() %>%
  select(site = "grids", cluster = phylo_cluster, -geometry)

# Convert community df to long format
comm_ferns_long <-
  comm_ferns %>%
  rownames_to_column("site") %>%
  pivot_longer(names_to = "taxon", values_to = "abun", -site)

# Find top-scoring species (with high occurrence inside one cluster, and low elsewhere)
top_species <-
  comm_ferns_long %>%
  left_join(clusters, by = "site") %>%
  filter(cluster %in% 1:4) %>%
  group_by(taxon, cluster) %>%
  summarize(
    abun = sum(abun),
    total = n()
  ) %>%
  mutate(
    # percent abundance within a bioregion
    perc_abun = abun / total
  ) %>%
  arrange(taxon, desc(perc_abun)) %>%
  select(taxon, cluster, perc_abun) %>%
  group_by(taxon) %>%
  # take top two highest percent abundances per species, calculate their difference
  slice_max(n = 2, order_by = perc_abun, .preserve = TRUE, with_ties = FALSE) %>%
  mutate(
    top_cluster = cluster[perc_abun == max(perc_abun)]
  ) %>%
  summarize(
    max_dif = max(perc_abun) - min(perc_abun),
    cluster = unique(top_cluster)
  ) %>%
  # keep only those with greater than 65% difference between top 1st and 2nd
  # most abundant bioregions
  filter(max_dif > 0.5) %>%
  group_by(cluster) %>%
  # Choose top three per cluster for plotting
  slice_max(n = 3, order_by = max_dif, with_ties = FALSE) %>%
  # Add name in Japanese
  left_join(select(green_list, taxon, taxon_id), by = "taxon") %>%
  left_join(green_list_ja, by = "taxon_id")
```

```{r plot-top-species-prep}
# make helper function to plot top-scoring species
plot_top_taxon <- function (taxon_select, taxon_print, biodiv_ferns_spatial, comm_ferns_long) {
biodiv_ferns_spatial %>%
  left_join(
    filter(comm_ferns_long, taxon == taxon_select),
    by = c(grids = "site")
  ) %>%
  mutate(abun = factor(abun)) %>%
  ggplot(aes(fill = abun)) +
  scale_fill_manual(values = c("#404040", "#d01c8b")) +
  geom_sf(color = "transparent") +
  labs(subtitle = taxon_print) +
  simple_map_theme_light() +
  theme(plot.subtitle = element_text(family = "HiraKakuPro-W3"))
}
```

```{r plot-top-species-cluster-1, out.width = "120%", fig.asp = 0.65}
focus_region <-
biodiv_ferns_spatial %>%
  mutate(focus = ifelse(taxonomic_cluster == 1, "yes", "no")) %>%
ggplot(aes(fill = taxonomic_cluster, alpha = focus)) +
  geom_sf(color = "transparent") +
  scale_fill_carto_d(name = "Cluster", type = "qualitative", palette = "Bold") +
  scale_alpha_manual(values = c(yes = 1, no = 0.25)) +
  scale_y_continuous(labels = scales::label_number(suffix = "\u00b0N", accuracy = 1)) +
  scale_x_continuous(labels = scales::label_number(suffix = "\u00b0E", accuracy = 1)) +
  simple_map_theme_light() +
  labs(subtitle = "Region 1")

focus_region +
plot_top_taxon(top_species$taxon[[1]], taxon_print = top_species$name_ja[[1]], biodiv_ferns_spatial, comm_ferns_long) +
plot_top_taxon(top_species$taxon[[2]], taxon_print = top_species$name_ja[[2]], biodiv_ferns_spatial, comm_ferns_long) +
plot_top_taxon(top_species$taxon[[3]], taxon_print = top_species$name_ja[[3]], biodiv_ferns_spatial, comm_ferns_long) +
plot_layout(ncol = 2, nrow = 2)

ggsave(here::here("presentations/bsj_2020-09-19/plot-top-species-cluster-1.png"), height = 6, width = 6, units = "in")

# One species per region
plot_top_taxon(top_species$taxon[[2]], taxon_print = top_species$name_ja[[2]], biodiv_ferns_spatial, comm_ferns_long) + 
plot_top_taxon(top_species$taxon[[4]], taxon_print = top_species$name_ja[[4]], biodiv_ferns_spatial, comm_ferns_long) + 
plot_top_taxon(top_species$taxon[[7]], taxon_print = top_species$name_ja[[7]], biodiv_ferns_spatial, comm_ferns_long) +
plot_layout(ncol = 2, nrow = 2)

ggsave(here::here("presentations/bsj_2020-09-19/plot-top-species-one-each-phylo.png"), height = 6, width = 6, units = "in")
```

.footnote[`r NoCite(bib, c("Ebihara2016b", "Ebihara2017"))`]

---
background-position: 50% 50%
background-image: url(images/species-background-2.png)
background-size: contain

## 主なバイオリージョンが四つある

```{r plot-top-species-cluster-2, out.width = "120%", fig.asp = 0.65}
focus_region <-
biodiv_ferns_spatial %>%
  mutate(focus = ifelse(taxonomic_cluster == 2, "yes", "no")) %>%
ggplot(aes(fill = taxonomic_cluster, alpha = focus)) +
  geom_sf(color = "transparent") +
  scale_fill_carto_d(name = "Cluster", type = "qualitative", palette = "Bold") +
  scale_alpha_manual(values = c(yes = 1, no = 0.25)) +
  scale_y_continuous(labels = scales::label_number(suffix = "\u00b0N", accuracy = 1)) +
  scale_x_continuous(labels = scales::label_number(suffix = "\u00b0E", accuracy = 1)) +
  simple_map_theme_light() +
  labs(subtitle = "Region 2")

focus_region +
plot_top_taxon(top_species$taxon[[4]], taxon_print = top_species$name_ja[[4]], biodiv_ferns_spatial, comm_ferns_long) +
plot_top_taxon(top_species$taxon[[5]], taxon_print = top_species$name_ja[[5]], biodiv_ferns_spatial, comm_ferns_long) +
plot_top_taxon(top_species$taxon[[6]], taxon_print = top_species$name_ja[[6]], biodiv_ferns_spatial, comm_ferns_long) +
plot_layout(ncol = 2, nrow = 2)

ggsave(here::here("presentations/bsj_2020-09-19/plot-top-species-cluster-2.png"), height = 6, width = 6, units = "in")
```

.footnote[`r NoCite(bib, c("Ebihara2016b", "Ebihara2017"))`]

---
background-position: 50% 50%
background-image: url(images/species-background-3.png)
background-size: contain

## 主なバイオリージョンが四つある

```{r plot-top-species-cluster-3, out.width = "120%", fig.asp = 0.65}
focus_region <-
biodiv_ferns_spatial %>%
  mutate(focus = ifelse(taxonomic_cluster == 3, "yes", "no")) %>%
ggplot(aes(fill = taxonomic_cluster, alpha = focus)) +
  geom_sf(color = "transparent") +
  scale_fill_carto_d(name = "Cluster", type = "qualitative", palette = "Bold") +
  scale_alpha_manual(values = c(yes = 1, no = 0.25)) +
  scale_y_continuous(labels = scales::label_number(suffix = "\u00b0N", accuracy = 1)) +
  scale_x_continuous(labels = scales::label_number(suffix = "\u00b0E", accuracy = 1)) +
  simple_map_theme_light() +
  labs(subtitle = "Region 3")

focus_region +
plot_top_taxon(top_species$taxon[[7]], taxon_print = top_species$name_ja[[7]], biodiv_ferns_spatial, comm_ferns_long) +
plot_top_taxon(top_species$taxon[[8]], taxon_print = top_species$name_ja[[8]], biodiv_ferns_spatial, comm_ferns_long) +
plot_top_taxon(top_species$taxon[[9]], taxon_print = top_species$name_ja[[9]], biodiv_ferns_spatial, comm_ferns_long) +
plot_layout(ncol = 2, nrow = 2)

ggsave(here::here("presentations/bsj_2020-09-19/plot-top-species-cluster-3.png"), height = 6, width = 6, units = "in")
```

.footnote[`r NoCite(bib, c("Ebihara2016b", "Ebihara2017"))`]

---
background-position: 50% 50%
background-image: url(images/species-background-4.png)
background-size: contain

## 主なバイオリージョンが四つある

```{r plot-top-species-cluster-4, out.width = "120%", fig.asp = 0.65}
bonin_box <-
biodiv_ferns_spatial %>%
  filter(taxonomic_cluster == 4) %>%
  sf::st_bbox()

expand_value <- 0.4

focus_region <-
biodiv_ferns_spatial %>%
  mutate(focus = ifelse(taxonomic_cluster == 4, "yes", "no")) %>%
ggplot(aes(fill = taxonomic_cluster, alpha = focus)) +
  geom_sf(color = "transparent") +
  scale_fill_carto_d(name = "Cluster", type = "qualitative", palette = "Bold") +
  scale_alpha_manual(values = c(yes = 1, no = 0.25)) +
  scale_y_continuous(labels = scales::label_number(suffix = "\u00b0N", accuracy = 1)) +
  scale_x_continuous(labels = scales::label_number(suffix = "\u00b0E", accuracy = 1)) +
  simple_map_theme_light() +
  labs(subtitle = "Region 4") +
  annotate(
    "rect",
           xmin = bonin_box[["xmin"]] - expand_value,
           xmax = bonin_box[["xmax"]] + expand_value,
           ymin = bonin_box[["ymin"]] - expand_value,
           ymax = bonin_box[["ymax"]] + expand_value,
    fill = "transparent",
    color = "grey10")

focus_region +
plot_top_taxon(top_species$taxon[[10]], taxon_print = top_species$name_ja[[10]], biodiv_ferns_spatial, comm_ferns_long) +
plot_top_taxon(top_species$taxon[[12]], taxon_print = top_species$name_ja[[12]], biodiv_ferns_spatial, comm_ferns_long) +
plot_top_taxon(top_species$taxon[[11]], taxon_print = top_species$name_ja[[11]], biodiv_ferns_spatial, comm_ferns_long) +
plot_layout(ncol = 2, nrow = 2)

ggsave(here::here("presentations/bsj_2020-09-19/plot-top-species-cluster-4.png"), height = 6, width = 6, units = "in")
```

.footnote[`r NoCite(bib, c("Ebihara2016b", "Ebihara2017"))`]

---
## バイオリージョンは従来の植生帯と概ね一致

.pull-left[
Taxonomic bioregions

```{r tax-bioregion-forest}
ggplot(biodiv_ferns_spatial, aes(fill = taxonomic_cluster)) +
  geom_sf(color = "transparent") +
  scale_fill_carto_d(name = "Cluster", type = "qualitative", palette = "Bold") +
  scale_y_continuous(labels = scales::label_number(suffix = "\u00b0N", accuracy = 1)) +
  scale_x_continuous(labels = scales::label_number(suffix = "\u00b0E", accuracy = 1)) +
  map_theme_pp_light() +
  theme(legend.position = "none")
```
]

.pull-right[
植生帯<br>
.small[`r Citet(bib, "Shimizu2014")`<br><br>]
<img src="images/forest_types_eng.png" alt="drawing" width="280"/>
]


---
class: middle, inverse, big-margin

# 生物多様性はどれくらい守られているのか？


---
class: middle, inverse, big-margin

# How well is biodiversity protected?

---
## 日本は一般的によく守られている（平均30%）

```{r protected-areas-graph}
# Calculate the total area of Japan
area_of_japan <- 377900

# Calculate baseline protection percentage: percent protected areas across the whole country
total_percent_protected <-
  protected_areas %>%
  as_tibble() %>%
  select(-geometry) %>%
  filter(status %in% c("medium", "high")) %>%
  group_by(status) %>%
  summarize(
    total_area = sum(area),
    .groups = "drop"
  ) %>%
  mutate(percent_protected = total_area/area_of_japan) %>%
  mutate(percent_protected = as.numeric(percent_protected))

# Extract values for medium and high protection level
total_percent_protected_medium <- total_percent_protected %>% filter(status == "medium") %>% pull(percent_protected)
total_percent_protected_high <- total_percent_protected %>% filter(status == "high") %>% pull(percent_protected)
total_percent_protected_all <- sum(total_percent_protected_medium, total_percent_protected_high)

show_col(viridis_pal(option = "D")(3))

protection_cols <- c(
  Medium = "#21908CFF",
  High = "#FDE725FF"
)

# Plot protected areas
signif_cells_protected_area %>%
  mutate(
    metric = case_when(
      metric == "pd" ~ "PD",
      metric == "fd" ~ "FD",
      metric == "pe" ~ "PE",
      metric == "richness" ~ "Richness",
    ),
    status = str_to_sentence(status)) %>%
  mutate(metric = factor(metric, levels = c("PE", "FD", "PD", "Richness"))) %>%
  ggplot(aes(x = percent_protected, y = metric, fill = status)) +
  geom_col(position = position_dodge()) +
  geom_vline(xintercept = total_percent_protected_medium, color = "grey40", linetype = 3) +
  geom_vline(xintercept = total_percent_protected_high, color = "grey40", linetype = 2) +
  scale_fill_manual(values = protection_cols) +
  scale_x_continuous(labels = scales::percent) +
  labs(
    x = "Percent protected",
    y = "Biodiversity metric",
    fill = "Conservation\nstatus"
  ) +
  theme_bw(base_size = 18) +
  theme(
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank(),
    legend.position = "right"
  )

ggsave(here::here("presentations/bsj_2020-09-19/protected_bar.png"), height = 6, width = 8, units = "in")
```
