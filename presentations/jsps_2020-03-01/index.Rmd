---
output:
  xaringan::moon_reader:
    css: ["default-fonts", "default", "custom.css"]
    lib_dir: libs
    mathjax: default
    seal: false
    nature:
      slideNumberFormat: "" # To turn off slide numbers
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
      titleSlideClass: ["left", "middle", "inverse"]
editor_options:
  chunk_output_type: console
---
class: inverse, middle, title-slide, big-margin
background-color: #000000
background-position: 50% 50%
background-image: url(images/title_background.png)
background-size: contain

# 日本のシダ植物多様性の<br>多次元解析
<br>
## 新田ジョエル<sup>1</sup>、海老原淳<sup>2</sup>

<sup>1</sup>スミソニアン国立自然史博物館・植物研究部<br>
<span style = 'font-size: 80%;'>https://joelnitta.com</span>

<sup>2</sup>国立科学博物館・植物研究部

日本植物分類学会第19回大会<br><span style = 'font-size: 80%;'>2020.03.01</span>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, include = TRUE, eval = TRUE, cache = TRUE, dev = "svg")
```

```{r load-packages, cache = FALSE}
library(magick)
library(ggtext)
library(drake)
library(knitr)
library(patchwork)
library(scales)
library(scico)
library(magrittr)
library(broom)
library(assertr)
library(sf)
library(tidyverse)
```

```{r load-data, cache = FALSE}
# Set cache
ja_fern_cache <- new_cache(here::here("ja_fern_cache"))

source(here::here("code/functions.R"))

# Load targets
loadd(list = c(
  "taxon_id_map",
  "all_cells",
  "alpha_div_ferns",
  "occ_data_ferns",
  "occ_point_data_raw",
  "ja_bioregions_ferns",
  "biodiv_results_ferns",
  "species_motifs_ferns_6L",
  "percent_sex_dip_ferns",
  "repro_data"),
  cache = ja_fern_cache)

```

```{r alpha-div-ferns-prep}
# Add ecostructure motif scores and canape results to alpha diversity,
# filter out a single location south of 21 lat that had no ferns
alpha_div_ferns <-
  species_motifs_ferns_6L$omega %>%
  as.data.frame %>%
  rownames_to_column("site") %>%
  as_tibble %>%
  separate(site, c("longitude", "latitude"), sep = "_") %>%
  left_join(
    mutate_at(alpha_div_ferns, vars(longitude, latitude), as.character),
    by = c("longitude", "latitude")) %>%
  left_join(
    mutate_at(biodiv_results_ferns, vars(longitude, latitude), as.character),
    by = c("longitude", "latitude")) %>%
  mutate_at(vars(longitude, latitude), as.numeric) %>%
  # Make canape 'NA' an explicit factor level
  mutate(canape = forcats::fct_explicit_na(canape, "NA")) %>%
  rename_at(vars(1:6 %>% as.character), ~paste0("motif_", .)) %>%
  filter(latitude > 21)
```

```{r title-slide-image, eval = FALSE}
# Code to make title slide image, don't need to run when rendering slides

a <- make_diversity_map(
  div_data = alpha_div_ferns,
  occ_data = occ_data_ferns,
  div_metric = "richness",
  metric_title = "No. species ",
  label = "Richness") +
  scale_fill_viridis_c() +
  theme_void() +
  theme(
    plot.title = element_blank(),
    plot.subtitle = element_blank(),
    legend.position = "none",
     panel.background = element_rect(fill = "black"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
  )

ggsave(plot = a, here::here("presentations/jsps_2020-03-01/images/title_slide_part_a.png"))

b <- make_diversity_map(
  div_data = alpha_div_ferns,
  occ_data = occ_data_ferns,
  div_metric = "phy_mpd_obs_z",
  metric_title = "MPD",
  label = "Mean Phylogenetic Distance") +
  scale_fill_scico(
    palette = "vik",
    na.value="dark grey",
    limits = c(
      -get_limit(alpha_div_ferns, phy_mpd_obs_z, "abs", 3),
      get_limit(alpha_div_ferns, phy_mpd_obs_z, "abs", 3)
    )) +
  scale_y_continuous(
    labels = scales::label_number(suffix = "\u00b0N", accuracy = 1),
    limits = c(24, 46)) +
  theme_void() +
  theme(
    plot.title = element_blank(),
    plot.subtitle = element_blank(),
    legend.position = "none",
     panel.background = element_rect(fill = "black"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
  )

ggsave(plot = b, here::here("presentations/jsps_2020-03-01/images/title_slide_part_b.png"))

```

---
class: big-margin

## 生物多様性は危機にさらされている

- 地球温暖化をはじめ、人間の活動によって生物多様性が失われている

- 保全対策が必要

---
class: big-margin

## 生物多様性の保全には、まずその分布を理解する必要がある

- 今まで生物多様性は主に種数だけで計れてきた

- しかし、生物多様性には様々な側面（次元）がある

 - 系統的多様性
 
 - 機能的多様性
 
 - など

---
class: big-margin

## 日本のシダ植物

.pull-left[
- どの国よりも豊富なサンプリング

- 日本シダの会の動力の甲斐

- 生物多様性の多次元解析の最適？
]

.pull-right[
```{r gbif-colls-per-country}
# Read in pteridophyte GBIF collections per country data from
# Iwasaki lab presentation
collections_by_country <- read_csv(here::here("data_raw/gbif_pterido_coll_by_country.csv")) %>%
  mutate(country = factor(country)) %>%
  mutate(country = fct_reorder(country, n))

# Plot showing top 10
ggplot(collections_by_country, aes(x = country, y = n)) +
  geom_col() +
  coord_flip() +
  labs(
    title = "GBIF pteridophyte \ncollections (top 10)",
    y = "No. collections") +
  scale_y_continuous(labels = scales::comma) +
  ggplot2::theme_bw(base_size = 24) +
  theme(
    axis.title.y = element_blank(),
    panel.grid.minor = ggplot2::element_blank(),
    panel.grid.major.y = ggplot2::element_blank(),
      axis.text.x = ggplot2::element_text(colour="black"),
      axis.text.y = ggplot2::element_text(colour="black")
  )
```
]


---
class: big-margin

## 日本のシダ植物

.pull-left[
- どの国よりも豊富なサンプリング

- 日本シダの会の動力の甲斐

- 生物多様性の多次元解析の最適？
]

.pull-right[
```{r ja-pterido-coll-curve}
# Format pteridophyte abundances (no hybrids) as numeric vector
pterido_abun <-
occ_point_data_raw %>%
  group_by(species) %>%
  count(sort = TRUE) %>%
  pull(n)

# Run iNEXT
inext_out <- iNEXT::iNEXT(pterido_abun, q=0, datatype="abundance")

# create subset of observed points to add to plot as dots
observed_data <- inext_out$iNextEst[inext_out$iNextEst$method == "observed",]

# Make iNEXT plot
inext_out$iNextEst %>%
  filter(m < 500000) %>%
  ggplot(aes(x=m, y=qD)) +
  geom_ribbon(aes(ymin = qD.LCL, ymax = qD.UCL), fill = "grey70", alpha=0.2) +
  geom_line(aes(linetype=method), size=0.8) +
  scale_linetype_manual(values=c("dotted", "solid", "solid")) +
  geom_point(data=observed_data, size=5) +
  scale_y_continuous("No. spp.") +
  scale_x_continuous("No. collections") +
  labs(
    title = "Species collection curve",
    subtitle = "Japanese pteridophytes (no hybrids)"
  ) +
  ggplot2::theme_bw(base_size = 24) +
  theme(
    axis.title.y = element_blank(),
    panel.grid.minor = ggplot2::element_blank(),
    axis.text.x = ggplot2::element_text(colour="black"),
    axis.text.y = ggplot2::element_text(colour="black"),
    legend.position="bottom", 
    legend.title=element_blank()
    )

```
]

---
class: big-margin

## 本研究の目的

**日本産シダ類** において

- 多様性を複数の次元から把握すること

- 生態的構造を検討すること

- 以上のパターンを生み出している要素を探ること

---
class: big-margin


```{r calc-species-num}
# Count number of fern species, no hybrids

# Inner-join fern occurrence data (incl. hybrids)
# with repro data (no hybrids)
n_ferns_no_hybrids <-
occ_data_ferns %>%
  select(taxon_id) %>%
  unique %>%
  inner_join(repro_data) %>%
  pull(taxon_name) %>%
  n_distinct()

```

## データ

- 日本産シダ類の採取データ

  - `r nrow(occ_data_ferns) %>% scales::comma()`点
  
  - `r n_ferns_no_hybrids` 種類（雑種を除く）

- 系統樹 (*rbcL*)

- 形態的特徴

- 気候データ

.footnote[Ebihara and Nitta. 2019. *Journal of Plant Research* 132:723–738]

---

## 屋久島は種数の頂点

```{r richness-plot, out.width = "120%", fig.asp = 0.7}
# Fern richness
# - map
a <- make_diversity_map(
  div_data = alpha_div_ferns,
  occ_data = occ_data_ferns,
  div_metric = "richness",
  metric_title = "No. species ",
  label = "Richness") +
  scale_fill_viridis_c() +
  scale_y_continuous(
    labels = scales::label_number(suffix = "\u00b0N", accuracy = 1),
    limits = c(24, 46)) +
  theme(
    plot.subtitle = element_blank())

# - line tracking mean richness
alpha_div_ferns_binned <-
  alpha_div_ferns %>%
  mutate(
    latitude = cut_width(latitude, width = 0.1, closed = "left") %>%
      str_split(",") %>%
      map_chr(1) %>%
      parse_number) %>%
  group_by(latitude) %>%
  summarize_at(
    vars(richness, phy_mpd_obs_z, func_mpd_obs_z), mean, na.rm = TRUE
  )

b <-
  ggplot(alpha_div_ferns_binned, aes(y = latitude, x = richness)) +
  geom_path() +
  labs(
    x = "No. species"
  ) +
  ylim(24, 46) +
  theme(
    panel.background = element_blank(),
    panel.grid.major = element_line(size = 0.1, color = "dark grey"),
    panel.grid.minor = element_blank(),
    axis.title.y = element_blank(),
    axis.ticks.y = element_blank(),
    axis.ticks.x = element_blank(),
    axis.text.y = element_blank()
  )

a + b + plot_layout(widths = c(3,1))
```

---
class: big-margin

## 系統的多様性

- Mean phylogenetic distance (MPD): ある地点に生育する種の**平均的系統距離**

- 生値をランダムな分布と比較して、ランダムより高いか、低いか、解析する

.footnote[Webb, et al. 2002. *Annual Review of Ecology and Systematics* 33:475–505.]

---

## 系統的多様性は南北に高い

```{r mpd-plot, out.width = "120%", fig.asp = 0.7}
# Phylogenetic diversity (MPD)
# - map
a <- make_diversity_map(
  div_data = alpha_div_ferns,
  occ_data = occ_data_ferns,
  div_metric = "phy_mpd_obs_z",
  metric_title = "MPD",
  label = "Mean Phylogenetic Distance") +
  scale_fill_scico(
    palette = "vik",
    na.value="dark grey",
    limits = c(
      -get_limit(alpha_div_ferns, phy_mpd_obs_z, "abs", 3),
      get_limit(alpha_div_ferns, phy_mpd_obs_z, "abs", 3)
    )) +
  scale_y_continuous(
    labels = scales::label_number(suffix = "\u00b0N", accuracy = 1),
    limits = c(24, 46)) +
  theme(
    plot.subtitle = element_blank())

# line tracking mean MPD
b <- ggplot(
  alpha_div_ferns_binned,
  aes(y = latitude, x = phy_mpd_obs_z)) +
  geom_path() +
  scale_y_continuous(
    labels = scales::label_number(suffix = "\u00b0N", accuracy = 1),
    position = "right") +
  labs(
    subtitle = "",
    x = "MPD"
  ) +
  annotate(
    "segment",
    x = 0, xend = 0,
    y = -Inf, yend = Inf,
    linetype = 2) +
  ylim(24, 46) +
  theme(
    panel.background = element_blank(),
    panel.grid.major = element_line(size = 0.1, color = "dark grey"),
    panel.grid.minor = element_blank(),
    axis.title.y = element_blank(),
    axis.ticks.y = element_blank(),
    axis.ticks.x = element_blank(),
    axis.text.y = element_blank()
  )

a + b + plot_layout(widths = c(3,1))
```
---
class: big-margin

## Categorical Analyses of Neo- and Paleo-Endemism (CANAPE)

- 分布域が狭く、系統樹の枝が短い：Neoendemic

- 分布域が狭く、系統樹の枝が長い：Paleoendemic

- 両方混じっている地域：Mixed

- 生値をランダムな分布と比較して、ランダムと有意義な差があれば**固有地域**として認める

.footnote[Mishler, et al. 2014. *Nature Communications* 5:4473]

---

## 南の島々は固有種が多い

```{r canape-plot, out.width = "120%", fig.asp = 0.7}
canape_cols <- RColorBrewer::brewer.pal(4, "Set1") %>%
  c(., "grey80") %>%
  set_names(c("neo", "palaeo", "super", "mixed", "NA"))

biodiv_results_ferns %>%
  mutate(canape = fct_relevel(canape, "palaeo", "mixed", "neo")) %>%
ggplot(aes(x = longitude, y = latitude, fill = canape)) +
  geom_tile() +
  coord_quickmap(
    xlim = c(pull(occ_data_ferns, longitude) %>% min %>% floor,
             pull(occ_data_ferns, longitude) %>% max %>% ceiling),
    ylim = c(pull(occ_data_ferns, latitude) %>% min %>% floor,
             pull(occ_data_ferns, latitude) %>% max %>% ceiling)
  ) +
  scale_fill_manual(values = canape_cols, na.value = "grey80") +
    scale_y_continuous(labels = scales::label_number(suffix = "\u00b0N", accuracy = 1)) +
    scale_x_continuous(labels = scales::label_number(suffix = "\u00b0E", accuracy = 1)) +
  labs(fill = "Endemism") +
  theme(
    panel.background = element_blank(),
      panel.grid.major = element_line(size = 0.1, color = "dark grey"),
      panel.grid.minor = element_blank(),
      axis.title = element_blank(),
    axis.ticks = element_blank()
  )
```

---

## Neoendemicな地域は有性生殖・二倍体種が多い

<br>

.center[
```{r canape-sex, fig.asp = 0.7}
# Run analysis of variance (AOV) on
# endemism type by reproductive mode.
canape_by_repro_model <- aov(
  percent_sex_dip ~ canape,
  data = alpha_div_ferns)

# Inspect results:

# - p-value
# tidy(canape_by_repro_model)

# - AOV of endemism type by reproductive mode
# showed a significant difference, so
# run Tukey HSD test on results.
# TukeyHSD(canape_by_repro_model) %>% tidy

# Assign tukey groups for plotting
tukey_groups <-
    multcomp::glht(
    canape_by_repro_model, 
    linfct = multcomp::mcp(canape = "Tukey")) %>%
    multcomp::cld() %>%
    purrr::pluck("mcletters", "Letters") %>%
    tibble(canape = names(.), group = .) %>%
    mutate(
      y_pos = 1.1
    )

alpha_div_ferns %>%
  group_by(canape) %>%
  summarize(
    mean_sex_dip = mean(percent_sex_dip, na.rm = TRUE),
    sd_sex_dip = sd(percent_sex_dip, na.rm = TRUE)
  ) %>%
  mutate(
    upper = mean_sex_dip + sd_sex_dip,
    lower = mean_sex_dip - sd_sex_dip
  ) %>%
  mutate(canape = fct_relevel(canape, "palaeo", "mixed", "neo")) %>%
  ggplot(aes(x = canape, y = mean_sex_dip, fill = canape)) +
  geom_col() +
  geom_text(data = tukey_groups, aes(y = y_pos, label = group), color = "black") +
  scale_y_continuous(labels = scales::percent, breaks = c(0, 0.25, 0.5, 0.75, 1.0)) +
  scale_fill_manual(values = canape_cols, na.value = "grey80", guide = FALSE) +
  geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.25) +
  labs(
    x = "Type of endemicity",
    y = "% sexual diploids"
  ) +
  jntools::standard_theme()

```
]

.footnote['a', 'b', 'c' = Tukey's HSDテストによる有意義な差があったグループ]

---
class: big-margin

## 生態的構造

STRUCTURE (Pritchard 2000)と同じようなアルゴリズムで生態的構造を解析する。

STRUCTUREでは、**遺伝子型**のデータから**個体レベル**の遺伝的構造を推定する

Ecostructure (White 2019)では、**種の分布**のデータから**群集レベル**の生態的構造を推定する

.footnote[Pritchard, et al. 2000. *Genetics* 155: 945-959<br>
White, et al. 2019. *Nature Communications* 10:2646.]

---
class: inverse, middle
background-color: #000000

## 日本産シダ類の生態的構造 (*K* = 6)

```{r ecos-map-prep}
# Write out ecostructure plots using modified version of ecos_plot_pie(),
# then crop them to the right size.
# (ggscatterpie is too slow, can't map aesthetics)

# Set a base tweaking factor for easy manipulation of plot size
tweak = 0.5

# Use color brewer "Set1" for the 6 motifs (k=6)
ecos_cols <- RColorBrewer::brewer.pal(6, "Set1")

# Define a function to dim all other colors (using alpha)
# besides the focus color
apply_focus <- function (cols, focus, alpha = 0.15) {
  new_cols <- scales::alpha(cols, alpha)
  new_cols[[focus]] <- cols[[focus]]
  new_cols
}

# Make list of colors to use for writing out plots
cols_list <- purrr::map(1:6, ~apply_focus(ecos_cols, .)) %>%
  c(list(ecos_cols), .) %>%
  set_names(c("all", paste0("focus_", 1:6)))

# Loop over outputting pie plot without basemap
purrr::walk2(
  cols_list,
  names(cols_list),
  ~ecos_plot_pie2(
    omega =  species_motifs_ferns_6L$omega,
    color = .x,
    image_width = 6000*tweak,
    image_height = 4800*tweak,
    radius = 0.05,
    no_map = TRUE,
    blank_bg = "black",
    long_lim = c(122, 146),
    lat_lim = c(24, 46),
    path = here::here(
      glue::glue("presentations/jsps_2020-03-01/images/species_motifs_ferns_{.y}.png")
    )
  )
)

# Define a function to crop ecostructure map plot
crop_ecos_plot <- function (image_path) {

  image_read(image_path) %>%
    # Crops to 2410x2410, starting 525 to the right and 150 down from UL corner
    image_crop("2140x2140+525+150") %>%
    image_write(
      path = image_path %>%
        fs::path_ext_remove() %>%
        paste0("_crop.png")
    )
}

# Loop over plots and crop them
here::here(glue::glue("presentations/jsps_2020-03-01/images/species_motifs_ferns_{names(cols_list)}.png")) %>%
  walk(crop_ecos_plot)
```

```{r ecos-species-prep}
# Make overall dataframe of species contributions to motifs based on theta
species_ranking <-
species_motifs_ferns_6L$theta %>%
  as.data.frame %>%
  rownames_to_column("taxon_id") %>%
  as_tibble %>%
  pivot_longer(-taxon_id, names_to = "motif", values_to = "score") %>%
  left_join(taxon_id_map, by = "taxon_id") %>%
  select(motif, taxon, score) %>%
  mutate(taxon = str_replace_all(taxon, "_", " ")) %>%
  mutate(score = round(score, 2)) %>%
  group_by(taxon) %>%
  mutate(score_sd = sd(score)) %>%
  ungroup

# Define function for making species ranking table
make_species_ranking_table <- function (ranking_data, motif_select, taxon_select = NULL, taxon_include = "", slice_n = 10) {

  ranking_data_sliced <- ranking_data %>%
    filter(motif == motif_select) %>%
    mutate(include = ifelse(taxon %in% taxon_include, 1, 0)) %>%
    # Select top-scoring species with high SD
    # (high SD should indicate mostly contributing to
    # a single motif)
    arrange(desc(include), desc(score), desc(score_sd)) %>%
    slice(1:slice_n) %>%
    select(taxon, score) %>%
    mutate(score = as.factor(score)) %>%
    # Arrange alphabetically within score
    arrange(desc(score), taxon)

  if(is.numeric(taxon_select)) taxon_select <- ranking_data_sliced$taxon[[taxon_select]]

  table <-
    ranking_data_sliced %>%
    gt() %>%
    tab_options(
      row.striping.include_table_body = FALSE,
      row.striping.include_stub = FALSE,
      table.background.color = "#000000",
      column_labels.background.color = "#000000") %>%
    tab_style(
      style = list(
        cell_fill(color = "#000000"),
        cell_text(color = "white", size = "medium")
      ),
      locations = cells_column_labels(columns = everything())
    ) %>%
    tab_style(
      style = list(
        cell_fill(color = "#000000"),
        cell_text(color = "white", size = "small")
      ),
      locations = cells_data(
        columns = everything())
    ) %>%
    tab_style(
      style = list(
        cell_text(style = "italic")
      ),
      locations = cells_data(
        columns = vars(taxon))
    )

  if(!is.null(taxon_select))
    table <-
      table %>%
      tab_style(
        style = list(
          cell_fill(
            color = "red",
            alpha = 1.0
          )
        ),
        locations = cells_data(
          columns = everything(),
          rows = taxon == taxon_select)
      )

  table

}

# Define function to make simple distribution map for a species
plot_distribution <- function (ranking_data, motif_select, taxon_select, occ_data, show_title = FALSE, taxon_include = "") {

   ranking_data <- ranking_data %>%
    filter(motif == motif_select) %>%
    mutate(include = ifelse(taxon %in% taxon_include, 1, 0)) %>%
    arrange(desc(include), desc(score), desc(score_sd)) %>%
    select(taxon, score) %>%
    mutate(score = as.factor(score)) %>%
    arrange(desc(score), taxon)

  if(is.numeric(taxon_select)) taxon_select <- ranking_data$taxon[[taxon_select]]

  cells_present <-
    occ_data %>%
    filter(taxon_name == taxon_select) %>%
    select(secondary_grid_code) %>%
    unique %>%
    mutate(present = TRUE)

  plot_data <-
    occ_data %>%
    select(secondary_grid_code, latitude, longitude) %>%
    left_join(cells_present) %>%
    mutate(present = replace_na(present, FALSE))

  plot <- ggplot(plot_data, aes(x = longitude, y = latitude, fill = present)) +
    geom_tile() +
    coord_quickmap(
      xlim = c(pull(occ_data, longitude) %>% min %>% floor,
               pull(occ_data, longitude) %>% max %>% ceiling),
      ylim = c(pull(occ_data, latitude) %>% min %>% floor,
               pull(occ_data, latitude) %>% max %>% ceiling)
    ) +
    scale_fill_manual(values = c("TRUE" = "red", "FALSE" = "grey80"), na.value = "grey80", guide = FALSE) +
    theme_void()

  if(isTRUE(show_title))
    plot <- plot +
    labs(
      title = taxon_select
    )

  plot
}
```

```{r write_out_motif_maps, eval = FALSE}
# Don't run when making slides, but it's a useful practice to check the
# distributions for the top 10 taxa for each motif
plot_dist_by_motif <- function(species_ranking, motif, occ_data_ferns) {
  dist_maps <- purrr::map(1:10, ~plot_distribution(species_ranking, motif, ., occ_data_ferns, show_title = TRUE)) %>%
    patchwork::wrap_plots(ncol = 2, nrow = 5)

  ggsave(plot = dist_maps, file = glue::glue("motif_{motif}_maps.png"), width = 6, height = 12, units = "in")
}

walk(1:6, ~plot_dist_by_motif(species_ranking, ., occ_data_ferns))
```

.center[<img src="images/species_motifs_ferns_all_crop.png" alt="drawing" height = "600">]

---
class: inverse, middle
background-color: #000000

.pull-left-wide[<img src="images/species_motifs_ferns_focus_1_crop.png" alt="drawing">]

.pull-right-narrow[
```{r ecos-motif-1}
make_species_ranking_table(species_ranking, 1)
```
]

---
class: inverse, middle
background-color: #000000

.pull-left-wide[<img src="images/species_motifs_ferns_focus_1_crop.png" alt="drawing">]

.pull-right-narrow[
```{r ecos-motif-1-focus-3, dev = "png"}
make_species_ranking_table(species_ranking, 1, "Equisetum arvense")
plot_distribution(species_ranking, 1, "Equisetum arvense", occ_data_ferns, show_title = FALSE)
```
]

---
class: inverse, middle
background-color: #000000

.pull-left-wide[<img src="images/species_motifs_ferns_focus_1_crop.png" alt="drawing">]

.pull-right-narrow[
```{r ecos-motif-1-focus-7, dev = "png"}
make_species_ranking_table(species_ranking, 1, "Athyrium vidalii")
plot_distribution(species_ranking, 1, "Athyrium vidalii", occ_data_ferns)
```
]

---
class: inverse, middle
background-color: #000000

.pull-left-wide[<img src="images/species_motifs_ferns_focus_2_crop.png" alt="drawing">]

.pull-right-narrow[
```{r ecos-motif-2}
make_species_ranking_table(species_ranking, 2)
```
]

---
class: inverse, middle
background-color: #000000

.pull-left-wide[<img src="images/species_motifs_ferns_focus_2_crop.png" alt="drawing">]

.pull-right-narrow[
```{r ecos-motif-2-focus-1, dev = "png"}
make_species_ranking_table(species_ranking, 2, "Adiantum pedatum")
plot_distribution(species_ranking, 2, "Adiantum pedatum", occ_data_ferns)
```
]

---
class: inverse, middle
background-color: #000000

.pull-left-wide[<img src="images/species_motifs_ferns_focus_2_crop.png" alt="drawing">]

.pull-right-narrow[
```{r ecos-motif-2-focus-2, dev = "png"}
make_species_ranking_table(species_ranking, 2, "Arachniodes borealis")
plot_distribution(species_ranking, 2, "Arachniodes borealis", occ_data_ferns)
```
]

---
class: inverse, middle
background-color: #000000

.pull-left-wide[<img src="images/species_motifs_ferns_focus_3_crop.png" alt="drawing">]

.pull-right-narrow[
```{r ecos-motif-3}
make_species_ranking_table(species_ranking, 3)
```
]

---
class: inverse, middle
background-color: #000000

.pull-left-wide[<img src="images/species_motifs_ferns_focus_3_crop.png" alt="drawing">]

.pull-right-narrow[
```{r ecos-motif-3-focus-3, dev = "png"}
make_species_ranking_table(species_ranking, 3, "Dryopteris erythrosora")
plot_distribution(species_ranking, 3, "Dryopteris erythrosora", occ_data_ferns)
```
]

---
class: inverse, middle
background-color: #000000

.pull-left-wide[<img src="images/species_motifs_ferns_focus_3_crop.png" alt="drawing">]

.pull-right-narrow[
```{r ecos-motif-3-focus-7, dev = "png"}
make_species_ranking_table(species_ranking, 3, "Odontosoria chinensis")
plot_distribution(species_ranking, 3, "Odontosoria chinensis", occ_data_ferns)
```
]

---
class: inverse, middle
background-color: #000000

.pull-left-wide[<img src="images/species_motifs_ferns_focus_4_crop.png" alt="drawing">]

.pull-right-narrow[
```{r ecos-motif-4}
make_species_ranking_table(species_ranking, 4)
```
]

---
class: inverse, middle
background-color: #000000

.pull-left-wide[<img src="images/species_motifs_ferns_focus_4_crop.png" alt="drawing">]

.pull-right-narrow[
```{r ecos-motif-4-focus-2, dev = "png"}
make_species_ranking_table(species_ranking, 4, "Blechnum niponicum")
plot_distribution(species_ranking, 4, "Blechnum niponicum", occ_data_ferns)
```
]

---
class: inverse, middle
background-color: #000000

.pull-left-wide[<img src="images/species_motifs_ferns_focus_4_crop.png" alt="drawing">]

.pull-right-narrow[
```{r ecos-motif-4-focus-8, dev = "png"}
make_species_ranking_table(species_ranking, 4, "Polystichum retrosopaleaceum")
plot_distribution(species_ranking, 4, "Polystichum retrosopaleaceum", occ_data_ferns)
```
]

---
class: inverse, middle
background-color: #000000

.pull-left-wide[<img src="images/species_motifs_ferns_focus_5_crop.png" alt="drawing">]

.pull-right-narrow[
```{r ecos-motif-5}
make_species_ranking_table(species_ranking, 5)
```
]

---
class: inverse, middle
background-color: #000000

.pull-left-wide[<img src="images/species_motifs_ferns_focus_5_crop.png" alt="drawing">]

.pull-right-narrow[
```{r ecos-motif-5-focus-3, dev = "png"}
make_species_ranking_table(species_ranking, 5, "Dicranopteris linearis")
plot_distribution(species_ranking, 5, "Dicranopteris linearis", occ_data_ferns)
```
]

---
class: inverse, middle
background-color: #000000

.pull-left-wide[<img src="images/species_motifs_ferns_focus_5_crop.png" alt="drawing">]

.pull-right-narrow[
```{r ecos-motif-5-focus-7, dev = "png"}
make_species_ranking_table(species_ranking, 5, "Polystichum tagawanum")
plot_distribution(species_ranking, 5, "Polystichum tagawanum", occ_data_ferns, show_title = FALSE)
```
]

---
class: inverse, middle
background-color: #000000

.pull-left-wide[<img src="images/species_motifs_ferns_focus_6_crop.png" alt="drawing">]

.pull-right-narrow[
```{r ecos-motif-6}
make_species_ranking_table(species_ranking, 6, taxon_include = c("Angiopteris lygodiifolia", "Ctenitis subglandulosa"))
```
]

---
class: inverse, middle
background-color: #000000

.pull-left-wide[<img src="images/species_motifs_ferns_focus_6_crop.png" alt="drawing">]

.pull-right-narrow[
```{r ecos-motif-6-focus-2, dev = "png"}
make_species_ranking_table(species_ranking, 6, "Angiopteris lygodiifolia", taxon_include = c("Angiopteris lygodiifolia", "Ctenitis subglandulosa"))
plot_distribution(species_ranking, 6, "Angiopteris lygodiifolia", occ_data_ferns, taxon_include = "Angiopteris lygodiifolia")
```
]

---
class: inverse, middle
background-color: #000000

.pull-left-wide[<img src="images/species_motifs_ferns_focus_6_crop.png" alt="drawing">]

.pull-right-narrow[
```{r ecos-motif-6-focus-1, dev = "png"}
make_species_ranking_table(species_ranking, 6, "Arachniodes sporadosora", taxon_include = c("Angiopteris lygodiifolia", "Ctenitis subglandulosa"))
plot_distribution(species_ranking, 6, "Arachniodes sporadosora", occ_data_ferns)
```
]

---

## 生態的構造のグループによって、系統的多様性が違う

.pull-left[<img src="images/species_motifs_ferns_all_crop.png" alt="drawing">]

.pull-right[
```{r mpd-vs-motifs}
# Plot omega score vs motif
a <- make_scatter_with_lm(alpha_div_ferns, "motif_1", "phy_mpd_obs_z", "Score", "MPD", ecos_cols[[1]]) +
  labs(x = "", title = "Motif 1")
b <- make_scatter_with_lm(alpha_div_ferns, "motif_2", "phy_mpd_obs_z", "Score", "MPD", ecos_cols[[2]]) +
  labs(title = "Motif 2", y = "", x = "")
c <- make_scatter_with_lm(alpha_div_ferns, "motif_3", "phy_mpd_obs_z", "Score", "MPD", ecos_cols[[3]]) +
  labs(title = "Motif 3", y = "", x = "")
d <- make_scatter_with_lm(alpha_div_ferns, "motif_4", "phy_mpd_obs_z", "Score", "MPD", ecos_cols[[4]]) +
  labs(title = "Motif 4")
e <- make_scatter_with_lm(alpha_div_ferns, "motif_5", "phy_mpd_obs_z", "Score", "MPD", ecos_cols[[5]]) +
  labs(title = "Motif 5", y = "")
f <- make_scatter_with_lm(alpha_div_ferns, "motif_6", "phy_mpd_obs_z", "Score", "MPD", ecos_cols[[6]]) +
  labs(title = "Motif 6", y = "")
a + b + c + d + e + f + plot_layout(ncol = 2, nrow = 3)
```
]
