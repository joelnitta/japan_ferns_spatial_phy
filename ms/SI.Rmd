---
title: "Exploring dimensions of biodiversity in Japanese ferns"
bibliography: "main_library.bib"
mainfont: Roboto-Regular.ttf
fontsize: 11pt
mainfontoptions: 
- BoldFont=Roboto-Bold.ttf
- ItalicFont=Roboto-Italic.ttf
- BoldItalicFont=Roboto-BoldItalic.ttf
output: 
  bookdown::pdf_document2:
    citation_package: none # Use pandoc default, otherwise csl can't be used for reference formatting
    toc: no
    number_sections: no
    fig_caption: yes
    keep_tex: no
    latex_engine: xelatex
    pandoc_args: [ "--csl", "journal-of-biogeography.csl"]
    includes:
      in_header: newphyt.sty
header-includes: 
  \usepackage{float}
  \makeatletter\renewcommand*{\fps@figure}{H}\makeatother
editor_options: 
  chunk_output_type: console
# nocite: | 
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, results = "hide", cache = FALSE)
```

```{r load-data, cache = FALSE}
# NOTE: This Rmd is meant to be knit as part of the drake plan (R/plan.R).
# If using interactively, run `source("_drake.R")` first.

loadd(list = c(
  "comm_scaled_list_0.1",
  "comm_scaled_list_0.2",
  "comm_scaled_list_0.3",
  "comm_scaled_list_0.4",
  "occ_point_data_ferns",
  "biodiv_ferns_spatial",
  "biodiv_ferns_endemic_spatial",
  "k_taxonomy",
  "k_phylogeny",
  "traits_nmds",
  "ppgi"
),
cache = ja_fern_cache)

# Load captions
source(here::here("ms/captions.R"))
```

<!-- Remove page numbers -->
\pagenumbering{gobble}

<!-- Set left justification -->
\raggedright

<!-- Don't indent -->
\setlength{\parindent}{0ex}

# Supplemental Information

```{r sampling-curve, fig.width = 4, fig.height = 3}
# Format fern abundances (no hybrids) as numeric vector
fern_abun <-
  occ_point_data_ferns %>%
  group_by(taxon) %>%
  count(sort = TRUE) %>%
  pull(n)

# Run iNEXT
inext_out <- iNEXT::iNEXT(fern_abun, q=0, datatype="abundance")

# create subset of observed points to add to plot as dots
observed_data <- inext_out$iNextEst[inext_out$iNextEst$method == "observed",]

# check estimated completeness
est_completeness <- inext_out$iNextEst %>% filter(method == "observed") %>% pull(SC) %>% scales::percent()
rich_interval <- glue::glue("{observed_data$qD.LCL %>% round} to {observed_data$qD.UCL %>% round}")
completeness_interval <- glue::glue("{observed_data$SC.LCL %>% scales::percent()} to {observed_data$SC.UCL %>% scales::percent()}")

# Make iNEXT plot
inext_out$iNextEst %>%
  filter(method != "observed") %>%
  ggplot(aes(x=m, y=qD)) +
  geom_ribbon(aes(ymin = qD.LCL, ymax = qD.UCL), fill = "grey70") +
  geom_line(aes(linetype=method), size=0.8) +
  scale_linetype_manual(values=c("dotted", "solid", "solid")) +
  geom_point(data=observed_data, size=3) +
  scale_y_continuous("Richness") +
  scale_x_continuous("No. specimens") +
  theme_minimal() +
  theme(
    legend.position="bottom", 
    legend.title=element_blank()
  )

ggsave(result_file(s_figure("sampling-curve"), "pdf"), width = 4, height = 3, units = "in")
```

**`r s_figure("sampling-curve")`**. `r s_figure_cap("sampling-curve")` Grey shading indicates 95% confidence interval (not visible where it does not extend beyond the fitted line). Point indicates observed taxonomic richness (`r observed_data$qD` taxa, 95% confidence interval `r rich_interval` taxa). Taxa include species, subspecies, and varieties, excluding hybrids. Sampling completeness is estimated to be `r est_completeness` (95% confidence interval `r completeness_interval`).

\clearpage

```{r grain-size, fig.width = 7, fig.height = 3}
# Helper function to format resolution labels
degree_lab <- function (x) {
  as.numeric(x) %>% 
    scales::number(suffix = "\u00b0", accuracy = 0.1)
}

# Combine results of building community matrices at different grain sizes
redundancy_by_res <- 
  list(
    "0.1" = comm_scaled_list_0.1$poly_shp,
    "0.2" = comm_scaled_list_0.2$poly_shp,
    "0.3" = comm_scaled_list_0.3$poly_shp,
    "0.4" = comm_scaled_list_0.4$poly_shp) %>%
  map_df(~as_tibble(.) %>% select(grids, abundance, richness), .id = "res") %>%
  # Calculate redundancy
  mutate(redundancy = 1 - (richness/abundance))

# Summarize redundancy statistics by grain size
redundancy_summary <-
  redundancy_by_res %>%
  mutate(above_50 = ifelse(redundancy > 0.5, 1, 0)) %>%
  mutate(singleton = ifelse(redundancy == 0, 1, 0)) %>%
  group_by(res) %>%
  summarize(
    n_total = n(),
    n_above_50 = sum(above_50),
    n_singletons = sum(singleton),
    percent_above_50 = n_above_50/n_total,
    percent_singletons = n_singletons/ n_total,
    .groups = "drop"
  )

# Percent of grid cells with redundancy > 0.5 by grain size
a <- ggplot(redundancy_summary, aes(x = res, y = percent_above_50)) +
  geom_col() +
  scale_y_continuous(labels = scales::percent) +
  scale_x_discrete(labels = degree_lab) +
  labs(
    x = "Resolution",
    y = "Redundancy > 0.5"
  )

# Percent of grid cells with redundancy = 0 by grain size
b <- ggplot(redundancy_summary, aes(x = res, y = percent_singletons)) +
  geom_col() +
  scale_y_continuous(labels = scales::percent) +
  scale_x_discrete(labels = degree_lab) +
  labs(
    x = "Resolution",
    y = "Redundancy = 0"
  )

# Distribution of redundancy by grain size
c <- ggplot(redundancy_by_res, aes(x = redundancy, y = res)) +
  geom_density_ridges(scale = 1.5) + 
  scale_y_discrete(expand = c(0, 0), labels = degree_lab) +     # will generally have to set the `expand` option
  scale_x_continuous(expand = c(0, 0)) +   # for both axes to remove unneeded padding
  coord_cartesian(clip = "off") + # to avoid clipping of the very top of the top ridgeline
  labs(
    x = "Redundancy",
    y = "Resolution"
  )

a + b + c +
  plot_annotation(tag_levels = 'A')

ggsave(result_file(s_figure("grain-size"), "pdf"), width = 7, height = 3, units = "in")
```

**`r s_figure("grain-size")`**. `r s_figure_cap("grain-size")` **A**, Percent of grid cells with redundancy > 0.5 by grain size (0.1, 0.2, 0.3, or 0.4 degree grid-cells). **B**, Percent of grid cells with redundancy = 0 by grain size. **C**, Distribution of redundancy values by grain size. There is a sudden improvement in redundancy values from 0.1 to 0.2 degree grid-cells, but less improvement as grain size is increased beyond 0.2 degrees.

\clearpage

```{r k-plot, fig.width = 7, fig.height = 3}
a <- k_taxonomy$df %>%
  as_tibble() %>%
  mutate(
    optimal_auto = ifelse(k == k_taxonomy$optimal$k, TRUE, FALSE),
    label = ifelse(k == k_taxonomy$optimal$k, glue::glue("k = {k}"), "")
  ) %>%
  ggplot(aes(x = k, y = ev)) +
  geom_path() +
  geom_point(aes(color = optimal_auto), size = 2.5) +
  geom_text(aes(label = label), vjust = 0, nudge_y = 0.02, size = 4) +
  scale_color_manual(values = c("TRUE" = "#E31A1C", "FALSE" = "black")) +
  labs(
    y = "Explained variance",
    x = "Number of clusters") +
  theme(
    legend.position = "none"
  )

k_phylogeny_select <- 8

b <- k_phylogeny$df %>%
  as_tibble() %>%
  mutate(
    optimal_auto = ifelse(k == k_phylogeny$optimal$k, TRUE, FALSE),
    label = ifelse(k == k_phylogeny$optimal$k, glue::glue("k = {k}"), "")
  ) %>%
  ggplot(aes(x = k, y = ev)) +
  geom_path() +
  geom_point(aes(color = optimal_auto), size = 2.5) +
  geom_text(aes(label = label), vjust = 0, nudge_y = 0.02, size = 4) +
  scale_color_manual(values = c("TRUE" = "#E31A1C", "FALSE" = "black")) +
  labs(
    y = "Explained variance",
    x = "Number of clusters") +
  theme(
    legend.position = "none"
  )

a + b +
  plot_layout(ncol = 2) +
  plot_annotation(tag_levels = 'A')

ggsave(result_file(s_figure("k-plot"), "pdf"), width = 7, height = 3, units = "in")
```

**`r s_figure("k-plot")`**. `r s_figure_cap("k-plot")` **A**, taxonomic bioregions. **B**, phylogenetic bioregions. Color indicates optimal *k* selected selected by \function{optimal{\_}phyloregion} function in the R package \package{phyloregion} (black, non-optimal; red, optimal; see Methods).

\clearpage

```{r raw-biplot, fig.width = 7, fig.height = 7}
a <- ggplot(biodiv_ferns_spatial, aes(x = richness, y = pd_obs)) +
  geom_point(alpha = 0.5) +
  labs(x = "Richness", y = "PD")

b <- ggplot(biodiv_ferns_spatial, aes(x = richness, y = rpd_obs)) +
  geom_point(alpha = 0.5) +
  labs(x = "Richness", y = "RPD")

c <- ggplot(biodiv_ferns_spatial, aes(x = richness, y = fd_obs)) +
  geom_point(alpha = 0.5) +
  labs(x = "Richness", y = "FD")

d <- ggplot(biodiv_ferns_spatial, aes(x = richness, y = rfd_obs)) +
  geom_point(alpha = 0.5) +
  labs(x = "Richness", y = "RFD")

a + b + c + d +
  plot_layout(ncol = 2, nrow = 2) +
  plot_annotation(tag_levels = 'A')

ggsave(result_file(s_figure("raw-biplot"), "pdf"), width = 7, height = 3, units = "in")
```

**`r s_figure("raw-biplot")`**. `r s_figure_cap("raw-biplot")` **A**, Phylogenetic diversity (PD). **B**, Relative phylogenetic diversity (RPD). **C**, Functional diversity (FD). **D**, Relative functional diversity (RFD).

\clearpage

```{r map-plot-prep}
# Download high-res map of Japan,
# crop to spatial div results area
japan <- rnaturalearth::ne_countries(country = "japan", scale = "large", returnclass = "sf") %>%
  sf::st_crop(sf::st_bbox(biodiv_ferns_endemic_spatial))

# Set CRS
japan_crs <- sf::st_crs(japan)

biodiv_ferns_endemic_spatial <- sf::st_set_crs(biodiv_ferns_endemic_spatial, japan_crs)

# Set color palettes
# Randomization test significance
signif_cols <-
  c(
    "> 0.99" = "#e31a1c", 
    "> 0.975" = "#fb9a99",
    "< 0.01" = "#1f78b4", 
    "< 0.025" = "#a6cee3",
    "not significant" = "#ffffcc"
  )

# CANAPE
canape_cols <-
  c(
    "neo" = "#e31a1c", 
    "paleo" = "#1f78b4",
    "mixed" = "#6a51a3",
    "super" = "#4a1486",
    "not significant" = "#ffffcc"
  )
```

```{r endemism-restricted, fig.width = 5, fig.height = 5}
ggplot() +
  geom_sf(data = japan, fill = "grey90", color = "black", lwd = 0.25) +
  geom_sf(data = biodiv_ferns_endemic_spatial, aes(fill = endem_type), color = "transparent", alpha = 0.8) +
  scale_fill_manual(values = canape_cols) +
  map_theme() +
  theme(legend.title = element_blank())

ggsave(result_file(s_figure("endemism-restricted"), "pdf"), width = 5, height = 5, units = "in")
```

**`r s_figure("endemism-restricted")`**. `r s_figure_cap("endemism-restricted")` 'paleo' indicates paleoendemic areas (those with an overabundance of long branches); 'neo' indicates neodendemic areas (those with an overabundance of short branches); 'mixed' indicates significantly endemic sites that have neither an overabundance of short nor long branches; 'super' indicates highly significantly endemic sites that have neither an overabundance of short nor long branches. For details, see Methods.
