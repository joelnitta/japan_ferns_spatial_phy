---
title: "Appendix S1: Supporting Information"
mainfont: Roboto-Regular.ttf
fontsize: 11pt
mainfontoptions: 
  - BoldFont=Roboto-Bold.ttf
  - ItalicFont=Roboto-Italic.ttf
  - BoldItalicFont=Roboto-BoldItalic.ttf
output: 
  bookdown::pdf_document2:
    citation_package: default
    toc: no
    number_sections: no
    fig_caption: yes
    keep_tex: no
    latex_engine: xelatex
    pandoc_args: [ "--csl", "apa-6th-edition.csl"]
header-includes: 
  \usepackage{float}
  \makeatletter\renewcommand*{\fps@figure}{H}\makeatother
editor_options: 
  chunk_output_type: console
params:
  doc_type: pdf
# nocite: | 
---

---
bibliography: 
- `r here::here("ms/references.yaml")`
---

```{r setup-si, include = FALSE, cache = FALSE, eval = TRUE}
# Load packages only used when knitting Rmd
library(kableExtra)
library(scales)
library(ggtree)
library(RColorBrewer)
# Load functions and variables only used when rendering Rmds
source(here::here("R/ms_functions.R"), local = TRUE)
# Set knitr options
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, results = "hide", cache = FALSE)
```

```{r libraries-no-run-in-plan, eval = FALSE}
# This Rmd is meant to be knit as part of the target plan (R/_targets.R).
# Run the lines below if rendering outside of targets plan
library(targets)
library(tarchetypes)
source(here::here("R/packages.R"))
source(here::here("R/functions.R"))
```

```{r load-data-si, cache = FALSE}
tar_load(c(
  "japan_shp",
  "comm_scaled_list",
  "occ_point_data_ferns",
  "biodiv_ferns_spatial",
  "biodiv_ferns_endemic_spatial",
  "k_taxonomy",
  "k_phylogeny",
  "traits_nmds",
  "ppgi",
  "phy_sig_results",
  "binary_sig_results",
  "lrt_results",
  "japan_shp",
  "morans_i",
  "t_test_results",
  "aic_env_repro",
  "comm_ferns",
  "repro_data",
  "japan_pterido_tree",
  "model_fits_not_ult",
  "biodiv_ferns_cent"
))
```

```{r load-captions}
# Source captions numbers from MS
# 
# So that caption numbers are in order of appearance in MS

# Run inline code when purling
options(knitr.purl.inline = TRUE)

# Make a temporary file to write out just inline R code from the SI Rmd
temp_file <- tempfile()

# Generate R script including inline R code from the ms Rmd
knitr::purl(here::here("ms/manuscript.Rmd"), output = temp_file)

# Trim this R script down to only functions that define figure and table captions
read_lines(temp_file) %>%
  magrittr::extract(
    str_detect(., "^figure\\(|^table\\(|^s_figure\\(|^s_table\\(|^figure_num\\(|^table_num\\(|^s_figure_num\\(|^s_table_num\\(")
  ) %>%
  unique %>%
  write_lines(temp_file)

# Source the code. This will load the caption functions in the right order.
source(temp_file, local = TRUE)

# Delete the temporary file
fs::file_delete(temp_file)
```

<!-- Remove page numbers -->
\pagenumbering{gobble}

<!-- Set left justification -->
\raggedright

<!-- Don't indent -->
\setlength{\parindent}{0ex}

```{r moran, results = "as-is"}
morans_i %>%
  select(resp_var = var, morans_i, pval_i) %>%
  mutate(
    across(c(morans_i, pval_i), ~format(., digits = 2)),
    resp_var = clean_vars(resp_var) %>% 
      factor(levels = c("Area", "% apomictic taxa", "Precipitation", "Precipitation seasonality", "Temperature", "Richness", "SES of PD", "SES of RPD", "SES of FD", "SES of RFD"))
  ) %>%
  assert(not_na, resp_var) %>%
  arrange(resp_var) %>%
  # format for kable/latex: since I use latex in headers, must escape latex elsewhere
  mutate(resp_var = str_replace_all(resp_var, "%", "\\\\%")) %>%
  rename(`\\textit{I}` = morans_i, `\\textit{P}` = pval_i, "Variable" = resp_var) %>%
  kbl(booktabs = TRUE, escape = FALSE, format = "latex") %>%
  kable_styling(latex_options = c("striped", "HOLD_position"))
```

**`r s_table("moran")`**. Spatial autocorrelation in biodiversity metrics (richness, SES of PD, SES of FD, SES of RPD, SES of RFD) and independent variables (environmental variables and % apomictic taxa) as measured with Moran's *I*. Significant *I* > 0 indicates autocorrelation.

\clearpage

```{r corr, results = "as-is"}
t_test_results_for_table <-
  t_test_results %>%
  mutate(
    var1 = clean_vars(var1),
    var2 = clean_vars(var2)) %>%
  arrange(var1, var2)

# Identify which rows to make bold based on p < 0.05
t_test_signif <- t_test_results_for_table$p_value < 0.05
t_test_signif[is.na(t_test_signif)] <- FALSE
t_test_signif <- which(t_test_signif)

t_test_results_for_table %>%
  mutate(across(where(is.double), ~format(., digits = 2))) %>%
  # format for kable/latex
  mutate(
    var1 = str_replace_all(var1, "%", "\\\\%"),
    var2 = str_replace_all(var2, "%", "\\\\%")) %>%
  rename(
    "Variable 1" = var1,
    "Variable 2" = var2,
    `\\textit{P}` = p_value,
    `\\textit{r}` = corr,
    `\\textit{f}` = f_stat,
    "df" = dof) %>%
  kbl(booktabs = TRUE, escape = FALSE, format = "latex") %>%
  row_spec(row = t_test_signif, bold = TRUE) %>%
  kable_styling(latex_options = c("striped", "HOLD_position"))
```

**`r s_table("corr")`**. Results of modified *t*-test for correlation between variables while taking into account spatial position. Significantly correlated variables at *P* < 0.05 in bold.

\clearpage

```{r phy-sig, results = "as-is"}
phy_sig_results %>%
  mutate(across(c(kval, lambda, k_pval, lambda_pval), ~format(., digits = 2))) %>%
  # format for kable/latex
  mutate(trait = str_replace_all(trait, "_", "\\\\_")) %>%
  rename(
    "Trait" = trait,
    `\\textit{K}` = kval, `\\textit{P}(\\textit{K})` = k_pval, 
    `λ` = lambda, `\\textit{P}(λ)` = lambda_pval,
    `\\textit{N}` = n) %>%
  kbl(booktabs = TRUE, escape = FALSE, format = "latex") %>%
  kable_styling(latex_options = c("striped", "HOLD_position"))
```

**`r s_table("phy-sig")`**. Phylogenetic signal in continuous functional traits of the ferns of Japan. *K*, Blomberg's *K*; λ, Pagel's λ.

\clearpage

```{r phy-sig-binary, results = "as-is"}
binary_sig_results %>%
  select(trait, D, num_present, num_absent, prob_random, prob_brownian) %>%
  arrange(trait) %>%
  # format for kable/latex
  mutate(trait = str_replace_all(trait, "_", "\\\\_")) %>%
  rename(
    "Trait" = trait,
    `\\textit{N} present` = num_present,
    `\\textit{N} absent` = num_absent,
    `\\textit{D}` = D,
    `\\textit{P}(random)` = prob_random, 
    `\\textit{P}(Brownian)` = prob_brownian
  ) %>%
  kbl(booktabs = TRUE, escape = FALSE, format = "latex") %>%
  kable_styling(latex_options = c("striped", "scale_down", "HOLD_position"))
```

**`r s_table("phy-sig-binary")`**. Phylogenetic signal in quantitative (binary) functional traits of the ferns of Japan. *D*, Fritz and Purvis' *D*; *N* (present), number of times a trait was observed present; *N* (absent), number of times a trait was observed absent; *P*(random), probability of obtaining observed trait distribution given random distribution of traits; *P*(Brownian), probability of obtaining observed trait distribution given random evolution by Brownian Motion. Presence or absence of indusium was originally a binary trait; other traits (margin, shape, texture) are qualitative traits scored in binary format.

\clearpage

```{r lrt-null, results = "as-is"}
# Need to keep the input data separate for pack_rows()
lrt_table_data <-
  lrt_results %>%
  filter(comparison == "null_model") %>%
  select(-null_formula, -comparison) %>%
  tidyr::extract(full_formula, "model_type", "~ ([^ ]+) ") %>%
  rename_resp_vars %>%
  rename_model_type %>%
  select(model_type, resp_var, chi2_LR, df, loglik_null, loglik_full, p_value) %>%
  arrange(model_type, resp_var) %>%
  mutate(across(where(is.double), ~format(., digits = 2)))

lrt_table_data %>%
  select(-model_type) %>%
  # format for kable/latex
  rename(
    "Response variable" = resp_var,
    `χ\\textsuperscript{2}` = chi2_LR,
    `LogL(null)` = loglik_null,
    `LogL(full)` = loglik_full,
    `\\textit{P}` = p_value
  ) %>%
  kbl(booktabs = TRUE, escape = FALSE, format = "latex") %>%
  pack_rows(index = base::table(lrt_table_data$model_type)) %>%
  kable_styling(latex_options = c("striped", "HOLD_position"))
```

**`r s_table("lrt-null")`**. Likelihood ratio test (LRT) between full model and null model (model only including the spatial Matérn correlation matrix). Higher (less negative) log likelihood indicates better fit. Full environmental models included the effects of temperature, precipitation, precipitation seasonality, and area. Full reproductive models included the effects of % apomictic taxa, precipitation, precipitation seasonality, and area. PD, phylogenetic diversity; RPD, relative phylogenetic diversity; FD, functional diversity; RFD, relative functional diversity; SES, standard effect size.

\clearpage

```{r aic, results = "as-is"}
aic_table_data <- aic_env_repro %>%
  rename_resp_vars %>%
  rename_model_type %>%
  select(model_type, resp_var, conditional_aic, df = effective_df, loglik) %>%
  arrange(model_type, resp_var) %>%
  mutate(across(where(is.double), ~format(., digits = 2)))

aic_table_data %>%
  select(-model_type) %>%
  # format for kable/latex
  rename(
    "Response variable" = resp_var,
    "cAIC" = conditional_aic,
    "LogL" = loglik
  ) %>%
  kbl(booktabs = TRUE, escape = FALSE, format = "latex") %>%
  pack_rows(index = base::table(aic_table_data$model_type)) %>%
  kable_styling(latex_options = c("striped", "HOLD_position"))
```

**`r s_table("aic")`**. Model fit as measured with conditional Akaike Information Criterion (cAIC). Environmental models included the effects of temperature, precipitation, precipitation seasonality, and area. Reproductive models included the effects of % apomictic taxa, precipitation, precipitation seasonality, and area. Lower cAIC indicates better fit.

\clearpage

```{r map-plot-prep}
# Download high-res map of Japan,
# crop to spatial div results area
japan <- sf::st_crop(japan_shp, sf::st_bbox(biodiv_ferns_spatial))

# Set CRS
japan_crs <- sf::st_crs(japan)

# Format biodiv_ferns_spatial data
biodiv_ferns_spatial <-
  biodiv_ferns_spatial %>% 
  # Set CRS
  sf::st_set_crs(japan_crs) %>%
  # Set order of factor levels for plotting
  mutate(
    endem_type = factor(endem_type, levels = c("neo", "paleo", "not significant", "mixed", "super")),
    # can ignore warning about unknown levels, since they don't exist in all variables but that's OK
    across(
      contains("signif"),
      ~fct_relevel(.x, "< 0.01",  "< 0.025", "not significant", "> 0.975", "> 0.99")
    )
  )

biodiv_ferns_endemic_spatial <-
  biodiv_ferns_endemic_spatial %>% 
  # Set CRS
  sf::st_set_crs(japan_crs) %>%
  # Set order of factor levels for plotting
  mutate(
    endem_type = factor(endem_type, levels = c("neo", "paleo", "not significant", "mixed", "super"))
  )

# Subset ferns biodiversity dataframe: restrict sites to only those used in model
# (drops outlier % apomictic site)
biodiv_ferns_for_plotting <-
  biodiv_ferns_spatial %>%
  drop_apo_outlier

# Specify subplot order
model_subplot_order <- tribble(
  ~resp_var, ~indep_var, ~order,
  "richness", "temp", 1,
  "pd_obs_z", "temp", 2,
  "rpd_obs_z", "temp", 3,
  "fd_obs_z", "temp", 4,
  "rfd_obs_z", "temp", 5,
  "pd_obs_z", "percent_apo", 6,
  "rpd_obs_z", "percent_apo", 7
)
```

```{r sampling-curve, fig.width = 4, fig.height = 3}
# Format fern abundances (no hybrids) as numeric vector
fern_abun <-
  occ_point_data_ferns %>%
  group_by(taxon) %>%
  count(sort = TRUE) %>%
  pull(n)

# Run iNEXT
inext_out <- iNEXT::iNEXT(fern_abun, q=0, datatype="abundance")

# create subset of observed points to add to plot as dots
observed_data <- inext_out$iNextEst[inext_out$iNextEst$method == "observed",]

# check estimated completeness
est_completeness <- inext_out$iNextEst %>% filter(method == "observed") %>% pull(SC) %>% scales::percent()
rich_interval <- glue::glue("{observed_data$qD.LCL %>% round} to {observed_data$qD.UCL %>% round}")
completeness_interval <- glue::glue("{observed_data$SC.LCL %>% scales::percent()} to {observed_data$SC.UCL %>% scales::percent()}")

# Make iNEXT plot
inext_out$iNextEst %>%
  filter(method != "observed") %>%
  ggplot(aes(x=m, y=qD)) +
  geom_ribbon(aes(ymin = qD.LCL, ymax = qD.UCL), fill = "grey70") +
  geom_line(aes(linetype=method), size=0.8) +
  scale_linetype_manual(values=c("dotted", "solid", "solid")) +
  geom_point(data=observed_data, size=3) +
  scale_y_continuous("Richness") +
  scale_x_continuous("No. specimens") +
  theme_minimal() +
  theme(
    legend.position="bottom", 
    legend.title=element_blank()
  )
```

**`r s_figure("sampling-curve")`**. Species collection curve for the ferns of Japan fit with the `r pack("iNEXT")` package [@Hsieh2016]. Grey shading indicates 95% confidence interval (not visible where it does not extend beyond the fitted line). Point indicates observed taxonomic richness (`r observed_data$qD` taxa, 95% confidence interval `r rich_interval` taxa). Taxa include species, subspecies, and varieties, excluding hybrids. Sampling completeness is estimated to be `r est_completeness` (95% confidence interval `r completeness_interval`).

\clearpage

```{r grain-size, fig.width = 7, fig.height = 3}
# Helper function to format resolution labels
degree_lab <- function (x) {
  as.numeric(x) %>% 
    scales::number(suffix = "\u00b0", accuracy = 0.1)
}

# Combine results of building community matrices at different grain sizes
redundancy_by_res <- 
  list(
    "0.1" = comm_scaled_list %>% filter(resol == 0.1) %>% pull(poly_shp) %>% pluck(1),
    "0.2" = comm_scaled_list %>% filter(resol == 0.2) %>% pull(poly_shp) %>% pluck(1),
    "0.3" = comm_scaled_list %>% filter(resol == 0.3) %>% pull(poly_shp) %>% pluck(1),
    "0.4" = comm_scaled_list %>% filter(resol == 0.4) %>% pull(poly_shp) %>% pluck(1)
  ) %>%
  map_df(~as_tibble(.) %>% select(grids, abundance, richness), .id = "res") %>%
  # Calculate redundancy
  mutate(redundancy = 1 - (richness/abundance))

# Summarize redundancy statistics by grain size
redundancy_summary <-
  redundancy_by_res %>%
  mutate(above_50 = ifelse(redundancy > 0.5, 1, 0)) %>%
  mutate(singleton = ifelse(redundancy == 0, 1, 0)) %>%
  group_by(res) %>%
  summarize(
    n_total = n(),
    n_above_50 = sum(above_50),
    n_singletons = sum(singleton),
    percent_above_50 = n_above_50/n_total,
    percent_singletons = n_singletons/ n_total,
    .groups = "drop"
  )

# Percent of grid cells with redundancy > 0.5 by grain size
a <- ggplot(redundancy_summary, aes(x = res, y = percent_above_50)) +
  geom_col() +
  scale_y_continuous(labels = scales::percent) +
  scale_x_discrete(labels = degree_lab) +
  labs(
    x = "Resolution",
    y = "Redundancy > 0.5"
  )

# Percent of grid cells with redundancy = 0 by grain size
b <- ggplot(redundancy_summary, aes(x = res, y = percent_singletons)) +
  geom_col() +
  scale_y_continuous(labels = scales::percent) +
  scale_x_discrete(labels = degree_lab) +
  labs(
    x = "Resolution",
    y = "Redundancy = 0"
  )

# Distribution of redundancy by grain size
c <- ggplot(redundancy_by_res, aes(x = redundancy, y = res)) +
  geom_density_ridges(scale = 1.5) + 
  scale_y_discrete(expand = c(0, 0), labels = degree_lab) +     # will generally have to set the `expand` option
  scale_x_continuous(expand = c(0, 0)) +   # for both axes to remove unneeded padding
  coord_cartesian(clip = "off") + # to avoid clipping of the very top of the top ridgeline
  labs(
    x = "Redundancy",
    y = "Resolution"
  )

a + b + c +
  plot_annotation(tag_levels = "a",
                  tag_prefix = "(",
                  tag_suffix = ")") &
  theme(plot.tag = element_text(face = "bold"))
```

**`r s_figure("grain-size")`**. Effect of grain size on sampling redundancy. (a), Percent of grid cells with redundancy > 0.5 by grain size (0.1, 0.2, 0.3, or 0.4 degree grid-cells). (b), Percent of grid cells with redundancy = 0 by grain size. (c), Distribution of redundancy values by grain size. There is a sudden improvement in redundancy values from 0.1 to 0.2 degree grid-cells, but less improvement as grain size is increased beyond 0.2 degrees.

\clearpage

```{r envir, fig.width = 7, fig.height = 9}
# Define function for plotting environment
plot_env <- function(part, label, var_select, fill_lab = "", labels = ggplot2::waiver()) {
  ggplot() +
    geom_sf(data = japan, fill = "white", color = "transparent", lwd = coast_lwd) +
    geom_sf(data = biodiv_ferns_spatial, aes(fill = .data[[var_select]]), color = "transparent") +
    geom_sf(data = japan, fill = "transparent", color = coast_col, lwd = coast_lwd) +
    annotate(
      geom="richtext", y = Inf, x = -Inf, 
      label = glue("<span style='color:black'>**({part})** {label}</span>"), 
      hjust = "inward", vjust = "inward", color = "white") + 
    labs(fill = fill_lab) +
    scale_fill_scico(palette = "lajolla", labels = labels) +
    scale_x_continuous(guide = guide_axis(check.overlap = TRUE)) +
    theme_grey(base_size = 10) +
    theme(
      panel.grid.major = element_line(color = "grey60", size = 0.1),
      panel.grid.minor = element_blank(),
      panel.background = element_rect(fill = "transparent"),
      axis.ticks = element_blank(),
      axis.text = element_text(color = "grey60"),
      axis.title = element_blank(),
      legend.position = "right",
      legend.title = element_markdown()
    )
}

a <- plot_env("a", "Area", "area", "km^2")
b <- plot_env("b", "% apomictic taxa", "percent_apo", labels = function(x) scales::percent(x, accuracy = 1))
c <- plot_env("c", "Precipitation", "precip", "mm")
d <- plot_env("d", "Precip. season.", "precip_season" , "")
e <- plot_env("e", "Temperature", "temp", "°C", function(x) x/10)
f <- plot_env("f", "Temp. season.", "temp_season")

a + b + c + d + e + f + plot_layout(ncol = 2, nrow = 3)
```

**`r s_figure("envir")`**. Reproductive mode and environmental data in 0.2 degree grid cells across Japan. (a), rolling mean area (km^2^) in 1° latitudinal bands.  (b), % apomictic taxa. (c), annual precipitation. (d), percipitation seasonality (coefficient of variation).  (e), mean annual temperature. (f), temperature seasonality (standard deviation × 100).

\clearpage

```{r tree, fig.width = 8, fig.height = 8}
phy <- japan_pterido_tree

phy$tip.label <- str_replace_all(phy$tip.label, "_", " ")

# Make a dataframe (tibble) with node IDs (integers) and their corresponding bootstrap support values
# The tibble has two columns: one called "node", the other can be named as we like (here, "bootstrap")
bs_tibble <- tibble(
  # hard-code node ID: internal nodes start after tip nodes,
  # and phy$node.label is in the same order as internal nodes
  node=1:Nnode(phy) + Ntip(phy), 
  # Don't print BS < 50%
  # (or to show all BS, just do `bootstrap = phy$node.label`)
  bootstrap_raw = phy$node.label,
  bootstrap = parse_number(bootstrap_raw))

p <- ggtree(phy, layout = "fan", size = 0.25, open.angle = 3) %<+% 
  bs_tibble +
  geom_nodepoint(aes(color = bootstrap), size = 0.2) +
  geom_tiplab(size = 0.6)  +
  theme(legend.justification = c(1, 0), legend.position = c(1, 0)) +
  scale_color_scico(palette = "turku", direction = -1, na.value = "grey", name = "BS") +
  geom_treescale(x = 220, y = 708, width = 100, fontsize = 0)

rotate_tree(p, 3)
```

**`r s_figure("tree")`**. Time tree of native Japanese ferns and lycophytes, excluding hybrids. Points at nodes indicate bootstrap support. Scalebar 100 my. Tree visualized with the `r pack("ggtree")` R package [@Yu2017].

\clearpage

```{r abundance, fig.width = 7, fig.height = 5}
k <- scales::unit_format(unit = "k", scale = 1e-3, accuracy = 1, sep = "")

a <- ggplot() + 
  geom_sf(data = japan, fill = "white", color = "transparent", lwd = coast_lwd) +
  geom_sf(data = biodiv_ferns_spatial, aes(fill = abundance), color = "transparent") +
  geom_sf(data = japan, fill = "transparent", color = coast_col, lwd = coast_lwd) +
  scale_fill_scico(palette = "lajolla", label = k) +
  labs(fill = "No. specimens") +
  annotate(geom="richtext", y = Inf, x = -Inf, label = "<span style='color:black'>**(a)**</span>", hjust = "inward", vjust = "inward", color = "white") + 
  map_theme()


b <- ggplot() +
  geom_sf(data = japan, fill = "white", color = "transparent", lwd = coast_lwd) +
  geom_sf(data = biodiv_ferns_spatial, aes(fill = redundancy), color = "transparent") +
  geom_sf(data = japan, fill = "transparent", color = coast_col, lwd = coast_lwd) +
  scale_fill_scico(palette = "lajolla") +
  labs(fill = "Redundancy") +
  annotate(geom="richtext", y = Inf, x = -Inf, label = "<span style='color:black'>**(b)**</span>", hjust = "inward", vjust = "inward", color = "white") + 
  map_theme() +
  theme(
    axis.text.y = element_blank()
  )

a + b + 
  plot_layout(nrow = 1)
```

**`r s_figure("abundance")`**. Observed number of specimens (a) and sampling redundancy (b) per 0.2° grid cell in the ferns of Japan.

\clearpage

```{r raw-biplot, fig.width = 7, fig.height = 7}
a <- ggplot(biodiv_ferns_spatial, aes(x = richness, y = pd_obs)) +
  geom_point(alpha = 0.5) +
  labs(x = "Richness", y = "PD")

b <- ggplot(biodiv_ferns_spatial, aes(x = richness, y = rpd_obs)) +
  geom_point(alpha = 0.5) +
  labs(x = "Richness", y = "RPD")

c <- ggplot(biodiv_ferns_spatial, aes(x = richness, y = fd_obs)) +
  geom_point(alpha = 0.5) +
  labs(x = "Richness", y = "FD")

d <- ggplot(biodiv_ferns_spatial, aes(x = richness, y = rfd_obs)) +
  geom_point(alpha = 0.5) +
  labs(x = "Richness", y = "RFD")

a + b + c + d +
  plot_layout(ncol = 2, nrow = 2) +
  plot_annotation(tag_levels = "a",
                  tag_prefix = "(",
                  tag_suffix = ")") &
  theme(plot.tag = element_text(face = "bold"))
```

**`r s_figure("raw-biplot")`**. Relationships between observed functional and phylogenetic diversity and taxonomic richness in the ferns of Japan. (a), Phylogenetic diversity (PD). (b), Relative phylogenetic diversity (RPD). (c), Functional diversity (FD). (d), Relative functional diversity (RFD).

\clearpage

```{r endemism-restricted, fig.width = 5, fig.height = 5}
ggplot() +
  geom_sf(data = japan, fill = "white", color = "transparent", lwd = coast_lwd) +
  geom_sf(data = biodiv_ferns_endemic_spatial, aes(fill = endem_type), color = "transparent") +
  geom_sf(data = japan, fill = "transparent", color = coast_col, lwd = coast_lwd) +
  scale_fill_manual(values = canape_cols) +
  map_theme() +
  theme(legend.title = element_blank())
```

**`r s_figure("endemism-restricted")`**. Phylogenetic endemism of the ferns of Japan measured using CANAPE (categorical analysis of neo- and paleo-endemism), restricted dataset including only taxa endemic to Japan. 'paleo' indicates paleoendemic areas (those with an overabundance of long branches); 'neo' indicates neodendemic areas (those with an overabundance of short branches); 'mixed' indicates significantly endemic sites that have neither an overabundance of short nor long branches; 'super' indicates highly significantly endemic sites that have neither an overabundance of short nor long branches. For details, see Methods.

\clearpage

```{r k-plot, fig.width = 7, fig.height = 3}
a <- k_taxonomy$df %>%
  as_tibble() %>%
  mutate(
    optimal_auto = ifelse(k == k_taxonomy$optimal$k, TRUE, FALSE),
    label = ifelse(k == k_taxonomy$optimal$k, glue::glue("k = {k}"), "")
  ) %>%
  ggplot(aes(x = k, y = ev)) +
  geom_path() +
  geom_point(aes(color = optimal_auto), size = 2.5) +
  geom_text(aes(label = label), vjust = 0, nudge_y = 0.02, size = 4) +
  scale_color_manual(values = c("TRUE" = "#E31A1C", "FALSE" = "black")) +
  labs(
    y = "Explained variance",
    x = "Number of clusters") +
  theme(
    legend.position = "none"
  )

k_phylogeny_select <- 8

b <- k_phylogeny$df %>%
  as_tibble() %>%
  mutate(
    optimal_auto = ifelse(k == k_phylogeny$optimal$k, TRUE, FALSE),
    label = ifelse(k == k_phylogeny$optimal$k, glue::glue("k = {k}"), "")
  ) %>%
  ggplot(aes(x = k, y = ev)) +
  geom_path() +
  geom_point(aes(color = optimal_auto), size = 2.5) +
  geom_text(aes(label = label), vjust = 0, nudge_y = 0.02, size = 4) +
  scale_color_manual(values = c("TRUE" = "#E31A1C", "FALSE" = "black")) +
  labs(
    y = "Explained variance",
    x = "Number of clusters") +
  theme(
    legend.position = "none"
  )

a + b +
  plot_layout(ncol = 2) +
  plot_annotation(tag_levels = "a",
                  tag_prefix = "(",
                  tag_suffix = ")") &
  theme(plot.tag = element_text(face = "bold"))
```

**`r s_figure("k-plot")`**. Selection of *k* for bioregions. (a), taxonomic bioregions. (b), phylogenetic bioregions. Color indicates optimal *k* selected selected by the `r func("optimal_phyloregion")` function in the R package `r pack("phyloregion")` (black, non-optimal; red, optimal; see Methods).

\clearpage

```{r dendrogram-a, fig.width = 7, fig.height = 9}
# Extract dendrogram from phyloregions analysis, convert to phylogeny
dendro_tax <- attributes(k_taxonomy$df)$meta$hclust.obj %>% as.phylo() %>% ladderize()

# Map taxonomic clusters to grid cells
clusters_tax <-
  biodiv_ferns_spatial %>%
  as_tibble() %>%
  select(grids, cluster = taxonomic_cluster) %>%
  # Convert cluster to numeric to use max() later
  mutate(cluster = levels(cluster)[cluster] %>% as.numeric)

cluster_nodes_tax_tbl <- map_df(1:max(clusters_tax$cluster), ~map_cluster_to_nodes(dendro_tax, clusters_tax, .)) %>%
  mutate(cluster = as.factor(cluster))

# Use the ggtree::`%<+%` operator to map the bootstrap values onto the ggtree object
ggtree(dendro_tax, size = 0.15) %<+% 
  cluster_nodes_tax_tbl +
  aes(color = cluster) +
  scale_color_manual(
    values = bioregion_cols, na.value = "grey", name = "Cluster") +
  theme(legend.position = "right") +
  labs(subtitle = "**(a)** Taxonomic") +
  theme(plot.subtitle = element_markdown())
```

**`r s_figure("dendrogram")`**. Bioregion dendrogram. Tips are sites (names not shown); color shows cluster; internal branches between clusters 'NA'. (a), taxonomic bioregions. (b), phylogenetic bioregions. 
\clearpage

```{r dendrogram-b, fig.width = 7, fig.height = 9}
# Extract dendrogram from phyloregions analysis, convert to phylogeny
dendro_phy <- attributes(k_phylogeny$df)$meta$hclust.obj %>% as.phylo() %>% ladderize()

# Map taxonomic clusters to grid cells
clusters_phy <-
  biodiv_ferns_spatial %>%
  as_tibble() %>%
  select(grids, cluster = phylo_cluster) %>%
  # Convert cluster to numeric to use max() later
  mutate(cluster = levels(cluster)[cluster] %>% as.numeric)

cluster_nodes_phy_tbl <- map_df(1:max(clusters_phy$cluster), ~map_cluster_to_nodes(dendro_phy, clusters_phy, .)) %>%
  mutate(cluster = as.factor(cluster))

# Use the ggtree::`%<+%` operator to map the bootstrap values onto the ggtree object
ggtree(dendro_phy, size = 0.15) %<+% 
  cluster_nodes_phy_tbl +
  aes(color = cluster) +
  scale_color_manual(values = bioregion_cols, na.value = "grey", name = "Cluster") +
  theme(legend.position = "right") +
  labs(subtitle = "**(b)** Phylogenetic") +
  theme(plot.subtitle = element_markdown())
```

**`r s_figure("dendrogram")`**, continued.

\clearpage

```{r genus-map, fig.width = 7, fig.height = 9}
# Define function for plotting genus-level abundance.
# assumes `comm_ferns`, `japan` are in environment
plot_genus <- function(part, genus_select) {
  
  genus_abun <-
    comm_ferns %>%
    rownames_to_column("grids") %>%
    as_tibble() %>%
    pivot_longer(-grids, names_to = "species", values_to = "abun") %>%
    filter(str_detect(species, genus_select)) %>%
    group_by(grids) %>%
    summarize(richness = sum(abun), .groups = "drop") %>%
    left_join(select(biodiv_ferns_spatial, -richness), ., by = "grids")
  
  ggplot() +
    geom_sf(data = japan, fill = "white", color = "transparent", lwd = coast_lwd) +
    geom_sf(data = genus_abun, aes(fill = richness), color = "transparent") +
    geom_sf(data = japan, fill = "transparent", color = coast_col, lwd = coast_lwd) +
    annotate(
      geom="richtext", y = Inf, x = -Inf, 
      label = glue("<span style='color:black'>**({part})** *{genus_select}*</span>"), 
      hjust = "inward", vjust = "inward", color = "white") + 
    labs(fill = "Richness") +
    scale_fill_scico(palette = "lajolla") +
    scale_x_continuous(guide = guide_axis(check.overlap = TRUE)) +
    theme_grey(base_size = 10) +
    theme(
      panel.grid.major = element_line(color = "grey60", size = 0.1),
      panel.grid.minor = element_blank(),
      panel.background = element_rect(fill = "transparent"),
      axis.ticks = element_blank(),
      axis.text = element_text(color = "grey60"),
      axis.title = element_blank(),
      legend.position = "right",
      legend.title = element_markdown()
    )
}

a <- plot_genus("a", "Equisetum")
b <- plot_genus("b", "Deparia")
c <- plot_genus("c", "Cyrtomium")
d <- plot_genus("d", "Dryopteris")
e <- plot_genus("e", "Pteris")
f <- plot_genus("f", "Diplazium")

a + b + c + d + e + f + plot_layout(ncol = 2, nrow = 3)
```

**`r s_figure("genus-map")`**. Map of species richness for selected genera of ferns of Japan. (a), *Equisetum* is an example of a possible refugial lineage with greater species richness in northern Japan. (b), *Deparia* is an example of a genus with possible recent radiation in southern Honshu. (c)--(f) show genera with high rates of apomictic taxa (`r s_figure("apo-genus")`), which tend to be greatest in southern Honshu.

\clearpage

```{r apo-genus, fig.width = 4, fig.height = 3}
# Bar plot of % apo taxa by genus
percent_apo_genus <-
  repro_data %>%
  # Remove NA values, non-ferns
  filter(!is.na(apomict)) %>%
  filter(str_detect(taxon, "Lycopodiella|Lycopodium|Isoetes", negate = TRUE)) %>%
  # Summarize percent apo by genus
  mutate(genus = str_split(taxon, "_") %>% map_chr(1)) %>%
  group_by(genus) %>%
  add_count() %>%
  group_by(genus, n) %>%
  summarize(total_apo = sum(apomict), .groups = "drop") %>%
  mutate(percent_apo = total_apo / n) %>%
  arrange(desc(percent_apo))

percent_apo_genus %>%
  filter(total_apo > 1) %>%
  group_by(genus) %>%
  summarize(
    n = mean(n),
    total_apo = mean(total_apo),
    percent_apo = mean(percent_apo),
    .groups = "drop"
  ) %>%
  mutate(
    genus =  paste0("*", genus, "*"),
    genus = fct_reorder(genus, percent_apo),
    label = glue::glue("{total_apo}/{n}")) %>%
  ggplot(aes(x = percent_apo, y = genus)) + 
  geom_col() +
  geom_text(aes(label = label), hjust = -.3) +
  scale_x_continuous(labels = percent, limits = c(0, .85)) +
  labs(x = "% apomictic taxa") +
  theme(
    axis.text.y = element_markdown(),
    axis.title.y = element_blank()
  )
```

**`r s_figure("apo-genus")`**. Rate of apomixis in genera of native, non-hybrid Japanese ferns with > 1 apomictic taxon. Numbers next to each bar show number of apomictic taxa out of total richness per genus.

\clearpage

```{r modelfit-not-ult, fig.width = 7, fig.height = 3}
# Extract dataset used for model, including significance columns
biodiv_ferns_used_for_model <- biodiv_ferns_spatial %>%
  # drop geometry (only need centroids for modeling)
  st_set_geometry(NULL) %>%
  as_tibble() %>%
  # filter to only sites used in model
  inner_join(
    biodiv_ferns_cent %>% as_tibble() %>% select(grids),
    by = "grids"
  )

# Generate final plot
modelfit_plot_list <- 
  model_fits_not_ult %>%
  mutate(
    signif_var = str_replace_all(resp_var, "_obs_z", "_signif"),
    resp_var_print = case_when(
      resp_var == "richness" ~ "Richness (no. spp.)",
      TRUE ~ str_to_upper(resp_var) %>% word(1, 1, "_") %>% paste("SES of", .)
    ),
    model_data = list(biodiv_ferns_used_for_model),
    signif_cols = list(signif_cols)) %>%
  left_join(model_subplot_order, by = c("resp_var", "indep_var")) %>%
  arrange(order) %>%
  pmap(plot_fits)

# Need one subplot with a legend
modelfit_plot_list[[2]] <- modelfit_plot_list[[2]] +
  theme(legend.position = "right") +
  labs(color = "Significance") +
  # Increase size of points in legend
  guides(colour = guide_legend(override.aes = list(size = 1.5)))

wrap_plots(modelfit_plot_list) +
  guide_area() +
  plot_layout(guides = "collect") +
  plot_annotation(tag_levels = "a",
                  tag_prefix = "(",
                  tag_suffix = ")") &
  theme(plot.tag = element_text(face = "bold"))
```

**`r s_figure("modelfit-not-ult")`**. Relationship between (a) phylogenetic diversity (PD) and (b) relative PD and % apomictic taxa, models inferred using phylogeny with branchlengths in units of expected genetic change (untransformed ML tree). Ribbon shows 95% confidence interval of model. Line fit with the focal predictor variable while averaging over other predictors. For RPD, the standard effect size (SES) was calculated by comparing raw values to a null distribution of 999 random values, and significance (*P*-value) calculated using a two-tailed test (see Materials and Methods).

\clearpage

```{r bioregions-env, fig.width = 7, fig.height = 5}
# Make pot showing bioregions by temperature and precipitation
a <-
  ggplot(biodiv_ferns_spatial, aes(x = precip, y = temp, color = taxonomic_cluster)) +
  geom_point(size = 1, alpha = 0.7) +
  scale_color_manual(values = bioregion_cols) +
  scale_y_continuous(labels = function(x) x/10) +
  labs(y = "Temperature (°C)", x = "Precipitation (mm)", color = "Cluster", subtitle = "Taxonomic bioregions") +
  theme(legend.position = "bottom")

b <-
  ggplot(biodiv_ferns_spatial, aes(x = precip, y = temp, color = phylo_cluster)) +
  geom_point(size = 1, alpha = 0.7) +
  scale_color_manual(values = bioregion_cols) +
  scale_y_continuous(labels = function(x) x/10) +
  labs(y = "Temperature (°C)", x = "Precipitation (mm)", color = "Cluster", subtitle = "Phylogenetic bioregions") +
  theme(legend.position = "bottom")

a + b + plot_annotation(tag_levels = "a",
                        tag_prefix = "(",
                        tag_suffix = ")") &
  theme(plot.tag = element_text(face = "bold"))
```

**`r s_figure("bioregions-env")`**. Scatterplots of grid cell membership in (a) taxonomic or (b) phylogenetic bioregions arranged by mean annual temperature and annual precipitation. Points shown with partial transparency; darker areas indicate overlapping points.

\clearpage

## References