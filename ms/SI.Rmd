---
title: "Exploring dimensions of biodiversity in Japanese ferns"
bibliography: "main_library.bib"
mainfont: Roboto-Regular.ttf
fontsize: 11pt
mainfontoptions: 
- BoldFont=Roboto-Bold.ttf
- ItalicFont=Roboto-Italic.ttf
- BoldItalicFont=Roboto-BoldItalic.ttf
output: 
  bookdown::pdf_document2:
    citation_package: none # Use pandoc default, otherwise csl can't be used for reference formatting
    toc: no
    number_sections: no
    fig_caption: yes
    keep_tex: no
    latex_engine: xelatex
    pandoc_args: [ "--csl", "journal-of-biogeography.csl"]
    includes:
      in_header: newphyt.sty
header-includes: 
  \usepackage{float}
  \makeatletter\renewcommand*{\fps@figure}{H}\makeatother
editor_options: 
  chunk_output_type: console
# nocite: | 
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, results = "hide", cache = FALSE)
```

```{r load-data, cache = FALSE}
# NOTE: This Rmd is meant to be knit as part of the drake plan (R/plan.R).
# If using interactively, run `source("_drake.R")` first.

loadd(list = c(
  "comm_scaled_list_0.1",
  "comm_scaled_list_0.2",
  "comm_scaled_list_0.3",
  "comm_scaled_list_0.4",
  "occ_point_data_ferns",
  "biodiv_ferns_spatial",
  "biodiv_ferns_endemic_spatial",
  "k_taxonomy",
  "k_phylogeny",
  "traits_nmds",
  "ppgi"
),
cache = ja_fern_cache)

# Load captions
source(here::here("ms/captions.R"))
```

<!-- Remove page numbers -->
\pagenumbering{gobble}

<!-- Set left justification -->
\raggedright

<!-- Don't indent -->
\setlength{\parindent}{0ex}

# Supplemental Information

```{r sampling-curve, fig.width = 4, fig.height = 3}
# Format fern abundances (no hybrids) as numeric vector
fern_abun <-
  occ_point_data_ferns %>%
  group_by(taxon) %>%
  count(sort = TRUE) %>%
  pull(n)

# Run iNEXT
inext_out <- iNEXT::iNEXT(fern_abun, q=0, datatype="abundance")

# create subset of observed points to add to plot as dots
observed_data <- inext_out$iNextEst[inext_out$iNextEst$method == "observed",]

# check estimated completeness
est_completeness <- inext_out$iNextEst %>% filter(method == "observed") %>% pull(SC) %>% scales::percent()
rich_interval <- glue::glue("{observed_data$qD.LCL %>% round} to {observed_data$qD.UCL %>% round}")
completeness_interval <- glue::glue("{observed_data$SC.LCL %>% scales::percent()} to {observed_data$SC.UCL %>% scales::percent()}")

# Make iNEXT plot
inext_out$iNextEst %>%
  filter(method != "observed") %>%
  ggplot(aes(x=m, y=qD)) +
  geom_ribbon(aes(ymin = qD.LCL, ymax = qD.UCL), fill = "grey70") +
  geom_line(aes(linetype=method), size=0.8) +
  scale_linetype_manual(values=c("dotted", "solid", "solid")) +
  geom_point(data=observed_data, size=3) +
  scale_y_continuous("Richness") +
  scale_x_continuous("No. specimens") +
  theme_minimal() +
  theme(
    legend.position="bottom", 
    legend.title=element_blank()
  )

ggsave(result_file(s_figure("sampling-curve"), "pdf"), width = 4, height = 3, units = "in")
```

**`r s_figure("sampling-curve")`**. `r s_figure_cap("sampling-curve")` Grey shading indicates 95% confidence interval (not visible where it does not extend beyond the fitted line). Point indicates observed taxonomic richness (`r observed_data$qD` taxa, 95% confidence interval `r rich_interval` taxa). Taxa include species, subspecies, and varieties, excluding hybrids. Sampling completeness is estimated to be `r est_completeness` (95% confidence interval `r completeness_interval`).

\clearpage

```{r grain-size, fig.width = 7, fig.height = 3}
# Helper function to format resolution labels
degree_lab <- function (x) {
  as.numeric(x) %>% 
    scales::number(suffix = "\u00b0", accuracy = 0.1)
}

# Combine results of building community matrices at different grain sizes
redundancy_by_res <- 
  list(
    "0.1" = comm_scaled_list_0.1$poly_shp,
    "0.2" = comm_scaled_list_0.2$poly_shp,
    "0.3" = comm_scaled_list_0.3$poly_shp,
    "0.4" = comm_scaled_list_0.4$poly_shp) %>%
  map_df(~as_tibble(.) %>% select(grids, abundance, richness), .id = "res") %>%
  # Calculate redundancy
  mutate(redundancy = 1 - (richness/abundance))

# Summarize redundancy statistics by grain size
redundancy_summary <-
  redundancy_by_res %>%
  mutate(above_50 = ifelse(redundancy > 0.5, 1, 0)) %>%
  mutate(singleton = ifelse(redundancy == 0, 1, 0)) %>%
  group_by(res) %>%
  summarize(
    n_total = n(),
    n_above_50 = sum(above_50),
    n_singletons = sum(singleton),
    percent_above_50 = n_above_50/n_total,
    percent_singletons = n_singletons/ n_total,
    .groups = "drop"
  )

# Percent of grid cells with redundancy > 0.5 by grain size
a <- ggplot(redundancy_summary, aes(x = res, y = percent_above_50)) +
  geom_col() +
  scale_y_continuous(labels = scales::percent) +
  scale_x_discrete(labels = degree_lab) +
  labs(
    x = "Resolution",
    y = "Redundancy > 0.5"
  )

# Percent of grid cells with redundancy = 0 by grain size
b <- ggplot(redundancy_summary, aes(x = res, y = percent_singletons)) +
  geom_col() +
  scale_y_continuous(labels = scales::percent) +
  scale_x_discrete(labels = degree_lab) +
  labs(
    x = "Resolution",
    y = "Redundancy = 0"
  )

# Distribution of redundancy by grain size
c <- ggplot(redundancy_by_res, aes(x = redundancy, y = res)) +
  geom_density_ridges(scale = 1.5) + 
  scale_y_discrete(expand = c(0, 0), labels = degree_lab) +     # will generally have to set the `expand` option
  scale_x_continuous(expand = c(0, 0)) +   # for both axes to remove unneeded padding
  coord_cartesian(clip = "off") + # to avoid clipping of the very top of the top ridgeline
  labs(
    x = "Redundancy",
    y = "Resolution"
  )

a + b + c +
  plot_annotation(tag_levels = 'A')

ggsave(result_file(s_figure("grain-size"), "pdf"), width = 7, height = 3, units = "in")
```

**`r s_figure("grain-size")`**. `r s_figure_cap("grain-size")` **A**, Percent of grid cells with redundancy > 0.5 by grain size (0.1, 0.2, 0.3, or 0.4 degree grid-cells). **B**, Percent of grid cells with redundancy = 0 by grain size. **C**, Distribution of redundancy values by grain size. There is a sudden improvement in redundancy values from 0.1 to 0.2 degree grid-cells, but less improvement as grain size is increased beyond 0.2 degrees.

\clearpage

```{r k-plot, fig.width = 7, fig.height = 3}
a <- k_taxonomy$df %>%
  as_tibble() %>%
  mutate(
    optimal_auto = ifelse(k == k_taxonomy$optimal$k, TRUE, FALSE),
    label = ifelse(k == k_taxonomy$optimal$k, glue::glue("k = {k}"), "")
  ) %>%
  ggplot(aes(x = k, y = ev)) +
  geom_path() +
  geom_point(aes(color = optimal_auto), size = 2.5) +
  geom_text(aes(label = label), vjust = 0, nudge_y = 0.02, size = 4) +
  scale_color_manual(values = c("TRUE" = "#E31A1C", "FALSE" = "black")) +
  labs(
    y = "Explained variance",
    x = "Number of clusters") +
  theme(
    legend.position = "none"
  )

k_phylogeny_select <- 8

b <- k_phylogeny$df %>%
  as_tibble() %>%
  mutate(
    optimal_auto = ifelse(k == k_phylogeny$optimal$k, TRUE, FALSE),
    label = ifelse(k == k_phylogeny$optimal$k, glue::glue("k = {k}"), "")
  ) %>%
  ggplot(aes(x = k, y = ev)) +
  geom_path() +
  geom_point(aes(color = optimal_auto), size = 2.5) +
  geom_text(aes(label = label), vjust = 0, nudge_y = 0.02, size = 4) +
  scale_color_manual(values = c("TRUE" = "#E31A1C", "FALSE" = "black")) +
  labs(
    y = "Explained variance",
    x = "Number of clusters") +
  theme(
    legend.position = "none"
  )

a + b +
  plot_layout(ncol = 2) +
  plot_annotation(tag_levels = 'A')

ggsave(result_file(s_figure("k-plot"), "pdf"), width = 7, height = 3, units = "in")
```

**`r s_figure("k-plot")`**. `r s_figure_cap("k-plot")` **A**, taxonomic bioregions. **B**, phylogenetic bioregions. Color indicates optimal *k* selected selected by \function{optimal{\_}phyloregion} function in the R package \package{phyloregion} (black, non-optimal; red, optimal; see Methods).

\clearpage

```{r endemism-restricted, fig.width = 7, fig.height = 8}
# PE (endemic)
# FIXME: cells with zero species should be NA, not zero PE
a <- ggplot(ses_div_ferns_endemic_spatial, aes(fill = pe_obs)) +
  geom_sf(color = "transparent") +
  scale_fill_scico(palette = "lajolla") + 
  labs(fill = "PE") +
  scale_y_continuous(labels = scales::label_number(suffix = "\u00b0N", accuracy = 1)) +
  scale_x_continuous(labels = scales::label_number(suffix = "\u00b0E", accuracy = 1)) +
  map_theme() +
  theme(
    axis.text.x = element_blank()
  )

# SES PE (endemic)
# FIXME: cells with zero species should be NA, not zero PE
b <- ggplot(ses_div_ferns_endemic_spatial, aes(fill = pe_obs_p_upper)) +
  geom_sf(color = "transparent") +
  labs(fill = "PE p-score") +
  scale_fill_scico(palette = "lajolla") +
  scale_y_continuous(labels = scales::label_number(suffix = "\u00b0N", accuracy = 1)) +
  scale_x_continuous(labels = scales::label_number(suffix = "\u00b0E", accuracy = 1)) +
  map_theme() +
  theme(
    axis.text.x = element_blank(),
    axis.text.y = element_blank()
  )

# RPE
c <- ggplot(ses_div_ferns_endemic_spatial, aes(fill = rpe_obs)) +
  geom_sf(color = "transparent") +
  scale_fill_scico(palette = "lajolla") + 
  labs(fill = "RPE") +
  scale_y_continuous(labels = scales::label_number(suffix = "\u00b0N", accuracy = 1)) +
  scale_x_continuous(labels = scales::label_number(suffix = "\u00b0E", accuracy = 1)) +
  map_theme_light() +
  theme(
    axis.text.x = element_blank()
  )

# SES RPE
d <- ggplot(ses_div_ferns_endemic_spatial, aes(fill = rpe_obs_z)) +
  geom_sf(color = "transparent") +
  labs(fill = "SES RPE") +
  scale_fill_scico(
    palette = "roma",
    na.value="grey80",
    direction = -1,
    limits = c(
      -get_limit(ses_div_ferns_endemic_spatial, rpe_obs_z, "abs"),
      get_limit(ses_div_ferns_endemic_spatial, rpe_obs_z, "abs")
    )) +
  scale_y_continuous(labels = scales::label_number(suffix = "\u00b0N", accuracy = 1)) +
  scale_x_continuous(labels = scales::label_number(suffix = "\u00b0E", accuracy = 1)) +
  map_theme() +
  theme(axis.text.y = element_blank())

# CANAPE, restricted dataset
# set color scheme
canape_cols <- c(
  "neo" = "#E41A1C", # Color brewer set1 red
  "paleo" = "#377EB8", # Color brewer blue
  "mixed" = "#984EA3", # Color brewer purple
  "none" = "#FFFFCC" # Scico lajolla faintest color
)

e <- ses_div_ferns_endemic_spatial %>%
  mutate(endem_type = replace_na(endem_type, "none")) %>%
  ggplot(aes(fill = endem_type)) +
  geom_sf(color = "transparent") +
  labs(fill = "Endemism\ntype") +
  scale_fill_manual(values = canape_cols, breaks = c("neo", "paleo", "mixed", "none"), labels = c("Neo", "Paleo", "Mixed", "Not endemic")) + 
  scale_y_continuous(labels = scales::label_number(suffix = "\u00b0N", accuracy = 1)) +
  scale_x_continuous(labels = scales::label_number(suffix = "\u00b0E", accuracy = 1)) +
  map_theme_light()


a + b + c + d + e +
  plot_layout(ncol = 2) +
  plot_annotation(tag_levels = 'A')

ggsave(result_file(s_figure("endemism-restricted"), "pdf"), width = 7, height = 8, units = "in")
```

**`r s_figure("endemism-restricted")`**. `r s_figure_cap("endemism-restricted")` **A**, phylogenetic endemism (PE). **B**, Standard effect size (SES) of PE. **C**, relative phylogenetic endemism (RPE). **D**, SES of RPE. **E**, Categorical analysis of neo- and paleo-endemism (CANAPE).

\clearpage

```{r biplot-prep}
# Extract centroids
centroids <- sf::st_centroid(ses_div_ferns_spatial$geometry) %>%
  sf::st_coordinates()

# Define helper function for making a scatterplot
scatterplot <- function(data, x_var, y_var, x_lab, y_lab, label, annotate, loc) {
  p <- ggplot(data, aes(x = .data[[x_var]], y = .data[[y_var]])) +
    geom_point(alpha = 0.5) +
    labs(
      x = x_lab,
      y = y_lab
    )
  
  # Add annotation and trendline if annotate = TRUE
  if(annotate & loc == "UL") p <- p +
      annotate("label", x = -Inf, y = Inf, label = label, hjust = 0, vjust = 1, label.size = 0, size = 3, fill = "transparent") +
      geom_smooth(method = "lm", se = FALSE, color = "blue", size = 0.5)
  
  if(annotate & loc == "UR") p <- p +
      annotate("label", x = Inf, y = Inf, label = label, hjust = 1, vjust = 1, label.size = 0, size = 3, fill = "transparent") +
      geom_smooth(method = "lm", se = FALSE, color = "blue", size = 0.5)
  
  if(annotate & loc == "LL") p <- p +
      annotate("label", x = -Inf, y = -Inf, label = label, hjust = 0, vjust = 0, label.size = 0, size = 3, fill = "transparent") +
      geom_smooth(method = "lm", se = FALSE, color = "blue", size = 0.5)
  
  if(annotate & loc == "LR") p <- p +
      annotate("label", x = Inf, y = -Inf, label = label, hjust = 1, vjust = 0, label.size = 0, size = 3, fill = "transparent") +
      geom_smooth(method = "lm", se = FALSE, color = "blue", size = 0.5)
  
  p
}
```


```{r raw-biplot, fig.width = 8, fig.height = 10.5}
## Biplots of raw metrics ##

# Set up x and y variables as factors so they can be ordered appropriately in the plot
x_vars <-
  c("pd_obs", "rpd_obs", "fd_obs", "rfd_obs", "pe_obs", "rpe_obs", "richness") %>%
  factor() %>%
  fct_relevel(as.character(.))

y_vars <- c("pd_obs", "rpd_obs", "fd_obs", "rfd_obs", "pe_obs", "rpe_obs") %>%
  factor() %>%
  fct_relevel(as.character(.))

# Make dataframe of arguments to feed into plotting function
# - includes all non-duplicated combinations of raw diversity metrics
raw_comparisons <-
  cross_df(
    list(
      x_var = x_vars,
      y_var = y_vars
    ),
    .filter = `==` # filter out exact duplicates
  ) %>%
  # Remove reversed duplicates
  # https://stackoverflow.com/questions/22756392/deleting-reversed-duplicates-with-r
  group_by(grp = paste(pmax(as.character(x_var), as.character(y_var)), pmin(as.character(x_var), as.character(y_var)), sep = "_")) %>%
  arrange(x_var, y_var) %>%
  slice(1) %>%
  ungroup() %>%
  select(-grp) %>%
  arrange(x_var, y_var) %>%
  # Convert x_var and y_var back to character for plotting function
  mutate(across(c(x_var, y_var), as.character)) %>%
  # Add labels
  mutate(
    x_lab = case_when(
      x_var == "pd_obs" ~ "PD",
      x_var == "rpd_obs" ~ "RPD",
      x_var == "fd_obs" ~ "FD",
      x_var == "rfd_obs" ~ "RFD",
      x_var == "pe_obs" ~ "PE",
      x_var == "rpe_obs" ~ "RPE",
      x_var == "richness" ~ "Richness"
    ),
    y_lab = case_when(
      y_var == "pd_obs" ~ "PD",
      y_var == "rpd_obs" ~ "RPD",
      y_var == "fd_obs" ~ "FD",
      y_var == "rfd_obs" ~ "RFD",
      y_var == "pe_obs" ~ "PE",
      y_var == "rpe_obs" ~ "RPE"
    )
  ) %>%
  # Run modified t-test
  mutate(
    test_res = map2(
      .x = x_var, 
      .y = y_var, 
      ~SpatialPack::modified.ttest(ses_div_ferns_spatial[[.x]], ses_div_ferns_spatial[[.y]], centroids)),
    # Extract relevant stats from results
    cor = map_dbl(test_res, pluck("corr")),
    pval = map_dbl(test_res, pluck("p.value"))
    ) %>%
  # Generate label
  mutate(
    cor_lab = glue("r = {round(cor, 3)}"),
    pval_lab = case_when(
      pval < 0.001 ~ "***",
      pval < 0.01 ~ "**",
      pval < 0.05 ~ "*",
      TRUE ~ ""
    ),
    label = glue::glue("{cor_lab}{pval_lab}")
  ) %>%
  # Specify which plots to annotate
  mutate(
    annotate = case_when(
      pval < 0.05 ~ TRUE,
      TRUE ~ FALSE
    ),
    # annotate in upper-right corner for mpd_morph_obs + rpe_obs,
    # upper-left otherwise
    loc = case_when(
      y_var == "mpd_morph_obs" & x_var == "rpe_obs" ~ "UR",
      TRUE ~ "UL"
    )
  ) %>%
  select(x_var, y_var, x_lab, y_lab, label, annotate, loc)
  
# Make plot
pmap(raw_comparisons, scatterplot, data = ses_div_ferns_spatial) %>%
wrap_plots() +
  plot_layout(ncol = 3)

ggsave(result_file(s_figure("raw-biplot"), "pdf"), width = 8, height = 10.5, units = "in")
```

**`r s_figure("raw-biplot")`**. `r s_figure_cap("raw-biplot")` MPD, mean phylogenetic distance; MMD, mean morphological distance; PD, phylogenetic diversity; PE, phylogenetic endemism; RPE, relative phylogenetic endemism. Correlations between variables analyzed with Dutilleul's modified *t*-test that accounts for spatial structure in the data; *p* value and correlation (r) only shown for *p* < 0.05.

\clearpage

```{r ses-biplot, fig.width = 8, fig.height = 10.5}
## Biplots of SES metrics ##

# Set up x and y variables as factors so they can be ordered appropriately in the plot
x_vars <-
  c("pd_obs_z", "rpd_obs_z", "fd_obs_z", "rfd_obs_z", "pe_obs_z", "rpe_obs_z", "richness") %>%
  factor() %>%
  fct_relevel(as.character(.))

y_vars <- c("pd_obs_z", "rpd_obs_z", "fd_obs_z", "rfd_obs_z", "pe_obs_z", "rpe_obs_z") %>%
  factor() %>%
  fct_relevel(as.character(.))

# Make dataframe of arguments to feed into plotting function
# - includes all non-duplicated combinations of raw diversity metrics
ses_comparisons <-
  cross_df(
    list(
      x_var = x_vars,
      y_var = y_vars
    ),
    .filter = `==` # filter out exact duplicates
  ) %>%
  # Remove reversed duplicates
  # https://stackoverflow.com/questions/22756392/deleting-reversed-duplicates-with-r
  group_by(grp = paste(pmax(as.character(x_var), as.character(y_var)), pmin(as.character(x_var), as.character(y_var)), sep = "_")) %>%
  arrange(x_var, y_var) %>%
  slice(1) %>%
  ungroup() %>%
  select(-grp) %>%
  arrange(x_var, y_var) %>%
  # Convert x_var and y_var back to character for plotting function
  mutate(across(c(x_var, y_var), as.character)) %>%
  # Add labels
  mutate(
    x_lab = case_when(
      x_var == "pd_obs_z" ~ "SES PD",
      x_var == "rpd_obs_z" ~ "SES RPD",
      x_var == "fd_obs_z" ~ "SES FD",
      x_var == "rfd_obs_z" ~ "SES RFD",
      x_var == "pe_obs_z" ~ "SES PE",
      x_var == "rpe_obs_z" ~ "SES RPE",
      x_var == "richness" ~ "Richness"
    ),
    y_lab = case_when(
      y_var == "pd_obs_z" ~ "SES PD",
      y_var == "rpd_obs_z" ~ "SES RPD",
      y_var == "fd_obs_z" ~ "SES FD",
      y_var == "rfd_obs_z" ~ "SES RFD",
      y_var == "pe_obs_z" ~ "SES PE",
      y_var == "rpe_obs_z" ~ "SES RPE"
    )
  ) %>%
  # Run modified t-test
  mutate(
    test_res = map2(
      .x = x_var, 
      .y = y_var, 
      ~SpatialPack::modified.ttest(ses_div_ferns_spatial[[.x]], ses_div_ferns_spatial[[.y]], centroids)),
    # Extract relevant stats from results
    cor = map_dbl(test_res, pluck("corr")),
    pval = map_dbl(test_res, pluck("p.value"))
    ) %>%
  # Generate label
  mutate(
    cor_lab = glue("r = {round(cor, 3)}"),
    pval_lab = case_when(
      pval < 0.001 ~ "***",
      pval < 0.01 ~ "**",
      pval < 0.05 ~ "*",
      TRUE ~ ""
    ),
    label = glue::glue("{cor_lab}{pval_lab}")
  ) %>%
  # Specify which plots to annotate
  mutate(
    annotate = case_when(
      pval < 0.05 ~ TRUE,
      TRUE ~ FALSE
    ),
    # annotate in upper-right corner for mpd_morph_obs + rpe_obs,
    # upper-left otherwise
    loc = case_when(
      y_var == "rpe_obs_z" & x_var == "pe_obs_z" ~ "LR",
      y_var == "fd_obs_z" & x_var == "richness" ~ "UR",
      y_var == "pd_obs_z" & x_var == "richness" ~ "UR",
      TRUE ~ "UL"
    )
  ) %>%
  select(x_var, y_var, x_lab, y_lab, label, annotate, loc)

# Make plot
pmap(ses_comparisons, scatterplot, data = ses_div_ferns_spatial) %>%
wrap_plots() +
  plot_layout(ncol = 3)

ggsave(result_file(s_figure("ses-biplot"), "pdf"), width = 8, height = 10.5, units = "in")
```

**`r s_figure("ses-biplot")`**. `r s_figure_cap("ses-biplot")` MPD, mean phylogenetic distance; MMD, mean morphological distance; PD, phylogenetic diversity; PE, phylogenetic endemism; RPE, relative phylogenetic endemism. Correlations between variables analyzed with Dutilleul's modified *t*-test that accounts for spatial structure in the data; *p* value and correlation (r) only shown for *p* < 0.05.

\clearpage

```{r trait-space, fig.width = 8, fig.height = 8}
# Extract points, join to PPGI
nmds_points <- traits_nmds[["points"]] %>%
  as.data.frame %>%
  rownames_to_column("taxon") %>%
  as_tibble %>%
  mutate(genus = str_split(taxon, "_") %>% map_chr(1)) %>%
  left_join(ppgi, by = "genus") %>%
  mutate(
    order = factor(order),
    family = factor(family))

# A: all ferns
a <- ggplot(nmds_points, aes(x = MDS1, y = MDS2, color = order, shape = order)) +
  geom_point() +
  scale_shape_manual(values = 1:n_distinct(nmds_points$order)) +
  labs(title = "A. Ferns")

# B: Polypods only
nmds_points_polypod <- filter(nmds_points, order == "Polypodiales")

b <- ggplot(nmds_points_polypod, aes(x = MDS1, y = MDS2, color = family, shape = family)) +
  geom_point() +
  scale_shape_manual(values = 1:n_distinct(nmds_points_polypod$family)) +
  labs(title = "B. Polypodiales") +
  guides(
    color = guide_legend(ncol = 2),
    shape = guide_legend(ncol = 2))

a + b + 
  plot_layout(nrow = 2)

ggsave(result_file(s_figure("traits-nmds"), "pdf"), width = 8, height = 8, units = "in")
```

**`r s_figure("traits-nmds")`**. `r s_figure_cap("traits-nmds")` Interspecific trait distances calculated using Gower's method with 16 traits, then projected into trait space using nonmetric multidimensional scaling (NMDS). **A**, All ferns. **B**, Polypodiales. Taxonomy follows PPGI.
