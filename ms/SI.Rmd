---
title: "Exploring dimensions of biodiversity in Japanese ferns"
date: '`r format(Sys.time(), "%d %B, %Y")`'
mainfont: Roboto-Regular.ttf
fontsize: 11pt
mainfontoptions: 
  - BoldFont=Roboto-Bold.ttf
  - ItalicFont=Roboto-Italic.ttf
  - BoldItalicFont=Roboto-BoldItalic.ttf
output: 
  bookdown::pdf_document2:
    citation_package: default
    toc: no
    number_sections: no
    fig_caption: yes
    keep_tex: yes
    latex_engine: xelatex
    pandoc_args: [ "--csl", "journal-of-biogeography.csl"]
header-includes: 
  \usepackage{float}
  \makeatletter\renewcommand*{\fps@figure}{H}\makeatother
editor_options: 
  chunk_output_type: console
params:
  doc_type: pdf
# nocite: | 
---

---
bibliography:
  - `r here::here("ms/references.yaml")`
  - `r here::here("ms/references_other.yaml")`
---

```{r setup-si, include = FALSE, cache = FALSE}
# Load functions only used when rendering Rmds
source(here::here("R/ms_functions.R"), local = TRUE)
# Set knitr options
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, results = "hide", cache = FALSE)

# Load packages only used when knitting Rmd
library(kableExtra)
```

```{r libraries-no-run-in-plan, eval = FALSE}
# This Rmd is meant to be knit as part of the target plan (R/_targets.R).
# Run the lines below if rendering outside of targets plan
library(targets)
library(tarchetypes)
source(here::here("R/packages.R"))
source(here::here("R/functions.R"))
```

```{r load-data-si, cache = FALSE}
tar_load(c(
  "japan_shp",
  "comm_scaled_list",
  "occ_point_data_ferns",
  "biodiv_ferns_spatial",
  "biodiv_ferns_endemic_spatial",
  "k_taxonomy",
  "k_phylogeny",
  "traits_nmds",
  "ppgi",
  "phy_sig_results",
  "binary_sig_results",
  "lrt_results",
  "japan_shp"
))
```

```{r load-captions}
# Source captions numbers from MS
# 
# So that caption numbers are in order of appearance in MS

# Run inline code when purling
options(knitr.purl.inline = TRUE)

# Make a temporary file to write out just inline R code from the SI Rmd
temp_file <- tempfile()

# Generate R script including inline R code from the ms Rmd
knitr::purl(here::here("ms/manuscript.Rmd"), output = temp_file)

# Trim this R script down to only functions that define figure and table captions
read_lines(temp_file) %>%
  magrittr::extract(
    str_detect(., "^figure\\(|^table\\(|^s_figure\\(|^s_table\\(|^figure_num\\(|^table_num\\(|^s_figure_num\\(|^s_table_num\\(")
  ) %>%
  unique %>%
  write_lines(temp_file)

# Source the code. This will load the caption functions in the right order.
source(temp_file, local = TRUE)

# Delete the temporary file
fs::file_delete(temp_file)
```

<!-- Remove page numbers -->
\pagenumbering{gobble}

<!-- Set left justification -->
\raggedright

<!-- Don't indent -->
\setlength{\parindent}{0ex}

# Supplemental Information

```{r phy-sig, results = "as-is"}
phy_sig_results %>%
  mutate(across(c(kval, lambda, k_pval, lambda_pval), ~format(., digits = 2))) %>%
  kbl(booktabs = TRUE) %>%
  kable_styling(latex_options = c("striped", "HOLD_position"))
```

**`r s_table("phy-sig")`**. Phylogenetic signal in continuous functional traits of the ferns of Japan. *K*, Blomberg's *K*; λ, Pagel's λ.

\clearpage

```{r phy-sig-binary, results = "as-is"}
binary_sig_results %>%
  select(trait, D, num_present, num_absent, prob_random, prob_brownian) %>%
  arrange(trait) %>%
  mutate(across(c(D, prob_random, prob_brownian), ~format(., digits = 2))) %>%
  kbl(booktabs = TRUE) %>%
  kable_styling(latex_options = c("striped", "scale_down", "HOLD_position"))
```

**`r s_table("phy-sig-binary")`**. Phylogenetic signal in quantitative (binary) functional traits of the ferns of Japan. D, Fritz and Purvis' *D*; *n* (present), number of times a trait was observed present; *n* (absent), number of times a trait was observed absent; *p* (random), probability of obtaining observed trait distribution given random distribution of traits; *p* (Brownian), probability of obtaining observed trait distribution given random evolution by Brownian Motion. Presence or absence of indusium was originally a binary trait; other traits (margin, shape, texture) are qualitative traits scored in binary format.

\clearpage

```{r lrt-null, results = "as-is"}
lrt_table_data <-
lrt_results %>%
  filter(comparison == "null_model") %>%
  select(-null_formula, -comparison) %>%
  tidyr::extract(full_formula, "model_type", "~ ([^ ]+) ") %>%
  rename_resp_vars %>%
  rename_model_type %>%
  select(model_type, resp_var, chi2_LR, df, loglik_null, loglik_full, p_value) %>%
  arrange(model_type, resp_var) %>%
  mutate(across(where(is.double), ~format(., digits = 2)))
  
lrt_table_data %>%
  select(-model_type) %>%
  kbl(
    col.names = colnames(.) %>% str_replace_all("resp_var", ""),
    booktabs = TRUE) %>%
  pack_rows(index = base::table(lrt_table_data$model_type)) %>%
  kable_styling(latex_options = c("striped", "HOLD_position"))
```

**`r s_table("lrt-null")`**. Likelihood ratio test (LRT) between full model and null model (model only including the spatial Matérn correlation matrix). Higher (less negative) log likelihood indicates better fit. Full environmental models included the effects of temperature, precipitation, precipitation seasonality, and area. Full reproductive models included the effects of % apomictic taxa, precipitation, precipitation seasonality, and area. PD, phylogenetic diversity; RPD, relative phylogenetic diversity; FD, functional diversity; RFD, relative functional diversity; SES, standard effect size.

\clearpage

```{r map-plot-prep}
# Change cluster to factor
biodiv_ferns_spatial <- biodiv_ferns_spatial %>%
  mutate(taxonomic_cluster = as.factor(taxonomic_cluster) %>% fct_infreq %>% as.numeric %>% as.factor) %>%
  mutate(phylo_cluster = as.factor(phylo_cluster) %>% fct_infreq %>% as.numeric %>% as.factor) %>%
  # Add redundancy
  mutate(redundancy = 1 - (richness/abundance))

# Download high-res map of Japan,
# crop to spatial div results area
japan <- sf::st_crop(japan_shp, sf::st_bbox(biodiv_ferns_spatial))

# Set CRS
japan_crs <- sf::st_crs(japan)

biodiv_ferns_endemic_spatial <- sf::st_set_crs(biodiv_ferns_endemic_spatial, japan_crs)

biodiv_ferns_spatial <- sf::st_set_crs(biodiv_ferns_spatial, japan_crs)

# Set color palettes
# Randomization test significance
signif_cols <-
  c(
    "> 0.99" = "#e31a1c", 
    "> 0.975" = "#fb9a99",
    "< 0.01" = "#1f78b4", 
    "< 0.025" = "#a6cee3",
    "not significant" = "#ffffcc"
  )

# CANAPE
canape_cols <-
  c(
    "neo" = "#e31a1c", 
    "paleo" = "#1f78b4",
    "mixed" = "#6a51a3",
    "super" = "#4a1486",
    "not significant" = "#ffffcc"
  )
```

```{r sampling-curve, fig.width = 4, fig.height = 3}
# Format fern abundances (no hybrids) as numeric vector
fern_abun <-
  occ_point_data_ferns %>%
  group_by(taxon) %>%
  count(sort = TRUE) %>%
  pull(n)

# Run iNEXT
inext_out <- iNEXT::iNEXT(fern_abun, q=0, datatype="abundance")

# create subset of observed points to add to plot as dots
observed_data <- inext_out$iNextEst[inext_out$iNextEst$method == "observed",]

# check estimated completeness
est_completeness <- inext_out$iNextEst %>% filter(method == "observed") %>% pull(SC) %>% scales::percent()
rich_interval <- glue::glue("{observed_data$qD.LCL %>% round} to {observed_data$qD.UCL %>% round}")
completeness_interval <- glue::glue("{observed_data$SC.LCL %>% scales::percent()} to {observed_data$SC.UCL %>% scales::percent()}")

# Make iNEXT plot
inext_out$iNextEst %>%
  filter(method != "observed") %>%
  ggplot(aes(x=m, y=qD)) +
  geom_ribbon(aes(ymin = qD.LCL, ymax = qD.UCL), fill = "grey70") +
  geom_line(aes(linetype=method), size=0.8) +
  scale_linetype_manual(values=c("dotted", "solid", "solid")) +
  geom_point(data=observed_data, size=3) +
  scale_y_continuous("Richness") +
  scale_x_continuous("No. specimens") +
  theme_minimal() +
  theme(
    legend.position="bottom", 
    legend.title=element_blank()
  )

ggsave(result_file(s_figure("sampling-curve"), "pdf"), width = 4, height = 3, units = "in")
```

**`r s_figure("sampling-curve")`**. Species collection curve for the ferns of Japan fit with the `r pack("iNEXT")` package. Grey shading indicates 95% confidence interval (not visible where it does not extend beyond the fitted line). Point indicates observed taxonomic richness (`r observed_data$qD` taxa, 95% confidence interval `r rich_interval` taxa). Taxa include species, subspecies, and varieties, excluding hybrids. Sampling completeness is estimated to be `r est_completeness` (95% confidence interval `r completeness_interval`).

\clearpage

```{r grain-size, fig.width = 7, fig.height = 3}
# Helper function to format resolution labels
degree_lab <- function (x) {
  as.numeric(x) %>% 
    scales::number(suffix = "\u00b0", accuracy = 0.1)
}

# Combine results of building community matrices at different grain sizes
redundancy_by_res <- 
  list(
    "0.1" = comm_scaled_list %>% filter(resol == 0.1) %>% pull(poly_shp) %>% pluck(1),
    "0.2" = comm_scaled_list %>% filter(resol == 0.2) %>% pull(poly_shp) %>% pluck(1),
    "0.3" = comm_scaled_list %>% filter(resol == 0.3) %>% pull(poly_shp) %>% pluck(1),
    "0.4" = comm_scaled_list %>% filter(resol == 0.4) %>% pull(poly_shp) %>% pluck(1)
    ) %>%
  map_df(~as_tibble(.) %>% select(grids, abundance, richness), .id = "res") %>%
  # Calculate redundancy
  mutate(redundancy = 1 - (richness/abundance))

# Summarize redundancy statistics by grain size
redundancy_summary <-
  redundancy_by_res %>%
  mutate(above_50 = ifelse(redundancy > 0.5, 1, 0)) %>%
  mutate(singleton = ifelse(redundancy == 0, 1, 0)) %>%
  group_by(res) %>%
  summarize(
    n_total = n(),
    n_above_50 = sum(above_50),
    n_singletons = sum(singleton),
    percent_above_50 = n_above_50/n_total,
    percent_singletons = n_singletons/ n_total,
    .groups = "drop"
  )

# Percent of grid cells with redundancy > 0.5 by grain size
a <- ggplot(redundancy_summary, aes(x = res, y = percent_above_50)) +
  geom_col() +
  scale_y_continuous(labels = scales::percent) +
  scale_x_discrete(labels = degree_lab) +
  labs(
    x = "Resolution",
    y = "Redundancy > 0.5"
  )

# Percent of grid cells with redundancy = 0 by grain size
b <- ggplot(redundancy_summary, aes(x = res, y = percent_singletons)) +
  geom_col() +
  scale_y_continuous(labels = scales::percent) +
  scale_x_discrete(labels = degree_lab) +
  labs(
    x = "Resolution",
    y = "Redundancy = 0"
  )

# Distribution of redundancy by grain size
c <- ggplot(redundancy_by_res, aes(x = redundancy, y = res)) +
  geom_density_ridges(scale = 1.5) + 
  scale_y_discrete(expand = c(0, 0), labels = degree_lab) +     # will generally have to set the `expand` option
  scale_x_continuous(expand = c(0, 0)) +   # for both axes to remove unneeded padding
  coord_cartesian(clip = "off") + # to avoid clipping of the very top of the top ridgeline
  labs(
    x = "Redundancy",
    y = "Resolution"
  )

a + b + c +
  plot_annotation(tag_levels = 'A')

ggsave(result_file(s_figure("grain-size"), "pdf"), width = 7, height = 3, units = "in")
```

**`r s_figure("grain-size")`**. Effect of grain size on sampling redundancy. **A**, Percent of grid cells with redundancy > 0.5 by grain size (0.1, 0.2, 0.3, or 0.4 degree grid-cells). **B**, Percent of grid cells with redundancy = 0 by grain size. **C**, Distribution of redundancy values by grain size. There is a sudden improvement in redundancy values from 0.1 to 0.2 degree grid-cells, but less improvement as grain size is increased beyond 0.2 degrees.

\clearpage

```{r envir, fig.width = 7, fig.height = 9}

# Restrict sites to only those used in model
# (drops outlier % apomictic site)
biodiv_ferns_for_plotting <-
  biodiv_ferns_spatial %>%
  drop_apo_outlier

# crop high-res map of Japan to spatial div results area
japan <- sf::st_crop(japan_shp, sf::st_bbox(biodiv_ferns_for_plotting))

# Set CRS
japan_crs <- sf::st_crs(japan)
biodiv_ferns_for_plotting <- sf::st_set_crs(biodiv_ferns_for_plotting, japan_crs)

# Define function for plotting environment
plot_env <- function(part, label, var_select, fill_lab = "", labels = ggplot2::waiver()) {
  ggplot() +
    geom_sf(data = japan, fill = "grey90", color = "black", lwd = 0.25) +
    geom_sf(data = biodiv_ferns_for_plotting, aes(fill = .data[[var_select]]), color = "transparent", alpha = 0.8) +
    annotate(
      geom="richtext", y = Inf, x = -Inf, 
      label = glue("<span style='color:black'>**{part}** {label}</span>"), 
      hjust = "inward", vjust = "inward", color = "white") + 
    labs(fill = fill_lab) +
    scale_fill_scico(palette = "lajolla", labels = labels) +
    scale_x_continuous(guide = guide_axis(check.overlap = TRUE)) +
    theme_grey(base_size = 10) +
    theme(
      panel.grid.major = element_line(color = "grey60", size = 0.1),
      panel.grid.minor = element_blank(),
      panel.background = element_rect(fill = "transparent"),
      axis.ticks = element_blank(),
      axis.text = element_text(color = "grey60"),
      axis.title = element_blank(),
      legend.position = "right",
      legend.title = element_markdown()
    )
}

a <- plot_env("A", "Area", "area", "km^2")
b <- plot_env("B", "% apomictic taxa", "percent_apo", labels = function(x) scales::percent(x, accuracy = 1))
c <- plot_env("C", "Precipitation", "precip", "mm")
d <- plot_env("D", "Precip. season.", "precip_season" , "")
e <- plot_env("E", "Temperature", "temp", "°C", function(x) x/10)
f <- plot_env("F", "Temp. season.", "temp_season")

a + b + c + d + e + f + plot_layout(ncol = 2, nrow = 3)

ggsave(result_file(figure("envir"), "pdf"), width = 6, height = 8, units = "in")
```

**`r s_figure("envir")`**. Reproductive mode and environmental data in 0.2 degree grid cells across Japan. **A**, rolling mean area (km^2^) in 1° latitudinal bands.  **B**, % apomictic taxa. **C**, annual precipitation **D**, percipitation seasonality (coefficient of variation).  **E**, mean annual temperature. **F**, temperature seasonality (standard deviation × 100).

\clearpage

```{r abundance, fig.width = 7, fig.height = 5}
k <- scales::unit_format(unit = "k", scale = 1e-3, accuracy = 1, sep = "")
  
a <- ggplot() +
  geom_sf(data = japan, fill = "grey90", color = "black", lwd = 0.25) +
  geom_sf(data = biodiv_ferns_spatial, aes(fill = abundance), color = "transparent", alpha = 0.8) +
  scale_fill_scico(palette = "lajolla", label = k) +
  labs(fill = "No. specimens") +
  annotate(geom="richtext", y = Inf, x = -Inf, label = "<span style='color:black'>**A**</span>", hjust = "inward", vjust = "inward", color = "white") + 
  map_theme()


b <- ggplot() +
  geom_sf(data = japan, fill = "grey90", color = "black", lwd = 0.25) +
  geom_sf(data = biodiv_ferns_spatial, aes(fill = redundancy), color = "transparent", alpha = 0.8) +
  scale_fill_scico(palette = "lajolla") +
  labs(fill = "Redundancy") +
  annotate(geom="richtext", y = Inf, x = -Inf, label = "<span style='color:black'>**B**</span>", hjust = "inward", vjust = "inward", color = "white") + 
  map_theme() +
  theme(
    axis.text.y = element_blank()
  )

a + b + 
  plot_layout(nrow = 1)

ggsave(result_file(figure("abundance"), "pdf"), width = 7, height = 5, units = "in")
```

**`r s_figure("abundance")`**. Observed number of specimens (**A**) and sampling redundancy (**B**) per 0.2° grid cell in the ferns of Japan.

\clearpage

```{r k-plot, fig.width = 7, fig.height = 3}
a <- k_taxonomy$df %>%
  as_tibble() %>%
  mutate(
    optimal_auto = ifelse(k == k_taxonomy$optimal$k, TRUE, FALSE),
    label = ifelse(k == k_taxonomy$optimal$k, glue::glue("k = {k}"), "")
  ) %>%
  ggplot(aes(x = k, y = ev)) +
  geom_path() +
  geom_point(aes(color = optimal_auto), size = 2.5) +
  geom_text(aes(label = label), vjust = 0, nudge_y = 0.02, size = 4) +
  scale_color_manual(values = c("TRUE" = "#E31A1C", "FALSE" = "black")) +
  labs(
    y = "Explained variance",
    x = "Number of clusters") +
  theme(
    legend.position = "none"
  )

k_phylogeny_select <- 8

b <- k_phylogeny$df %>%
  as_tibble() %>%
  mutate(
    optimal_auto = ifelse(k == k_phylogeny$optimal$k, TRUE, FALSE),
    label = ifelse(k == k_phylogeny$optimal$k, glue::glue("k = {k}"), "")
  ) %>%
  ggplot(aes(x = k, y = ev)) +
  geom_path() +
  geom_point(aes(color = optimal_auto), size = 2.5) +
  geom_text(aes(label = label), vjust = 0, nudge_y = 0.02, size = 4) +
  scale_color_manual(values = c("TRUE" = "#E31A1C", "FALSE" = "black")) +
  labs(
    y = "Explained variance",
    x = "Number of clusters") +
  theme(
    legend.position = "none"
  )

a + b +
  plot_layout(ncol = 2) +
  plot_annotation(tag_levels = 'A')

ggsave(result_file(s_figure("k-plot"), "pdf"), width = 7, height = 3, units = "in")
```

**`r s_figure("k-plot")`**. Selection of *k* for bioregions. **A**, taxonomic bioregions. **B**, phylogenetic bioregions. Color indicates optimal *k* selected selected by the `r func("optimal_phyloregion")` function in the R package `r pack("phyloregion")` (black, non-optimal; red, optimal; see Methods).

\clearpage

```{r raw-biplot, fig.width = 7, fig.height = 7}
a <- ggplot(biodiv_ferns_spatial, aes(x = richness, y = pd_obs)) +
  geom_point(alpha = 0.5) +
  labs(x = "Richness", y = "PD")

b <- ggplot(biodiv_ferns_spatial, aes(x = richness, y = rpd_obs)) +
  geom_point(alpha = 0.5) +
  labs(x = "Richness", y = "RPD")

c <- ggplot(biodiv_ferns_spatial, aes(x = richness, y = fd_obs)) +
  geom_point(alpha = 0.5) +
  labs(x = "Richness", y = "FD")

d <- ggplot(biodiv_ferns_spatial, aes(x = richness, y = rfd_obs)) +
  geom_point(alpha = 0.5) +
  labs(x = "Richness", y = "RFD")

a + b + c + d +
  plot_layout(ncol = 2, nrow = 2) +
  plot_annotation(tag_levels = 'A')

ggsave(result_file(s_figure("raw-biplot"), "pdf"), width = 7, height = 3, units = "in")
```

**`r s_figure("raw-biplot")`**. Relationships between observed functional and phylogenetic diversity and taxonomic richness in the ferns of Japan. **A**, Phylogenetic diversity (PD). **B**, Relative phylogenetic diversity (RPD). **C**, Functional diversity (FD). **D**, Relative functional diversity (RFD).

\clearpage

```{r endemism-restricted, fig.width = 5, fig.height = 5}
ggplot() +
  geom_sf(data = japan, fill = "grey90", color = "black", lwd = 0.25) +
  geom_sf(data = biodiv_ferns_endemic_spatial, aes(fill = endem_type), color = "transparent", alpha = 0.8) +
  scale_fill_manual(values = canape_cols) +
  map_theme() +
  theme(legend.title = element_blank())

ggsave(result_file(s_figure("endemism-restricted"), "pdf"), width = 5, height = 5, units = "in")
```

**`r s_figure("endemism-restricted")`**. Phylogenetic endemism of the ferns of Japan measured using CANAPE (categorical analysis of neo- and paleo-endemism), restricted dataset including only taxa endemic to Japan. 'paleo' indicates paleoendemic areas (those with an overabundance of long branches); 'neo' indicates neodendemic areas (those with an overabundance of short branches); 'mixed' indicates significantly endemic sites that have neither an overabundance of short nor long branches; 'super' indicates highly significantly endemic sites that have neither an overabundance of short nor long branches. For details, see Methods.
