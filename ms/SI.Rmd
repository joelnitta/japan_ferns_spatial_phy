---
title: "Exploring dimensions of biodiversity in Japanese ferns"
bibliography: "main_library.bib"
mainfont: Roboto-Regular.ttf
fontsize: 11pt
mainfontoptions: 
- BoldFont=Roboto-Bold.ttf
- ItalicFont=Roboto-Italic.ttf
- BoldItalicFont=Roboto-BoldItalic.ttf
output: 
  bookdown::pdf_document2:
    citation_package: none # Use pandoc default, otherwise csl can't be used for reference formatting
    toc: no
    number_sections: no
    fig_caption: yes
    keep_tex: no
    latex_engine: xelatex
    pandoc_args: [ "--csl", "journal-of-biogeography.csl"]
    includes:
      in_header: newphyt.sty
header-includes: 
  \usepackage{float}
  \makeatletter\renewcommand*{\fps@figure}{H}\makeatother
editor_options: 
  chunk_output_type: console
# nocite: | 
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, results = "hide", cache = FALSE)
```

```{r load-data, cache = FALSE}
# NOTE: This Rmd is meant to be knit as part of the drake plan (R/plan.R).
# If using interactively, run `source("_drake.R")` first.

loadd(list = c(
  "occ_point_data_ferns",
  "ses_phy_ferns",
  "ses_phy_ferns_endemic",
  "ses_traits_ferns",
  "shape_ferns",
  "k_taxonomy",
  "k_phylogeny",
  "regions_taxonomy",
  "regions_phylogeny",
  "species_motifs_ferns",
  "species_motifs_ferns_combined",
  "traits_nmds",
  "ppgi"
),
cache = ja_fern_cache)

# Load captions
source(here::here("ms/captions.R"))
```

<!-- Remove page numbers -->
\pagenumbering{gobble}

<!-- Set left justification -->
\raggedright

<!-- Don't indent -->
\setlength{\parindent}{0ex}

# Supplemental Information

```{r plot-prep}
# Combine bioregion results, biodiversity metrics, and shape data into single dataframe
tax_regions_data <- regions_taxonomy %>%
  mutate(taxonomic_cluster = as.factor(cluster) %>% fct_infreq %>% as.numeric %>% as.factor) %>%
  select(grids, taxonomic_cluster)

phy_regions_data <- regions_phylogeny %>%
  mutate(phylo_cluster = as.factor(cluster) %>% fct_infreq %>% as.numeric %>% as.factor) %>%
  select(grids, phylo_cluster)

ses_div_ferns_spatial <-
  shape_ferns %>%
  left_join(ses_phy_ferns, by = c(grids = "site")) %>%
  left_join(ses_traits_ferns, by = c(grids = "site")) %>%
  left_join(tax_regions_data, by = "grids") %>%
  left_join(phy_regions_data, by = "grids")

# - same for endemic species
ses_div_ferns_endemic_spatial <-
shape_ferns %>%
  left_join(ses_phy_ferns_endemic, by = c(grids = "site"))

# Define ggplot2 theme for maps
map_theme <- theme(
    panel.grid.major = element_line(color = "white", size = 0.2),
    axis.ticks = element_blank(),
    axis.text.x = element_text(angle = 45, hjust = 0.5, vjust = 0.7)
  )

```

```{r k-plot, fig.width = 7, fig.height = 3}
k_taxonomy_select <- 8

a <- k_taxonomy$df %>%
  as_tibble() %>%
  mutate(
    optimal_auto = ifelse(k == k_taxonomy$optimal$k, TRUE, FALSE),
    optimal_manual = ifelse(k == k_taxonomy_select, TRUE, FALSE),
    label = ifelse(k == k_taxonomy_select, glue::glue("k = {k}"), "")
  ) %>%
  ggplot(aes(x = k, y = ev)) +
  geom_path() +
  geom_point(aes(color = optimal_manual, shape = optimal_auto), size = 2.5) +
  geom_text(aes(label = label), vjust = 0, nudge_y = 0.02, size = 4) +
  scale_color_manual(values = c("TRUE" = "#E31A1C", "FALSE" = "black")) +
  scale_shape_manual(values = c("TRUE" = 17, "FALSE" = 16)) +
  labs(
    y = "Explained variance",
    x = "Number of clusters") +
  theme(
    legend.position = "none"
  )

k_phylogeny_select <- 6

b <- k_phylogeny$df %>%
  as_tibble() %>%
  mutate(
    optimal_auto = ifelse(k == k_phylogeny$optimal$k, TRUE, FALSE),
    optimal_manual = ifelse(k == k_phylogeny_select, TRUE, FALSE),
    label = ifelse(k == k_phylogeny_select, glue::glue("k = {k}"), "")
  ) %>%
  ggplot(aes(x = k, y = ev)) +
  geom_path() +
  geom_point(aes(color = optimal_manual, shape = optimal_auto), size = 2.5) +
  geom_text(aes(label = label), vjust = 0, nudge_y = 0.02, size = 4) +
  scale_color_manual(values = c("TRUE" = "#E31A1C", "FALSE" = "black")) +
  scale_shape_manual(values = c("TRUE" = 17, "FALSE" = 16)) +
  labs(
    y = "Explained variance",
    x = "Number of clusters",
    shape = "Optimal k\n(auto)",
    color = "Optimal k\n(manual)") +
  theme(
    axis.title.y = element_blank()
  )

a + b +
  plot_layout(ncol = 2) +
  plot_annotation(tag_levels = 'A')

ggsave(result_file("k-plot", "pdf"), width = 7, height = 3, units = "in")
```

**`r s_figure("k-plot")`**. `r s_figure_cap("k-plot")` **A**, taxonomic bioregions. **B**, phylogenetic bioregions. Shape indicates optimal *k* selected by \function{optimal{\_}phyloregion} function in the R package \package{phyloregion} (circle, non-optimal; triangle, optimal); color indicates optimal *k* selected manually (black, non-optimal; red, optimal; see Methods).

\clearpage

```{r k-plot-ecos, fig.width = 4, fig.height = 3}
# Extract log likelihoods for each value of K from ecostructure results
log_l <- map_dbl(species_motifs_ferns_combined, ~pluck(., "L")) %>%
  tibble(k = names(.) %>% parse_number, log_l = .) %>%
  mutate(
    optimal_manual = ifelse(k == k_taxonomy_select, TRUE, FALSE)
  )

ggplot(log_l, aes(x = k, y = log_l)) +
  geom_line() +
  geom_point(aes(color = optimal_manual), size = 2.5) +
  scale_color_manual(values = c("TRUE" = "#E31A1C", "FALSE" = "black")) +
  labs(
    y = "Log likelihood",
    x = "Number of clusters") +
  theme(legend.position = "none")

ggsave(result_file("k-plot-ecos", "pdf"), width = 4, height = 3, units = "in")
```

**`r s_figure("k-plot-ecos")`**. `r s_figure_cap("k-plot-ecos")` Red indicates optimal *k* selected manually (*k* = 8, same as for taxonomic bioregions).

\clearpage

```{r endemism-restricted, fig.width = 7, fig.height = 6}
# PE (endemic)
a <- ggplot(ses_div_ferns_endemic_spatial, aes(fill = pe_obs)) +
  geom_sf(color = "transparent") +
  scale_fill_viridis_c() + 
  labs(fill = "PE") +
  scale_y_continuous(labels = scales::label_number(suffix = "\u00b0N", accuracy = 1)) +
  scale_x_continuous(labels = scales::label_number(suffix = "\u00b0E", accuracy = 1)) +
  map_theme +
  theme(
    axis.text.x = element_blank()
  )

# SES PE (endemic)
b <- ggplot(ses_div_ferns_endemic_spatial, aes(fill = pe_obs_z)) +
  geom_sf(color = "transparent") +
  labs(fill = "SES PE") +
  scale_fill_scico(
    palette = "romaO",
    na.value="grey80",
    direction = -1,
    limits = c(
      -get_limit(ses_div_ferns_endemic_spatial, pe_obs_z, "abs"),
      get_limit(ses_div_ferns_endemic_spatial, pe_obs_z, "abs")
    )) +
  scale_y_continuous(labels = scales::label_number(suffix = "\u00b0N", accuracy = 1)) +
  scale_x_continuous(labels = scales::label_number(suffix = "\u00b0E", accuracy = 1)) +
  map_theme +
  theme(
    axis.text.y = element_blank()
  )

# CANAPE (endemic)
c <- ggplot(ses_div_ferns_endemic_spatial, aes(fill = endem_type)) +
  geom_sf(color = "transparent") +
  labs(fill = "Endemism\ntype") +
  scale_y_continuous(labels = scales::label_number(suffix = "\u00b0N", accuracy = 1)) +
  scale_x_continuous(labels = scales::label_number(suffix = "\u00b0E", accuracy = 1)) +
  map_theme

a + b + c + 
  plot_layout(ncol = 2) +
  plot_annotation(tag_levels = 'A')

ggsave(result_file("endemism-restricted", "pdf"), width = 7, height = 6, units = "in")
```

**`r s_figure("endemism-restricted")`**. `r s_figure_cap("endemism-restricted")` **A**, phylogenetic endemism (PE). **B**, Standard effect size (SES) of PE. **C**, Categorical analysis of neo- and paleo-endemism (CANAPE).

```{r biplot-prep}
# Extract centroids
centroids <- sf::st_centroid(ses_div_ferns_spatial$geometry) %>%
  sf::st_coordinates()

# Define helper function for making a scatterplot
scatterplot <- function(data, x_var, y_var, x_lab, y_lab, label, annotate) {
  p <- ggplot(data, aes(x = .data[[x_var]], y = .data[[y_var]])) +
    geom_point(alpha = 0.5) +
    labs(
      x = x_lab,
      y = y_lab
    )
  
  # Add annotation and trendline if annotate = TRUE
  if(annotate) p <- p +
      annotate("label", x = Inf, y = Inf, label = label, hjust = 1, vjust = 1, label.size = 0, fill = "transparent") +
      geom_smooth(method = "lm", se = FALSE, color = "blue", size = 0.5)
  
  p
}
```

```{r raw-biplot, fig.width = 7, fig.height = 6}
## Biplots of raw metrics ##

# Make dataframe of arguments to feed into plotting function
# - includes all non-duplicated combinations of raw diversity metrics
raw_comparisons <-
  cross_df(
    list(
      x_var = c("mpd_obs", "pe_obs", "mpd_morph_obs", "richness"),
      y_var = c("mpd_obs", "pe_obs", "mpd_morph_obs")
    ),
    .filter = `==` # filter out exact duplicates
  ) %>%
  # Remove reversed duplicates
  # https://stackoverflow.com/questions/22756392/deleting-reversed-duplicates-with-r
  group_by(grp = paste(pmax(x_var, y_var), pmin(x_var, y_var), sep = "_")) %>%
  # Use factors to keep the preferred combination of x and y
  mutate(x_var = as.factor(x_var) %>% fct_relevel("pe_obs", "mpd_morph_obs", "richness")) %>%
  mutate(y_var = as.factor(y_var) %>% fct_relevel("mpd_obs", "pe_obs", "mpd_morph_obs")) %>%
  arrange(x_var, y_var) %>%
  slice(1) %>%
  ungroup() %>%
  select(-grp) %>%
  # Convert x_var and y_var back to character for plotting function
  mutate(across(c(x_var, y_var), as.character)) %>%
  # Add labels
  mutate(
    x_lab = case_when(
      x_var == "mpd_morph_obs" ~ "MMD",
      x_var == "mpd_obs" ~ "MPD",
      x_var == "pe_obs" ~ "PE",
      x_var == "richness" ~ "Richness"
    ),
    y_lab = case_when(
      y_var == "mpd_morph_obs" ~ "MMD",
      y_var == "mpd_obs" ~ "MPD",
      y_var == "pe_obs" ~ "PE",
      y_var == "richness" ~ "Richness"
    )
  ) %>%
  # Run modified t-test
  mutate(
    test_res = map2(
      .x = x_var, 
      .y = y_var, 
      ~SpatialPack::modified.ttest(ses_div_ferns_spatial[[.x]], ses_div_ferns_spatial[[.y]], centroids)),
    # Extract relevant stats from results
    cor = map_dbl(test_res, pluck("corr")),
    pval = map_dbl(test_res, pluck("p.value"))
    ) %>%
  # Generate label
  mutate(
    cor_lab = glue("r = {round(cor, 3)}"),
    pval_lab = glue("p = {round(pval, 3)}"),
    label = glue::glue("{cor_lab}\n{ifelse(pval < 0.001, 'p < 0.001', pval_lab)}")
  ) %>%
  # Specify which plots to annotate
  mutate(
    annotate = case_when(
      x_var == "mpd_morph_obs" & y_var == "mpd_obs" & pval < 0.05 ~ TRUE,
      x_var == "mpd_morph_obs" & y_var == "pe_obs" & pval < 0.05 ~ TRUE,
      x_var == "mpd_obs" & y_var == "pe_obs" & pval < 0.05 ~ TRUE,
      x_var == "richness" & y_var == "pe_obs" & pval < 0.05  ~ TRUE,
      TRUE ~ FALSE
    )
  ) %>%
  select(x_var, y_var, x_lab, y_lab, label, annotate)
  
# Make plot
pmap(raw_comparisons, scatterplot, data = ses_div_ferns_spatial) %>%
wrap_plots() +
  plot_annotation(tag_levels = 'A')

ggsave(result_file("raw-biplot", "pdf"), width = 7, height = 6, units = "in")
```

**`r s_figure("raw-biplot")`**. `r s_figure_cap("raw-biplot")` MPD, mean phylogenetic distance; MMD, mean morphological distance; PE, phylogenetic endemism. Correlations between variables analyzed with Dutilleul's modified *t*-test that accounts for spatial structure in the data; *p* value and correlation (r) only shown for *p* < 0.05; correlations between MPD and MMD with richness not expected to be linear, so were not tested.

```{r ses-biplot, fig.width = 7, fig.height = 6}
## Biplots of SES metrics ##

# Make dataframe of arguments to feed into plotting function
# - includes all non-duplicated combinations of raw diversity metrics
ses_comparisons <-
  cross_df(
    list(
      x_var = c("mpd_obs_z", "pe_obs_z", "mpd_morph_obs_z", "richness"),
      y_var = c("mpd_obs_z", "pe_obs_z", "mpd_morph_obs_z")
    ),
    .filter = `==` # filter out exact duplicates
  ) %>%
  # Remove reversed duplicates
  # https://stackoverflow.com/questions/22756392/deleting-reversed-duplicates-with-r
  group_by(grp = paste(pmax(x_var, y_var), pmin(x_var, y_var), sep = "_")) %>%
  # Use factors to keep the preferred combination of x and y
  mutate(x_var = as.factor(x_var) %>% fct_relevel("pe_obs_z", "mpd_morph_obs_z", "richness")) %>%
  mutate(y_var = as.factor(y_var) %>% fct_relevel("mpd_obs_z", "pe_obs_z", "mpd_morph_obs_z")) %>%
  arrange(x_var, y_var) %>%
  slice(1) %>%
  ungroup() %>%
  select(-grp) %>%
  # Convert x_var and y_var back to character for plotting function
  mutate(across(c(x_var, y_var), as.character)) %>%
  # Add labels
  mutate(
    x_lab = case_when(
      x_var == "mpd_morph_obs_z" ~ "SES MMD",
      x_var == "mpd_obs_z" ~ "SES MPD",
      x_var == "pe_obs_z" ~ "SES PE",
      x_var == "richness" ~ "Richness"
    ),
    y_lab = case_when(
      y_var == "mpd_morph_obs_z" ~ "SES MMD",
      y_var == "mpd_obs_z" ~ "SES MPD",
      y_var == "pe_obs_z" ~ "SES PE",
      y_var == "richness" ~ "Richness"
    )
  ) %>%
  # Run modified t-test
  mutate(
    test_res = map2(
      .x = x_var, 
      .y = y_var, 
      ~SpatialPack::modified.ttest(ses_div_ferns_spatial[[.x]], ses_div_ferns_spatial[[.y]], centroids)),
    # Extract relevant stats from results
    cor = map_dbl(test_res, pluck("corr")),
    pval = map_dbl(test_res, pluck("p.value"))
    ) %>%
  # Generate label
  mutate(
    cor_lab = glue("r = {round(cor, 3)}"),
    pval_lab = glue("p = {round(pval, 3)}"),
    label = glue::glue("{cor_lab}\n{ifelse(pval < 0.001, 'p < 0.001', pval_lab)}")
  ) %>%
  # Specify which plots to annotate
  mutate(
    annotate = case_when(
      pval < 0.05 ~ TRUE,
      TRUE ~ FALSE
    )
  ) %>%
  select(x_var, y_var, x_lab, y_lab, label, annotate)

# Make plot
pmap(ses_comparisons, scatterplot, data = ses_div_ferns_spatial) %>%
  wrap_plots() +
  plot_annotation(tag_levels = 'A')

ggsave(result_file("ses-biplot", "pdf"), width = 7, height = 6, units = "in")
```

**`r s_figure("ses-biplot")`**. `r s_figure_cap("ses-biplot")` MPD, mean phylogenetic distance; MMD, mean morphological distance; PE, phylogenetic endemism. Correlations between variables analyzed with Dutilleul's modified *t*-test that accounts for spatial structure in the data; all combinations tested, but *p* value and correlation (r) only shown for *p* < 0.05.

```{r trait-space, fig.width = 8, fig.height = 8}
# Extract points, join to PPGI
nmds_points <- traits_nmds[["points"]] %>%
  as.data.frame %>%
  rownames_to_column("taxon") %>%
  as_tibble %>%
  mutate(genus = str_split(taxon, "_") %>% map_chr(1)) %>%
  left_join(ppgi, by = "genus") %>%
  mutate(
    order = factor(order),
    family = factor(family))

# A: all ferns
a <- ggplot(nmds_points, aes(x = MDS1, y = MDS2, color = order, shape = order)) +
  geom_point() +
  scale_shape_manual(values = 1:n_distinct(nmds_points$order)) +
  labs(title = "A. Ferns")

# B: Polypods only
nmds_points_polypod <- filter(nmds_points, order == "Polypodiales")

b <- ggplot(nmds_points_polypod, aes(x = MDS1, y = MDS2, color = family, shape = family)) +
  geom_point() +
  scale_shape_manual(values = 1:n_distinct(nmds_points_polypod$family)) +
  labs(title = "B. Polypodiales") +
  guides(
    color = guide_legend(ncol = 2),
    shape = guide_legend(ncol = 2))

a + b + 
  plot_layout(nrow = 2)

ggsave(result_file("traits-nmds", "pdf"), width = 8, height = 8, units = "in")
```

**`r s_figure("traits-nmds")`**. `r s_figure_cap("traits-nmds")` Interspecific trait distances calculated using Gower's method with 16 traits, then projected into trait space using nonmetric multidimensional scaling (NMDS). **A**, All ferns. **B**, Polypodiales. Taxonomy follows PPGI.
