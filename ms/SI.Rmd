---
title: "Exploring dimensions of biodiversity in Japanese ferns"
bibliography: "main_library.bib"
mainfont: Roboto-Regular.ttf
fontsize: 11pt
mainfontoptions: 
- BoldFont=Roboto-Bold.ttf
- ItalicFont=Roboto-Italic.ttf
- BoldItalicFont=Roboto-BoldItalic.ttf
output: 
  bookdown::pdf_document2:
    citation_package: none # Use pandoc default, otherwise csl can't be used for reference formatting
    toc: no
    number_sections: no
    fig_caption: yes
    keep_tex: no
    latex_engine: xelatex
    pandoc_args: [ "--csl", "journal-of-biogeography.csl"]
    includes:
      in_header: newphyt.sty
header-includes: 
  \usepackage{float}
  \makeatletter\renewcommand*{\fps@figure}{H}\makeatother
editor_options: 
  chunk_output_type: console
# nocite: | 
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, results = "hide", cache = TRUE)
```

```{r load-data, cache = FALSE}
# NOTE: This Rmd is meant to be knit as part of the drake plan (R/plan.R).
# If using interactively, run `source("_drake.R")` first.

loadd(list = c(
  "occ_point_data_ferns",
  "ses_phy_ferns",
  "ses_phy_ferns_endemic",
  "ses_traits_ferns",
  "shape_ferns",
  "k_taxonomy",
  "k_phylogeny",
  "regions_taxonomy",
  "regions_phylogeny",
  "species_motifs_ferns"
),
cache = ja_fern_cache)

phylo_cache <- new_cache(here::here("phylo_cache"))

loadd(list = c(
  "plastome_calibration_dates",
  "plastome_tree"
),
cache = phylo_cache)

# Load captions
source(here::here("ms/captions.R"))
```

<!-- Remove page numbers -->
\pagenumbering{gobble}

<!-- Set left justification -->
\raggedright

<!-- Don't indent -->
\setlength{\parindent}{0ex}

# Supplemental Information

```{r plot-prep}
tax_regions_data <- regions_taxonomy %>%
  mutate(taxonomic_cluster = as.factor(cluster) %>% fct_infreq %>% as.numeric %>% as.factor)

phy_regions_data <- regions_phylogeny %>%
  mutate(phylo_cluster = as.factor(cluster) %>% fct_infreq %>% as.numeric %>% as.factor)

ses_div_ferns_spatial <-
  shape_ferns %>%
  left_join(categorize_endemism(ses_phy_ferns), by = c(grids = "site")) %>%
  left_join(ses_traits_ferns, by = c(grids = "site")) %>%
  mutate(redundancy = 1 - (richness/abundance)) %>%
  left_join(tax_regions_data, by = "grids") %>%
  left_join(phy_regions_data, by = "grids")

ses_div_ferns_endemic_spatial <-
shape_ferns %>%
  left_join(categorize_endemism(ses_phy_ferns_endemic), by = c(grids = "site"))

map_theme <- theme(
    panel.grid.major = element_line(color = "white", size = 0.2),
    axis.ticks = element_blank(),
    axis.text.x = element_text(angle = 45, hjust = 0.5, vjust = 0.7)
  )
```

```{r k-plot, fig.width = 7, fig.height = 3}
k_taxonomy_select <- 8

a <- k_taxonomy$df %>%
  as_tibble() %>%
  mutate(
    optimal_auto = ifelse(k == k_taxonomy$optimal$k, TRUE, FALSE),
    optimal_manual = ifelse(k == k_taxonomy_select, TRUE, FALSE),
    label = ifelse(k == k_taxonomy_select, glue::glue("k = {k}"), "")
  ) %>%
  ggplot(aes(x = k, y = ev)) +
  geom_path() +
  geom_point(aes(color = optimal_manual, shape = optimal_auto), size = 2.5) +
  geom_text(aes(label = label), vjust = 0, nudge_y = 0.02, size = 4) +
  scale_color_manual(values = c("TRUE" = "#E31A1C", "FALSE" = "black")) +
  scale_shape_manual(values = c("TRUE" = 17, "FALSE" = 16)) +
  labs(
    y = "Explained variance",
    x = "Number of clusters") +
  theme(
    legend.position = "none"
  )

k_phylogeny_select <- 7

b <- k_phylogeny$df %>%
  as_tibble() %>%
  mutate(
    optimal_auto = ifelse(k == k_phylogeny$optimal$k, TRUE, FALSE),
    optimal_manual = ifelse(k == k_phylogeny_select, TRUE, FALSE),
    label = ifelse(k == k_phylogeny_select, glue::glue("k = {k}"), "")
  ) %>%
  ggplot(aes(x = k, y = ev)) +
  geom_path() +
  geom_point(aes(color = optimal_manual, shape = optimal_auto), size = 2.5) +
  geom_text(aes(label = label), vjust = 0, nudge_y = 0.02, size = 4) +
  scale_color_manual(values = c("TRUE" = "#E31A1C", "FALSE" = "black")) +
  scale_shape_manual(values = c("TRUE" = 17, "FALSE" = 16)) +
  labs(
    y = "Explained variance",
    x = "Number of clusters",
    shape = "Optimal k\n(auto)",
    color = "Optimal k\n(manual)") +
  theme(
    axis.title.y = element_blank()
  )

a + b +
  plot_layout(ncol = 2) +
  plot_annotation(tag_levels = 'A')

```

**`r s_figure("k-plot")`**. `r s_figure_cap("k-plot")` **A**, taxonomic bioregions. **B**, phylogenetic bioregions. Shape indicates optimal *k* selected by \function{optimal{\_}phyloregion} function in the R package \package{phyloregion} (circle, non-optimal; triangle, optimal); color indicates optimal *k* selected manually (black, non-optimal; red, optimal; see Methods).

<!-- (Add k plot for ecostructure) -->

\clearpage

```{r endemism-restricted, fig.width = 7, fig.height = 6}
# PE (endemic)
a <- ggplot(ses_div_ferns_endemic_spatial, aes(fill = pe_obs)) +
  geom_sf(color = "transparent") +
  scale_fill_viridis_c() + 
  labs(fill = "PE") +
  scale_y_continuous(labels = scales::label_number(suffix = "\u00b0N", accuracy = 1)) +
  scale_x_continuous(labels = scales::label_number(suffix = "\u00b0E", accuracy = 1)) +
  map_theme +
  theme(
    axis.text.x = element_blank()
  )

# SES PE (endemic)
b <- ggplot(ses_div_ferns_endemic_spatial, aes(fill = pe_obs_z)) +
  geom_sf(color = "transparent") +
  labs(fill = "SES PE") +
  scale_fill_scico(
    palette = "romaO",
    na.value="grey80",
    direction = -1,
    limits = c(
      -get_limit(ses_div_ferns_endemic_spatial, pe_obs_z, "abs"),
      get_limit(ses_div_ferns_endemic_spatial, pe_obs_z, "abs")
    )) +
  scale_y_continuous(labels = scales::label_number(suffix = "\u00b0N", accuracy = 1)) +
  scale_x_continuous(labels = scales::label_number(suffix = "\u00b0E", accuracy = 1)) +
  map_theme +
  theme(
    axis.text.y = element_blank()
  )

# CANAPE (endemic)
c <- ggplot(ses_div_ferns_endemic_spatial, aes(fill = endem_type)) +
  geom_sf(color = "transparent") +
  labs(fill = "Endemism\ntype") +
  scale_y_continuous(labels = scales::label_number(suffix = "\u00b0N", accuracy = 1)) +
  scale_x_continuous(labels = scales::label_number(suffix = "\u00b0E", accuracy = 1)) +
  map_theme

a + b + c + 
  plot_layout(ncol = 2) +
  plot_annotation(tag_levels = 'A')

ggsave(here::here("results/Fig_S1.pdf"), width = 7, height = 6, units = "in")
```

**`r s_figure("endemism-restricted")`**. `r s_figure_cap("endemism-restricted")` **A**, phylogenetic endemism (PE). **B**, Standard effect size (SES) of PE. **C**, Categorical analysis of neo- and paleo-endemism (CANAPE).
