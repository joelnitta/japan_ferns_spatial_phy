---
title: "Appendix S1: Supporting Tables and Figures"
mainfont: Roboto-Regular.ttf
fontsize: 11pt
mainfontoptions: 
  - BoldFont=Roboto-Bold.ttf
  - ItalicFont=Roboto-Italic.ttf
  - BoldItalicFont=Roboto-BoldItalic.ttf
output: 
  bookdown::pdf_document2:
    citation_package: default
    toc: no
    number_sections: no
    fig_caption: yes
    keep_tex: no
    latex_engine: xelatex
    pandoc_args: [ "--csl", "american-journal-of-botany.csl"]
header-includes: 
  - \usepackage{float} # keep figures from floating away
  - \usepackage{booktabs} # need for kable tables
  - \usepackage{colortbl} # need for kable tables
  - \makeatletter\renewcommand*{\fps@figure}{H}\makeatother # keep figures from floating away
  - \usepackage{fancyhdr} # enable header
  - \pagestyle{fancy}  # enable header
  - \fancypagestyle{plain}{\pagestyle{fancy}} # show header on first page
  - \renewcommand{\headrulewidth}{0pt} # delete line beneath header
  - \fancyhead[RE,RO]{Nitta \textit{et al}. Spatial phy. of Japanese ferns Appendix S1} # add header on right side
  - \fancyhead[LO,LE]{} # suppress automatic section header on left side
  - \cfoot{\thepage} # footer
editor_options: 
  chunk_output_type: console
params:
  doc_type: pdf
# nocite: | 
---

---
bibliography: 
- `r here::here("ms/references.yaml")`
---

```{r setup-si, include = FALSE, cache = FALSE, eval = TRUE}
# Load packages only used when knitting Rmd
library(kableExtra)
library(scales)
library(ggtree)
library(RColorBrewer)
library(ggspatial) # for scalebars on maps

# Load functions and variables only used when rendering Rmds
source(here::here("R/ms_functions.R"), local = TRUE)
# Set knitr options
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, results = "hide", cache = FALSE)
```

```{r libraries-no-run-in-plan, eval = FALSE}
# This Rmd is meant to be knit as part of the target plan (R/_targets.R).
# Run the lines below if rendering outside of targets plan
library(targets)
library(tarchetypes)
source(here::here("R/packages.R"))
source(here::here("R/functions.R"))
```

```{r load-data-si, cache = FALSE}
tar_load(c(
  "japan_shp",
  "inext_res",
  "redundancy_by_res",
  "redundancy_summary",
  "biodiv_ferns_spatial",
  "biodiv_ferns_endemic_spatial",
  "k_taxonomy",
  "k_phylogeny",
  "traits_nmds",
  "ppgi",
  "phy_sig_results",
  "binary_sig_results",
  "lrt_results",
  "japan_shp",
  "morans_i",
  "t_test_results",
  "aic_env_repro",
  "comm_ferns",
  "repro_data",
  "japan_pterido_tree",
  "model_fits_not_ult",
  "biodiv_ferns_cent",
  "protected_areas",
  "deer_range",
  "biodiv_ferns_spatial_lumped",
  "bioregion_cutoff",
  "bioregions_all_labels",
  "ms_functions"
))
```

```{r load-captions, cache = FALSE}
# Source captions numbers from MS
# 
# So that caption numbers are in order of appearance in MS

# Run inline code when purling
options(knitr.purl.inline = TRUE)

# Make a temporary file to write out just inline R code from the SI Rmd
temp_file <- tempfile()

# Generate R script including inline R code from the ms Rmd
knitr::purl(here::here("ms/manuscript.Rmd"), output = temp_file)

# Trim this R script down to only functions that define figure and table captions
read_lines(temp_file) %>%
  magrittr::extract(
    str_detect(., "^figure\\(|^table\\(|^s_figure\\(|^s_table\\(|^figure_num\\(|^table_num\\(|^s_figure_num\\(|^s_table_num\\(")
  ) %>%
  unique %>%
  write_lines(temp_file)

# Source the code. This will load the caption functions in the right order.
source(temp_file, local = TRUE)

# Delete the temporary file
fs::file_delete(temp_file)
```

<!-- Set left justification -->
\raggedright

<!-- Don't indent -->
\setlength{\parindent}{0ex}

```{r moran, results = "as-is"}
morans_i %>%
  select(resp_var = var, morans_i, pval_i) %>%
  mutate(
    across(c(morans_i, pval_i), ~format(., digits = 2)),
    resp_var = clean_vars(resp_var) %>% 
      factor(levels = c("Area", "% apomictic taxa", "Precipitation", "Precipitation seasonality", "Temperature", "Richness", "SES of PD", "SES of RPD", "SES of FD", "SES of RFD"))
  ) %>%
  assert(not_na, resp_var) %>%
  arrange(resp_var) %>%
  # format for kable/latex: since I use latex in headers, must escape latex elsewhere
  mutate(resp_var = str_replace_all(resp_var, "%", "\\\\%")) %>%
  rename(`\\textit{I}` = morans_i, `\\textit{P}` = pval_i, "Variable" = resp_var) %>%
  kbl(booktabs = TRUE, escape = FALSE, format = "latex") %>%
  kable_styling(latex_options = c("striped", "HOLD_position"))
```

**`r s_table("moran")`**. Spatial autocorrelation in biodiversity metrics (richness, SES of PD, SES of RPD, SES of FD, SES of RFD) and independent variables (environmental variables and % apomictic taxa) as measured with Moran's *I*. Significant *I* > 0 indicates autocorrelation.

\clearpage

```{r corr, results = "as-is"}
t_test_results_for_table <-
  t_test_results %>%
  mutate(
    var1 = clean_vars(var1),
    var2 = clean_vars(var2)) %>%
  arrange(var1, var2)

# Identify which rows to make bold based on p < 0.05
t_test_signif <- t_test_results_for_table$p_value < 0.05
t_test_signif[is.na(t_test_signif)] <- FALSE
t_test_signif <- which(t_test_signif)

t_test_results_for_table %>%
  mutate(across(where(is.double), ~format(., digits = 2))) %>%
  # format for kable/latex
  mutate(
    var1 = str_replace_all(var1, "%", "\\\\%"),
    var2 = str_replace_all(var2, "%", "\\\\%")) %>%
  rename(
    "Variable 1" = var1,
    "Variable 2" = var2,
    `\\textit{P}` = p_value,
    `\\textit{r}` = corr,
    `\\textit{f}` = f_stat,
    "df" = dof) %>%
  kbl(booktabs = TRUE, escape = FALSE, format = "latex") %>%
  row_spec(row = t_test_signif, bold = TRUE) %>%
  kable_styling(latex_options = c("striped", "HOLD_position"))
```

**`r s_table("corr")`**. Results of modified *t*-test for correlation between variables while taking into account spatial position. Significantly correlated variables at *P* < 0.05 in bold.

\clearpage

```{r phy-sig-binary, results = "as-is"}
binary_sig_results %>%
  select(trait, D, num_present, num_absent, prob_random, prob_brownian) %>%
  arrange(trait) %>%
  # format for kable/latex
  mutate(
    trait = str_replace_all(trait, "_", "\\\\_"),
    D = round(D, 3)) %>%
  rename(
    "Trait" = trait,
    `\\textit{N} present` = num_present,
    `\\textit{N} absent` = num_absent,
    `\\textit{D}` = D,
    `\\textit{P}(random)` = prob_random, 
    `\\textit{P}(Brownian)` = prob_brownian
  ) %>%
  kbl(booktabs = TRUE, escape = FALSE, format = "latex", longtable = TRUE) %>%
  kable_styling(latex_options = c("striped", "scale_down", "HOLD_position", "repeat_header"))
```

**`r s_table("phy-sig-binary")`**. Phylogenetic signal in quantitative (binary) functional traits of the ferns of Japan. *D*, Fritz and Purvis' *D*; *N* (present), number of times a trait was observed present; *N* (absent), number of times a trait was observed absent; *P*(random), probability of obtaining observed trait distribution given random distribution of traits; *P*(Brownian), probability of obtaining observed trait distribution given random evolution by Brownian Motion. Presence or absence of indusium was originally a binary trait; other traits (margin, shape, texture) are qualitative traits scored in binary format. Values of *D* rounded to three decimal places.

\clearpage

```{r phy-sig, results = "as-is"}
phy_sig_results %>%
  mutate(across(c(kval, lambda, k_pval, lambda_pval), ~format(., digits = 2))) %>%
  # format for kable/latex
  mutate(trait = str_replace_all(trait, "_", "\\\\_")) %>%
  rename(
    "Trait" = trait,
    `\\textit{K}` = kval, `\\textit{P}(\\textit{K})` = k_pval, 
    `λ` = lambda, `\\textit{P}(λ)` = lambda_pval,
    `\\textit{N}` = n) %>%
  kbl(booktabs = TRUE, escape = FALSE, format = "latex") %>%
  kable_styling(latex_options = c("striped", "HOLD_position"))
```

**`r s_table("phy-sig")`**. Phylogenetic signal in continuous functional traits of the ferns of Japan. *K*, Blomberg's *K*; λ, Pagel's λ.

\clearpage

```{r lrt-null, results = "as-is"}
# Need to keep the input data separate for pack_rows()
lrt_table_data <-
  lrt_results %>%
  filter(comparison == "null_model") %>%
  select(-null_formula, -comparison) %>%
  tidyr::extract(full_formula, "model_type", "~ ([^ ]+) ") %>%
  rename_resp_vars %>%
  rename_model_type %>%
  select(model_type, resp_var, chi2_LR, df, loglik_null, loglik_full, p_value) %>%
  arrange(model_type, resp_var) %>%
  mutate(across(where(is.double), ~format(., digits = 2)))

lrt_table_data %>%
  select(-model_type) %>%
  # format for kable/latex
  rename(
    "Response variable" = resp_var,
    `χ\\textsuperscript{2}` = chi2_LR,
    `LogL(null)` = loglik_null,
    `LogL(full)` = loglik_full,
    `\\textit{P}` = p_value
  ) %>%
  kbl(booktabs = TRUE, escape = FALSE, format = "latex") %>%
  pack_rows(index = base::table(lrt_table_data$model_type)) %>%
  kable_styling(latex_options = c("striped", "HOLD_position"))
```

**`r s_table("lrt-null")`**. Likelihood ratio test (LRT) between full model and null model (model only including the spatial Matérn correlation matrix). Higher (less negative) log likelihood indicates better fit. Full environmental models included the effects of temperature, precipitation, precipitation seasonality, and area. Full reproductive models included the effects of % apomictic taxa, precipitation, precipitation seasonality, and area. PD, phylogenetic diversity; RPD, relative phylogenetic diversity; FD, functional diversity; RFD, relative functional diversity; SES, standard effect size.

\clearpage

```{r aic, results = "as-is"}
aic_table_data <- aic_env_repro %>%
  rename_resp_vars %>%
  rename_model_type %>%
  select(model_type, resp_var, conditional_aic, df = effective_df, loglik) %>%
  arrange(model_type, resp_var) %>%
  mutate(across(where(is.double), ~format(., digits = 2)))

aic_table_data %>%
  select(-model_type) %>%
  # format for kable/latex
  rename(
    "Response variable" = resp_var,
    "cAIC" = conditional_aic,
    "LogL" = loglik
  ) %>%
  kbl(booktabs = TRUE, escape = FALSE, format = "latex") %>%
  pack_rows(index = base::table(aic_table_data$model_type)) %>%
  kable_styling(latex_options = c("striped", "HOLD_position"))
```

**`r s_table("aic")`**. Model fit as measured with conditional Akaike Information Criterion (cAIC). Environmental models included the effects of temperature, precipitation, precipitation seasonality, and area. Reproductive models included the effects of % apomictic taxa, precipitation, precipitation seasonality, and area. Lower cAIC indicates better fit.

\clearpage

```{r map-plot-prep}
# Crop high-res map of Japan to spatial div results area
japan <- sf::st_crop(japan_shp, sf::st_bbox(biodiv_ferns_spatial)) %>%
  st_transform(4612)

# Format biodiv_ferns_spatial data for plotting
biodiv_ferns_spatial <-
  biodiv_ferns_spatial %>% 
  # Set order of factor levels for plotting
  mutate(
    endem_type = factor(endem_type, levels = c("neo", "paleo", "not significant", "mixed", "super")),
    # can ignore warning about unknown levels, since they don't exist in all variables but that's OK
    across(
      contains("signif"),
      ~fct_relevel(.x, "< 0.01",  "< 0.025", "not significant", "> 0.975", "> 0.99")
    )
  ) %>%
  st_transform(4612) %>%
  # Only plot data included in model
  inner_join(select(biodiv_ferns_cent, grids), by = "grids")

biodiv_ferns_endemic_spatial <-
  biodiv_ferns_endemic_spatial %>% 
  # Set order of factor levels for plotting
  mutate(
    endem_type = factor(endem_type, levels = c("neo", "paleo", "not significant", "mixed", "super"))
  ) %>%
  st_transform(4612) %>%
  # Only plot data included in model
  inner_join(select(biodiv_ferns_cent, grids), by = "grids")

# Specify subplot order
model_subplot_order <- tribble(
  ~resp_var, ~indep_var, ~order,
  "richness", "temp", 1,
  "pd_obs_z", "temp", 2,
  "rpd_obs_z", "temp", 3,
  "fd_obs_z", "temp", 4,
  "rfd_obs_z", "temp", 5,
  "pd_obs_z", "percent_apo", 6,
  "rpd_obs_z", "percent_apo", 7
)
```

```{r sampling-curve, fig.width = 4, fig.height = 3}
# create subset of observed points to add to plot as dots
observed_data <- inext_res[inext_res$method == "observed",]

# check estimated completeness
est_completeness <- inext_res %>% filter(method == "observed") %>% pull(SC) %>% scales::percent()
rich_interval <- glue::glue("{observed_data$qD.LCL %>% round} to {observed_data$qD.UCL %>% round}")
completeness_interval <- glue::glue("{observed_data$SC.LCL %>% scales::percent()} to {observed_data$SC.UCL %>% scales::percent()}")

# Make iNEXT plot
inext_res %>%
  filter(method != "observed") %>%
  ggplot(aes(x=m, y=qD)) +
  geom_ribbon(aes(ymin = qD.LCL, ymax = qD.UCL), fill = "grey70") +
  geom_line(aes(linetype=method), size=0.8) +
  scale_linetype_manual(values=c("dotted", "solid", "solid")) +
  geom_point(data=observed_data, size=3) +
  scale_y_continuous("Richness") +
  scale_x_continuous("No. specimens") +
  theme_minimal() +
  theme(
    legend.position="bottom", 
    legend.title=element_blank()
  )
```

**`r s_figure("sampling-curve")`**. Species collection curve for the ferns of Japan fit with the `r pack("iNEXT")` package [@Hsieh2016]. Grey shading indicates 95% confidence interval (not visible where it does not extend beyond the fitted line). Point indicates observed taxonomic richness (`r observed_data$qD` taxa, 95% confidence interval `r rich_interval` taxa). Taxa include species, subspecies, and varieties, excluding hybrids. Sampling completeness is estimated to be `r est_completeness` (95% confidence interval `r completeness_interval`).

\clearpage

```{r grain-size, fig.width = 7, fig.height = 3}
# Helper function to format resolution labels
km_lab <- function (x) {
  as.numeric(x) %>% 
    scales::number(suffix = "km", scale = 1e-3)
}

# Summarize redundancy statistics by grain size
redundancy_summary <- sum_redundancy_by_res(redundancy_by_res)

# Percent of grid cells with redundancy > 0.5 by grain size
a <- ggplot(redundancy_summary, aes(x = res, y = percent_above_50)) +
  geom_col() +
  scale_y_continuous(labels = scales::percent) +
  scale_x_discrete(labels = km_lab) +
  labs(
    x = "Resolution",
    y = "Redundancy > 0.5"
  )

# Percent of grid cells with redundancy = 0 by grain size
b <- ggplot(redundancy_summary, aes(x = res, y = percent_singletons)) +
  geom_col() +
  scale_y_continuous(labels = scales::percent) +
  scale_x_discrete(labels = km_lab) +
  labs(
    x = "Resolution",
    y = "Redundancy = 0"
  )

# Distribution of redundancy by grain size
c <- ggplot(redundancy_by_res, aes(x = redundancy, y = res)) +
  geom_density_ridges(scale = 1.5) + 
  scale_y_discrete(expand = c(0, 0), labels = km_lab) + # will generally have to set the `expand` option
  scale_x_continuous(expand = c(0, 0)) +   # for both axes to remove unneeded padding
  coord_cartesian(clip = "off") + # to avoid clipping of the very top of the top ridgeline
  labs(
    x = "Redundancy",
    y = "Resolution"
  )

a + b + c +
  plot_annotation(tag_levels = "A",
                  tag_prefix = "",
                  tag_suffix = "") &
  theme(plot.tag = element_text(face = "bold"))
```

**`r s_figure("grain-size")`**. Effect of grain size on sampling redundancy. (A) Percent of grid cells with redundancy > 0.5 by grain size (side length of square grid cells set to 10 km, 20 km, 30 km, or 40 km). (B) Percent of grid cells with redundancy = 0 by grain size. (C) Distribution of redundancy values by grain size.

\clearpage

```{r envir, fig.width = 7, fig.height = 9}
# Define function for plotting environment
plot_env <- function(part, label, var_select, fill_lab = "", labels = ggplot2::waiver()) {
  ggplot() +
    geom_sf(data = japan, fill = "white", color = "transparent", lwd = coast_lwd) +
    geom_sf(data = biodiv_ferns_spatial, aes(fill = .data[[var_select]]), color = "transparent") +
    geom_sf(data = japan, fill = "transparent", color = coast_col, lwd = coast_lwd) +
    annotate(
      geom="richtext", y = Inf, x = -Inf, 
      label = glue("<span style='color:black'>**{part}** {label}</span>"), 
      hjust = "inward", vjust = "inward", color = "white") + 
    labs(fill = fill_lab) +
    scale_fill_scico(palette = "lajolla", labels = labels) +
    scale_x_continuous(guide = guide_axis(check.overlap = TRUE)) +
    theme_grey(base_size = 10) +
    theme(
      panel.grid.major = element_line(color = "grey60", size = 0.1),
      panel.grid.minor = element_blank(),
      panel.background = element_rect(fill = "transparent"),
      axis.ticks = element_blank(),
      axis.text = element_text(color = "grey60"),
      axis.title = element_blank(),
      legend.position = "right",
      legend.title = element_markdown()
    )
}

a <- plot_env("A", "Area", "lat_area", "km^2")
b <- plot_env("B", "% apomictic taxa", "percent_apo", labels = function(x) scales::percent(x, accuracy = 1))
c <- plot_env("C", "Precipitation", "precip", "mm")
d <- plot_env("D", "Precip. season.", "precip_season" , "")
e <- plot_env("E", "Temperature", "temp", "°C", function(x) x/10)
f <- plot_env("F", "Temp. season.", "temp_season") +
  annotation_scale(location = "tl", width_hint = 0.2, pad_y = unit(0.8, "cm"))

a + b + c + d + e + f + plot_layout(ncol = 2, nrow = 3)
```

**`r s_figure("envir")`**. Reproductive mode and environmental data in 20 km × 20 km grid cells across Japan. (A) rolling mean area (km^2^) in 20 km latitudinal bands. (B) % apomictic taxa. (C) annual precipitation. (D) percipitation seasonality (coefficient of variation). (E) mean annual temperature. (F) temperature seasonality (standard deviation × 100). Data excluded from models not shown in this and subsequent plots unless otherwise mentioned.

\clearpage

```{r tree, fig.width = 8, fig.height = 8}
phy <- japan_pterido_tree

phy$tip.label <- str_replace_all(phy$tip.label, "_", " ")

# Make a dataframe (tibble) with node IDs (integers) and their corresponding bootstrap support values
# The tibble has two columns: one called "node", the other can be named as we like (here, "bootstrap")
bs_tibble <- tibble(
  # hard-code node ID: internal nodes start after tip nodes,
  # and phy$node.label is in the same order as internal nodes
  node=1:Nnode(phy) + Ntip(phy), 
  # Don't print BS < 50%
  # (or to show all BS, just do `bootstrap = phy$node.label`)
  bootstrap_raw = phy$node.label,
  bootstrap = parse_number(bootstrap_raw))

p <- ggtree(phy, layout = "fan", size = 0.25, open.angle = 3) %<+% 
  bs_tibble +
  geom_nodepoint(aes(color = bootstrap), size = 0.2) +
  geom_tiplab(size = 0.6)  +
  theme(legend.justification = c(1, 0), legend.position = c(1, 0)) +
  scale_color_scico(palette = "turku", direction = -1, na.value = "grey", name = "BS") +
  geom_treescale(x = 220, y = 708, width = 100, fontsize = 0)

rotate_tree(p, 3)
```

**`r s_figure("tree")`**. Time tree of native Japanese ferns and lycophytes, excluding hybrids. Points at nodes indicate bootstrap support. Scalebar 100 my. Tree visualized with the `r pack("ggtree")` R package [@Yu2017].

\clearpage

```{r abundance, fig.width = 7, fig.height = 5}
k <- scales::unit_format(unit = "k", scale = 1e-3, accuracy = 1, sep = "")

a <- ggplot() + 
  geom_sf(data = japan, fill = "white", color = "transparent", lwd = coast_lwd) +
  geom_sf(data = biodiv_ferns_spatial, aes(fill = abundance), color = "transparent") +
  geom_sf(data = japan, fill = "transparent", color = coast_col, lwd = coast_lwd) +
  scale_fill_scico(palette = "lajolla", label = k) +
  labs(fill = "No. specimens") +
  annotate(geom="richtext", y = Inf, x = -Inf, label = "<span style='color:black'>**A**</span>", hjust = "inward", vjust = "inward", color = "white") + 
  map_theme()


b <- ggplot() +
  geom_sf(data = japan, fill = "white", color = "transparent", lwd = coast_lwd) +
  geom_sf(data = biodiv_ferns_spatial, aes(fill = redundancy), color = "transparent") +
  geom_sf(data = japan, fill = "transparent", color = coast_col, lwd = coast_lwd) +
  scale_fill_scico(palette = "lajolla") +
  labs(fill = "Redundancy") +
  annotate(geom="richtext", y = Inf, x = -Inf, label = "<span style='color:black'>**B**</span>", hjust = "inward", vjust = "inward", color = "white") +
  annotation_scale(location = "tl", width_hint = 0.2, pad_y = unit(0.8, "cm")) +
  map_theme() +
  theme(
    axis.text.y = element_blank()
  )

a + b + 
  plot_layout(nrow = 1)
```

**`r s_figure("abundance")`**. Observed number of specimens (A) and sampling redundancy (B) per 20 km × 20 km grid cell in the ferns of Japan.

\clearpage

```{r raw-lat, fig.width = 7, fig.height = 4}
# Convert spatial data frame to centroids with raw metrics
biodiv_ferns_cent_raw <-
  biodiv_ferns_spatial %>%
  sf_add_centroids() %>%
  st_drop_geometry()

# Plot each raw metric vs. latitude
a <- ggplot(biodiv_ferns_cent_raw, aes(y = richness, x = lat)) +
  geom_point(alpha = 0.5) +
  geom_smooth() +
  scale_x_continuous(
    name = "Latitude",
    labels = label_number(accuracy = 1, suffix ="\u00b0 N")) +
  labs(y = "Richness") +
  coord_flip() +
  theme(panel.grid.minor = element_blank())

b <- ggplot(biodiv_ferns_cent_raw, aes(y = pd_obs, x = lat)) +
  geom_point(alpha = 0.5) +
  geom_smooth() +
  scale_x_continuous(
    labels = label_number(accuracy = 1, suffix ="\u00b0 N")) +
  labs(y = "PD") +
  coord_flip() +
  theme(
    panel.grid.minor = element_blank(),
    axis.title.y = element_blank())

c <- ggplot(biodiv_ferns_cent_raw, aes(y = fd_obs, x = lat)) +
  geom_point(alpha = 0.5) +
  geom_smooth() +
  scale_x_continuous(
    labels = label_number(accuracy = 1, suffix ="\u00b0 N")) +
  labs(y = "FD") +
  coord_flip() +
  theme(
    panel.grid.minor = element_blank(),
    axis.title.y = element_blank())

a + b + c + 
  plot_layout(nrow = 1) +
  plot_annotation(tag_levels = "A",
                  tag_prefix = "",
                  tag_suffix = "") &
  theme(plot.tag = element_text(face = "bold"))
```

**`r s_figure("raw-lat")`**. (A) Raw taxonomic diversity, (B) phylogenetic diversity, and (C) functional diversity of the ferns of Japan plotted by latitude. For (B) and (C), raw branchlengths were transformed to relative values by dividing each branchlength by the sum of all branchlengths. Trendlines fit with general additive model using `r func("geom_smooth")` function in the `r pack("ggplot2")` R package [@Wickham2016].

\clearpage

```{r raw-biplot, fig.width = 7, fig.height = 7}
a <- ggplot(biodiv_ferns_spatial, aes(x = richness, y = pd_obs)) +
  geom_point(alpha = 0.5) +
  geom_smooth() +
  labs(x = "Richness", y = "PD")

b <- ggplot(biodiv_ferns_spatial, aes(x = richness, y = rpd_obs)) +
  geom_point(alpha = 0.5) +
  labs(x = "Richness", y = "RPD")

c <- ggplot(biodiv_ferns_spatial, aes(x = richness, y = fd_obs)) +
  geom_point(alpha = 0.5) +
  geom_smooth() +
  labs(x = "Richness", y = "FD")

d <- ggplot(biodiv_ferns_spatial, aes(x = richness, y = rfd_obs)) +
  geom_point(alpha = 0.5) +
  labs(x = "Richness", y = "RFD")

a + b + c + d +
  plot_layout(ncol = 2, nrow = 2) +
  plot_annotation(tag_levels = "A",
                  tag_prefix = "",
                  tag_suffix = "") &
  theme(plot.tag = element_text(face = "bold"))
```

**`r s_figure("raw-biplot")`**. Relationships between observed phylogenetic and functional diversity and taxonomic richness in the ferns of Japan. (A) Phylogenetic diversity (PD). (B) Relative phylogenetic diversity (RPD). (C) Functional diversity (FD). (D) Relative functional diversity (RFD). Trendlines in (A, C) fit with general additive model using `r func("geom_smooth")` function in the `r pack("ggplot2")` R package [@Wickham2016].

\clearpage

```{r endemism-restricted, fig.width = 5, fig.height = 5}
ggplot() +
  geom_sf(data = japan, fill = "white", color = "transparent", lwd = coast_lwd) +
  geom_sf(data = biodiv_ferns_endemic_spatial, aes(fill = endem_type), color = "transparent") +
  geom_sf(data = japan, fill = "transparent", color = coast_col, lwd = coast_lwd) +
  scale_fill_manual(
    values = canape_cols,
    na.value = "transparent") +
  annotation_scale(location = "tl", width_hint = 0.2) +
  map_theme() +
  theme(legend.title = element_blank())
```

**`r s_figure("endemism-restricted")`**. Phylogenetic endemism of the ferns of Japan measured using CANAPE (categorical analysis of neo- and paleo-endemism), restricted dataset including only taxa endemic to Japan. 'neo' indicates neodendemic areas (those with an overabundance of short branches); 'paleo' indicates paleoendemic areas (those with an overabundance of long branches); 'mixed' indicates significantly endemic sites that have neither an overabundance of short nor long branches; 'super' indicates highly significantly endemic sites that have neither an overabundance of short nor long branches. For details, see Materials and Methods.

\clearpage

```{r k-plot, fig.width = 7, fig.height = 3}
a <- k_taxonomy$df %>%
  as_tibble() %>%
  mutate(
    optimal_auto = ifelse(k == k_taxonomy$optimal$k, TRUE, FALSE),
    label = ifelse(k == k_taxonomy$optimal$k, glue::glue("k = {k}"), "")
  ) %>%
  ggplot(aes(x = k, y = ev)) +
  geom_path() +
  geom_point(aes(color = optimal_auto), size = 2.5) +
  geom_text(aes(label = label), vjust = 0, nudge_y = 0.02, size = 4) +
  scale_color_manual(values = c("TRUE" = "#E31A1C", "FALSE" = "black")) +
  scale_y_continuous(expand = expansion(add = c(0.025,0.05))) +
  scale_x_continuous(breaks = c(2,4,6,8,10)) +
  labs(
    y = "Explained variance",
    x = "Number of clusters") +
  theme(
    legend.position = "none",
    panel.grid.minor = element_blank()
  )

k_phylogeny_select <- 8

b <- k_phylogeny$df %>%
  as_tibble() %>%
  mutate(
    optimal_auto = ifelse(k == k_phylogeny$optimal$k, TRUE, FALSE),
    label = ifelse(k == k_phylogeny$optimal$k, glue::glue("k = {k}"), "")
  ) %>%
  ggplot(aes(x = k, y = ev)) +
  geom_path() +
  geom_point(aes(color = optimal_auto), size = 2.5) +
  geom_text(aes(label = label), vjust = 0, nudge_y = 0.02, size = 4) +
  scale_color_manual(values = c("TRUE" = "#E31A1C", "FALSE" = "black")) +
  scale_y_continuous(expand = expansion(add = c(0.025,0.05))) +
  scale_x_continuous(breaks = c(2,4,6,8,10)) +
  labs(
    y = "Explained variance",
    x = "Number of clusters") +
  theme(
    legend.position = "none",
    panel.grid.minor = element_blank()
  )

a + b +
  plot_layout(ncol = 2) +
  plot_annotation(tag_levels = "A",
                  tag_prefix = "",
                  tag_suffix = "") &
  theme(plot.tag = element_text(face = "bold"))
```

**`r s_figure("k-plot")`**. Selection of *k* for bioregions. (A) taxonomic bioregions. (B) phylogenetic bioregions. Color indicates optimal *k* selected selected by the `r func("optimal_phyloregion")` function in the R package `r pack("phyloregion")` (black, non-optimal; red, optimal).

\clearpage

```{r dendrogram-a, fig.width = 7, fig.height = 9}
# Extract dendrogram from phyloregions analysis, convert to phylogeny
dendro_tax <- attributes(k_taxonomy$df)$meta$hclust.obj %>% as.phylo() %>% ladderize()

# Map taxonomic clusters to grid cells. Include original ("old") clusters
# so that grouping of "other" works correctly even if not monophyletic
clusters_tax <-
bioregions_all_labels %>%
  # Filter to grid-cells used in modeling
  inner_join(
    select(biodiv_ferns_spatial, grids),
    by = "grids"
  ) %>%
  add_count(old_taxonomic_cluster) %>%
  mutate(
    taxonomic_cluster = case_when(
      n <= bioregion_cutoff ~ paste(taxonomic_cluster, old_taxonomic_cluster, sep = "_"),
      TRUE ~ taxonomic_cluster
      )
  ) %>%
  select(-n) %>%
  select(grids, cluster = taxonomic_cluster) %>%
  arrange(grids)

cluster_nodes_tax_tbl <- map_df(unique(clusters_tax$cluster), ~map_cluster_to_nodes(dendro_tax, clusters_tax, .)) %>%
  # Lump regions with fewer grid-cells than cutoff
  mutate(cluster = as.factor(cluster) %>% fct_lump_min(bioregion_cutoff + 1))

# Use the ggtree::`%<+%` operator to map the bootstrap values onto the ggtree object
ggtree(dendro_tax, size = 0.15) %<+% 
  cluster_nodes_tax_tbl +
  aes(color = cluster) +
  scale_color_manual(
    values = bioregion_cols[c(1,2,3,4,"Other")], breaks = c(1,2,3,4,"Other"), name = "Cluster", na.value = "grey10") +
  theme(legend.position = "right") +
  labs(subtitle = "**A** Taxonomic") +
  theme(plot.subtitle = element_markdown())
```

**`r s_figure("dendrogram")`**. Bioregion dendrograms. Tips are sites (names not shown). Dendrograms generated by clustering taxonomic (Sørensen) or phylogenetic (PhyloSor) distances between sites (see Materials and Methods). Color shows bioregion; bioregions not consisting of more than `r english2(bioregion_cutoff)` grid-cells each are lumped into the "Other" category. (A) taxonomic bioregions. (B) phylogenetic bioregions. Dendrograms visualized with the `r pack("ggtree")` R package [@Yu2017].
\clearpage

```{r dendrogram-b, fig.width = 7, fig.height = 9}
# Extract dendrogram from phyloregions analysis, convert to phylogeny
dendro_phy <- attributes(k_phylogeny$df)$meta$hclust.obj %>% as.phylo() %>% ladderize()

# Map phylogenetic clusters to grid cells. Include original ("old") clusters
# so that grouping of "other" works correctly even if not monophyletic
clusters_phy <-
bioregions_all_labels %>%
  # Filter to grid-cells used in modeling
  inner_join(
    select(biodiv_ferns_spatial, grids),
    by = "grids"
  ) %>%
  add_count(old_phylo_cluster) %>%
  mutate(
    phylo_cluster = case_when(
      n <= bioregion_cutoff ~ paste(phylo_cluster, old_phylo_cluster, sep = "_"),
      TRUE ~ phylo_cluster
      )
  ) %>%
  select(-n) %>%
  select(grids, cluster = phylo_cluster) %>%
  arrange(grids)

cluster_nodes_phy_tbl <- map_df(unique(clusters_phy$cluster), ~map_cluster_to_nodes(dendro_phy, clusters_phy, .)) %>%
  # Lump regions with fewer grid-cells than cutoff
  mutate(cluster = as.factor(cluster) %>% fct_lump_min(bioregion_cutoff + 1))

# Use the ggtree::`%<+%` operator to map the bootstrap values onto the ggtree object
ggtree(dendro_phy, size = 0.15) %<+% 
  cluster_nodes_phy_tbl +
  aes(color = cluster) +
  scale_color_manual(
    values = bioregion_cols[c(1,2,3,4,"Other")], breaks = c(1,2,3,4,"Other"), name = "Cluster", na.value = "grey10") +
  theme(legend.position = "right") +
  labs(subtitle = "**B** Phylogenetic") +
  theme(plot.subtitle = element_markdown())
```

**`r s_figure("dendrogram")`**, continued.

\clearpage

```{r genus-map, fig.width = 7, fig.height = 9}
# Define function for plotting genus-level abundance.
# assumes `comm_ferns`, `japan` are in environment
plot_genus <- function(part, genus_select) {
  
  genus_abun <-
    comm_ferns %>%
    rownames_to_column("grids") %>%
    as_tibble() %>%
    pivot_longer(-grids, names_to = "species", values_to = "abun") %>%
    filter(str_detect(species, genus_select)) %>%
    group_by(grids) %>%
    summarize(richness = sum(abun), .groups = "drop") %>%
    left_join(select(biodiv_ferns_spatial, -richness), ., by = "grids")
  
  ggplot() +
    geom_sf(data = japan, fill = "white", color = "transparent", lwd = coast_lwd) +
    geom_sf(data = genus_abun, aes(fill = richness), color = "transparent") +
    geom_sf(data = japan, fill = "transparent", color = coast_col, lwd = coast_lwd) +
    annotate(
      geom="richtext", y = Inf, x = -Inf, 
      label = glue("<span style='color:black'>**{part}** *{genus_select}*</span>"), 
      hjust = "inward", vjust = "inward", color = "white") + 
    labs(fill = "Richness") +
    scale_fill_scico(palette = "lajolla") +
    scale_x_continuous(guide = guide_axis(check.overlap = TRUE)) +
    theme_grey(base_size = 10) +
    theme(
      panel.grid.major = element_line(color = "grey60", size = 0.1),
      panel.grid.minor = element_blank(),
      panel.background = element_rect(fill = "transparent"),
      axis.ticks = element_blank(),
      axis.text = element_text(color = "grey60"),
      axis.title = element_blank(),
      legend.position = "right",
      legend.title = element_markdown()
    )
}

a <- plot_genus("A", "Equisetum")
b <- plot_genus("B", "Deparia")
c <- plot_genus("C", "Cyrtomium")
d <- plot_genus("D", "Dryopteris")
e <- plot_genus("E", "Pteris")
f <- plot_genus("F", "Diplazium") +
  annotation_scale(location = "tl", width_hint = 0.2, pad_y = unit(0.8, "cm"))

a + b + c + d + e + f + plot_layout(ncol = 2, nrow = 3)
```

**`r s_figure("genus-map")`**. Map of species richness for selected genera of ferns of Japan. (A) *Equisetum* is an example of a possible refugial lineage with greater species richness in northern Japan. (B) *Deparia* is an example of a genus with possible recent radiation in southern Honshu. (C)--(F) show genera with high rates of apomictic taxa (`r s_figure("apo-genus")`), which tend to be greatest in southern Honshu.

\clearpage

```{r apo-genus, fig.width = 4, fig.height = 3}
# Bar plot of % apo taxa by genus
percent_apo_genus <-
  repro_data %>%
  # Remove NA values, non-ferns
  filter(!is.na(apomict)) %>%
  filter(str_detect(taxon, "Lycopodiella|Lycopodium|Isoetes", negate = TRUE)) %>%
  # Summarize percent apo by genus
  mutate(genus = str_split(taxon, "_") %>% map_chr(1)) %>%
  group_by(genus) %>%
  add_count() %>%
  group_by(genus, n) %>%
  summarize(total_apo = sum(apomict), .groups = "drop") %>%
  mutate(percent_apo = total_apo / n) %>%
  arrange(desc(percent_apo))

percent_apo_genus %>%
  filter(total_apo > 1) %>%
  group_by(genus) %>%
  summarize(
    n = mean(n),
    total_apo = mean(total_apo),
    percent_apo = mean(percent_apo),
    .groups = "drop"
  ) %>%
  mutate(
    genus =  paste0("*", genus, "*"),
    genus = fct_reorder(genus, percent_apo),
    label = glue::glue("{total_apo}/{n}")) %>%
  ggplot(aes(x = percent_apo, y = genus)) + 
  geom_col() +
  geom_text(aes(label = label), hjust = -.3) +
  scale_x_continuous(labels = percent, limits = c(0, .85)) +
  labs(x = "% apomictic taxa") +
  theme(
    axis.text.y = element_markdown(),
    axis.title.y = element_blank()
  )
```

**`r s_figure("apo-genus")`**. Rate of apomixis in genera of native, non-hybrid Japanese ferns with > 1 apomictic taxon. Numbers next to each bar show number of apomictic taxa out of total richness per genus.

\clearpage

```{r modelfit-not-ult, fig.width = 7, fig.height = 3}
# Extract dataset used for model, including significance columns
biodiv_ferns_used_for_model <- biodiv_ferns_spatial %>%
  # drop geometry (only need centroids for modeling)
  st_set_geometry(NULL) %>%
  as_tibble() %>%
  # filter to only sites used in model
  inner_join(
    biodiv_ferns_cent %>% as_tibble() %>% select(grids),
    by = "grids"
  )

# Generate final plot
modelfit_plot_list <- 
  model_fits_not_ult %>%
  mutate(
    signif_var = str_replace_all(resp_var, "_obs_z", "_signif"),
    resp_var_print = case_when(
      resp_var == "richness" ~ "Richness (no. spp.)",
      TRUE ~ str_to_upper(resp_var) %>% word(1, 1, "_") %>% paste("SES of", .)
    ),
    model_data = list(biodiv_ferns_used_for_model),
    signif_cols = list(signif_cols)) %>%
  left_join(model_subplot_order, by = c("resp_var", "indep_var")) %>%
  arrange(order) %>%
  pmap(plot_fits)

# Need one subplot with a legend
modelfit_plot_list[[2]] <- modelfit_plot_list[[2]] +
  theme(legend.position = "right") +
  labs(color = "Significance") +
  # Increase size of points in legend
  guides(colour = guide_legend(override.aes = list(size = 1.5)))

wrap_plots(modelfit_plot_list) +
  guide_area() +
  plot_layout(guides = "collect") +
  plot_annotation(tag_levels = "A",
                  tag_prefix = "",
                  tag_suffix = "") &
  theme(plot.tag = element_text(face = "bold"))
```

**`r s_figure("modelfit-not-ult")`**. Relationship between (A) phylogenetic diversity (PD) and (B) relative PD and % apomictic taxa, models inferred using phylogeny with branchlengths in units of expected genetic change (untransformed ML tree). Ribbon shows 95% confidence interval of model. Line fit with the focal predictor variable while averaging over other predictors. For RPD, the standard effect size (SES) was calculated by comparing raw values to a null distribution of 999 random values, and significance (*P*-value) calculated using a two-tailed test (see Materials and Methods).

\clearpage

```{r bioregions-env, fig.width = 7, fig.height = 5}
# Make pot showing bioregions by temperature and precipitation
a <-
  ggplot(biodiv_ferns_spatial_lumped, aes(x = precip, y = temp, color = taxonomic_cluster)) +
  geom_point(size = 1, alpha = 0.7) +
  scale_color_manual(
    values = bioregion_cols,
    guide = guide_legend(
      direction = "horizontal",
      title.position = "top",
      label.position = "left")
  ) +
  scale_y_continuous(labels = function(x) x/10) +
  labs(y = "Temperature (°C)", x = "Precipitation (mm)", color = "Bioregion", subtitle = "Taxonomic bioregions") +
  theme(legend.position = "bottom")

b <-
  ggplot(biodiv_ferns_spatial_lumped, aes(x = precip, y = temp, color = phylo_cluster)) +
  geom_point(size = 1, alpha = 0.7) +
  scale_color_manual(
    values = bioregion_cols,
    guide = guide_legend(
      direction = "horizontal",
      title.position = "top",
      label.position = "left")) +
  scale_y_continuous(labels = function(x) x/10) +
  labs(y = "Temperature (°C)", x = "Precipitation (mm)", color = "Bioregion", subtitle = "Phylogenetic bioregions") +
  theme(legend.position = "bottom")

a + b + plot_annotation(tag_levels = "A",
                        tag_prefix = "",
                        tag_suffix = "") &
  theme(plot.tag = element_text(face = "bold"))
```

**`r s_figure("bioregions-env")`**. Scatterplots of grid cell membership in (A) taxonomic or (B) phylogenetic bioregions arranged by mean annual temperature and annual precipitation. Points shown with partial transparency; darker areas indicate overlapping points. Bioregions not consisting of more than `r english2(bioregion_cutoff)` grid-cells each are lumped into the "Other" category.

\clearpage

```{r protected-map, fig.width = 7, fig.height = 9}
# Define function to make maps showing overlap of protected areas and grid-cells with high biodiversity
# These depend on various objects being in the current environment!
# pass the dots to filter data
make_protected_plot <- function(part, variable, ...) {
  ggplot() +
    geom_sf(data = japan, lwd = 0.07, fill = "white") +
    geom_sf(data = protected_areas %>% mutate(status = str_to_sentence(status)), aes(fill = status), color = "transparent") +
    geom_sf(
      data = biodiv_ferns_spatial %>% filter(...), 
      fill = "transparent", color = "black", lwd = 0.12) +
    annotate(
      geom="richtext", y = Inf, x = -Inf, 
      label = glue("<span style='color:black'>**{part}** {variable}</span>"), 
      hjust = "inward", vjust = "inward", color = "white") +
    scale_fill_manual(values = protection_cols, name = "Protection status") +
    scale_x_continuous(breaks = c(125, 135, 145)) +
    scale_y_continuous(breaks = c(25, 35, 45)) +
    map_theme()
}

a <- make_protected_plot("A", "Richness", richness_obs_p_upper > 0.95)
b <- make_protected_plot("B", "PD", pd_obs_p_upper > 0.95)
c <- make_protected_plot("C", "FD", fd_obs_p_upper > 0.95)
d <- make_protected_plot("D", "PE", pe_obs_p_upper > 0.95) +
  annotation_scale(location = "tl", width_hint = 0.2, pad_y = unit(0.8, "cm"))

a + b + c + d + plot_layout(ncol = 2, nrow = 2) +
    plot_layout(guides = "collect") &
  theme(legend.position = "bottom")
```

**`r s_figure("protected-map")`**. Maps showing overlap of grid-cells with significantly high biodiversity for the ferns of Japan and protected areas. Grid-cells with black outlines indicate significantly high biodiversity. Biodiversity metrics include (A) taxon richness, (B) phylogenetic diversity (PD), (C) functional diversity (FD), and (D) phylogenetic endemism (PE). Significance of PD, FD, and PE assessed by a one-tailed test comparing observed values to a null distribution of 999 random values; for richness, grid-cells in the top 5% considered highly diverse (see Materials and Methods).

\clearpage

```{r deer-map, fig.width = 7, fig.height = 9}
# Define function to make maps showing overlap of areas with deer and grid-cells with high biodiversity
# These depend on various objects being in the current environment!
make_deer_plot <- function(part, variable, ...) {
  ggplot() +
    geom_sf(data = japan, lwd = 0.07, fill = "white") +
    geom_sf(data = deer_range %>% filter(range == "estimated") %>% mutate(range = str_to_sentence(range)), aes(fill = range), color = "transparent") +
    geom_sf(data = deer_range %>% filter(range == "2003"), aes(fill = range), color = "transparent") +
    geom_sf(data = deer_range %>% filter(range == "1978"), aes(fill = range), color = "transparent") +
    geom_sf(
      data = biodiv_ferns_spatial %>% filter(...), 
      fill = "transparent", color = "black", lwd = 0.12) +
    annotate(
      geom="richtext", y = Inf, x = -Inf, 
      label = glue("<span style='color:black'>**{part}** {variable}</span>"), 
      hjust = "inward", vjust = "inward", color = "white") +
    scale_fill_manual(values = deer_cols, name = "Range data source") +
    scale_x_continuous(breaks = c(125, 135, 145)) +
    scale_y_continuous(breaks = c(25, 35, 45)) +
    map_theme()
}

a <- make_deer_plot("A", "Richness", richness_obs_p_upper > 0.95)
b <- make_deer_plot("B", "PD", pd_obs_p_upper > 0.95)
c <- make_deer_plot("C", "FD", fd_obs_p_upper > 0.95)
d <- make_deer_plot("D", "PE", pe_obs_p_upper > 0.95) +
  annotation_scale(location = "tl", width_hint = 0.2, pad_y = unit(0.8, "cm"))

a + b + c + d + plot_layout(ncol = 2, nrow = 2) +
    plot_layout(guides = "collect") &
  theme(legend.position = "bottom")
```

**`r s_figure("deer-map")`**. Maps showing overlap of grid-cells with significantly high biodiversity for the ferns of Japan and distribution of Japanese deer (*Cervus nippon*). Grid-cells with black outlines indicate significantly high biodiversity. Biodiversity metrics include (A) taxon richness, (B) phylogenetic diversity (PD), (C) functional diversity (FD), and (D) phylogenetic endemism (PE). Significance of PD, FD, and PE assessed by a one-tailed test comparing observed values to a null distribution of 999 random values; for richness, grid-cells in the top 5% considered highly diverse (see Materials and Methods). Deer range data sources include 1978 survey, 2003 survey, and range estimated from model based on 2003 survey data. Deer ranges plotted in layers in ascending order (estimated, 2003, 1978) such that upper layers may obscure lower layers; however, deer ranges generally expanded from 1978 to estimated range, so very few sites are obscured.

\clearpage

## References